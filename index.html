<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LMS AI Assistant Pro</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 50px auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            text-align: center;
        }
        h1 {
            color: #333;
            margin-bottom: 10px;
        }
        .subtitle {
            color: #666;
            margin-bottom: 30px;
        }
        input {
            padding: 15px;
            width: 300px;
            border: 2px solid #ddd;
            border-radius: 8px;
            margin: 10px;
            font-size: 16px;
        }
        input:focus {
            border-color: #667eea;
            outline: none;
        }
        button {
            padding: 15px 30px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: transform 0.2s;
        }
        button:hover {
            transform: translateY(-2px);
        }
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        .status {
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
            font-weight: bold;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info {
            margin-top: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }
        .hidden {
            display: none;
        }
        .download-section {
            margin-top: 20px;
            padding: 20px;
            background: #e8f5e8;
            border-radius: 8px;
        }
        .loading {
            color: #666;
            font-style: italic;
        }
    </style>
    <!-- EmailJS for notifications -->
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
</head>
<body>
    <div class="container">
        <h1>🚀 LMS AI Assistant Pro</h1>
        <p class="subtitle">Enhanced Learning Management System Assistant</p>
        
        <div id="keySection">
            <p>Enter your product key to download the script:</p>
            <input type="text" id="productKey" placeholder="Enter your product key" maxlength="50">
            <br>
            <button onclick="validateAndDownload()" id="validateBtn">Validate Key</button>
            
            <div id="status" class="status hidden"></div>
        </div>
        
        <div id="downloadSection" class="download-section hidden">
            <h3>✅ Key Validated Successfully!</h3>
            <p>Welcome, <span id="userName"></span>!</p>
            <p>License valid until: <span id="expiry"></span></p>
            <button onclick="downloadScript()" id="downloadBtn">📥 Download Your Script</button>
        </div>
        
        <div class="info">
            <h3>📚 Installation Instructions:</h3>
            <p><strong>Step 1:</strong> Install ScriptCat or GreaseMonkey browser extension</p>
            <p><strong>Step 2:</strong> Enter your product key above</p>
            <p><strong>Step 3:</strong> Download your personalized script</p>
            <p><strong>Step 4:</strong> Install the script in your browser extension</p>
            <p><strong>Step 5:</strong> Visit your LMS and enjoy enhanced functionality!</p>
            
            <hr style="margin: 20px 0;">
            <p><strong>🔧 Support:</strong> Contact your script provider for help</p>
            <p><strong>🔄 Updates:</strong> Re-download from this page for latest version</p>
        </div>
    </div>

    <script>
        // ===== ENCRYPTION FUNCTIONS =====
        function simpleEncrypt(text, key) {
            try {
                const utf8Text = unescape(encodeURIComponent(text));
                let result = '';
                
                for (let i = 0; i < utf8Text.length; i++) {
                    const charCode = utf8Text.charCodeAt(i);
                    const keyChar = key.charCodeAt(i % key.length);
                    const encrypted = charCode ^ keyChar;
                    result += String.fromCharCode(encrypted);
                }
                
                return btoa(result);
            } catch (e) {
                console.error('Encryption error:', e);
                return btoa(text.replace(/[^\x00-\x7F]/g, "?"));
            }
        }

        function simpleDecrypt(encryptedText, key) {
            try {
                const decoded = atob(encryptedText);
                let result = '';
                
                for (let i = 0; i < decoded.length; i++) {
                    const charCode = decoded.charCodeAt(i);
                    const keyChar = key.charCodeAt(i % key.length);
                    const decrypted = charCode ^ keyChar;
                    result += String.fromCharCode(decrypted);
                }
                
                return decodeURIComponent(escape(result));
            } catch (e) {
                console.error('Decryption error:', e);
                return null;
            }
        }
// ===== DATABASE-POWERED KEY VALIDATION =====
        async function validateProductKey(key) {
            try {
                console.log('[LMS AI] Validating key with database:', key);
                
                // Try database first
                const response = await fetch('/.netlify/functions/validate-key', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ keyCode: key })
                });

                if (response.ok) {
                    const result = await response.json();
                    console.log('[LMS AI] Database validation result:', result);
                    return result;
                }
                
                throw new Error('Database unavailable');

            } catch (error) {
                console.warn('[LMS AI] Database validation failed, using fallback:', error);
                
                // Fallback to hardcoded keys
                return validateKeyFallback(key);
            }
        }

        // Fallback validation for when database is unavailable
        function validateKeyFallback(key) {
            const fallbackKeys = {
                "DEMO-2025-TEST": {
                    name: "Demo User",
                    expiry: "2025-12-31",
                    active: true,
                    encryptionKey: "demo-secret-key-2025"
                },
                "ADMIN-2025-MASTER": {
                    name: "Administrator", 
                    expiry: "2099-12-31",
                    active: true,
                    encryptionKey: "admin-master-key-2025"
                },
                "JOHN-2025-ABC123": {
                    name: "John Smith",
                    expiry: "2025-12-31",
                    active: true,
                    encryptionKey: "john-secret-key-2025"
                }
            };

            if (!key || key.trim() === '') {
                return { valid: false, message: "Please enter a product key" };
            }
            
            const keyData = fallbackKeys[key.toUpperCase()];
            
            if (!keyData) {
                return { valid: false, message: "Invalid product key. Please check your key and try again." };
            }
            
            if (!keyData.active) {
                return { valid: false, message: "This key has been deactivated. Please contact support." };
            }
            
            const today = new Date();
            const expiryDate = new Date(keyData.expiry);
            
            if (today > expiryDate) {
                return { valid: false, message: "This key has expired. Please renew your license." };
            }
            
            return { 
                valid: true, 
                message: "Valid key! Preparing your personalized script...", 
                userData: keyData 
            };
        }

        // ===== SCRIPT FILE LOADING =====
        async function loadMasterScript() {
            try {
                console.log('Loading master script from lms-ai-script.js...');
                const response = await fetch('./lms-ai-script.js');
                
                if (!response.ok) {
                    throw new Error(`Failed to fetch script: ${response.status} ${response.statusText}`);
                }
                
                const scriptContent = await response.text();
                console.log('Master script loaded successfully, length:', scriptContent.length);
                return scriptContent;
            } catch (error) {
                console.error('Failed to load master script:', error);
                return `
// Demo script fallback - real script file not found
console.log('[LMS AI] Demo script loaded (fallback)');
alert('LMS AI Assistant Pro Demo Mode\\nReal script file not found at ./lms-ai-script.js');
                `;
            }
        }

        // ===== USAGE TRACKING =====
        function logKeyUsage(key, action) {
            const timestamp = new Date().toISOString();
            console.log(`[${timestamp}] Key: ${key}, Action: ${action}`);
        }

        // ===== MAIN APPLICATION =====
        let currentUserData = null;
        
        async function validateAndDownload() {
            const keyInput = document.getElementById('productKey');
            const statusDiv = document.getElementById('status');
            const validateBtn = document.getElementById('validateBtn');
            const downloadSection = document.getElementById('downloadSection');
            
            const key = keyInput.value.trim();
            
            validateBtn.disabled = true;
            validateBtn.textContent = 'Validating...';
            
            try {
                const result = await validateProductKey(key);
                
                statusDiv.classList.remove('hidden', 'success', 'error');
                
                if (result.valid) {
                    statusDiv.classList.add('success');
                    statusDiv.textContent = result.message;
                    
                    currentUserData = result.userData;
                    document.getElementById('userName').textContent = result.userData.name;
                    document.getElementById('expiry').textContent = result.userData.expiry;
                    downloadSection.classList.remove('hidden');
                    
                    // 📧 Send validation notification
                    sendValidationNotification(result.userData, 'Key Validation');
                    
                } else {
                    statusDiv.classList.add('error');
                    statusDiv.textContent = result.message;
                    downloadSection.classList.add('hidden');
                    
                    // 📧 Send invalid key attempt notification
                    sendValidationNotification({ name: 'Unknown' }, 'Invalid Key Attempt');
                }
                
            } catch (error) {
                statusDiv.classList.remove('hidden', 'success');
                statusDiv.classList.add('error');
                statusDiv.textContent = 'Validation failed. Please try again.';
                
                // 📧 Send error notification
                sendValidationNotification({ name: 'Error' }, 'Validation Error');
            } finally {
                validateBtn.disabled = false;
                validateBtn.textContent = 'Validate Key';
            }
        }
        
      async function downloadScript() {
            if (!currentUserData) {
                alert('Please validate your key first!');
                return;
            }
            
            const downloadBtn = document.getElementById('downloadBtn');
            downloadBtn.disabled = true;
            downloadBtn.textContent = '📥 Generating Script...';
            
            try {
                // Load the master script or use demo
                let masterScript;
                try {
                    const response = await fetch('./lms-ai-script.js');
                    if (response.ok) {
                        masterScript = await response.text();
                    } else {
                        throw new Error('Master script not found');
                    }
                } catch (error) {
                    console.warn('Using demo script:', error);
                    masterScript = generateDemoScript();
                }
                
                downloadBtn.textContent = '📥 Preparing Download...';
                
                setTimeout(() => {
                    const scriptContent = generatePersonalizedScript(currentUserData, masterScript);
                    const blob = new Blob([scriptContent], { type: 'application/javascript' });
                    const url = URL.createObjectURL(blob);
                    
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `lms-ai-assistant-${currentUserData.name.replace(/\s+/g, '-').toLowerCase()}.user.js`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    
                    downloadBtn.textContent = '✅ Download Complete!';
                    
                    // 📧 Send download notification
                    sendValidationNotification(currentUserData, 'Script Download');
                    
                    // Show success message
                    setTimeout(() => {
                        showDownloadSuccessMessage();
                    }, 1000);
                    
                    setTimeout(() => {
                        downloadBtn.disabled = false;
                        downloadBtn.textContent = '📥 Download Your Script';
                    }, 3000);
                    
                }, 1000);
                
            } catch (error) {
                console.error('Download failed:', error);
                downloadBtn.disabled = false;
                downloadBtn.textContent = '❌ Download Failed';
                alert('Failed to generate script. Please try again.');
                
                setTimeout(() => {
                    downloadBtn.textContent = '📥 Download Your Script';
                }, 3000);
            }
        }

        function generateDemoScript() {
            return `// Demo LMS AI Assistant Script
console.log('LMS AI Assistant Demo Mode');
alert('LMS AI Assistant loaded successfully!');
// Add your actual script functionality here`;
        }

        function showDownloadSuccessMessage() {
            const successDiv = document.createElement('div');
            successDiv.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: linear-gradient(135deg, #27ae60, #2ecc71);
                color: white;
                padding: 30px;
                border-radius: 15px;
                box-shadow: 0 10px 30px rgba(39, 174, 96, 0.3);
                z-index: 100000;
                text-align: center;
                font-family: Arial, sans-serif;
                max-width: 400px;
            `;
            
            successDiv.innerHTML = `
                <h3 style="margin: 0 0 15px 0;">🎉 Download Successful!</h3>
                <p style="margin: 0 0 10px 0;">Your personalized LMS AI script is ready!</p>
                <p style="margin: 0 0 20px 0; font-size: 14px; opacity: 0.9;">
                    Licensed to: ${currentUserData.name}<br>
                    Valid until: ${currentUserData.expiry}
                </p>
                <div style="font-size: 12px; opacity: 0.8; border-top: 1px solid rgba(255,255,255,0.3); padding-top: 15px;">
                    <strong>Next Steps:</strong><br>
                    1. Install in ScriptCat/GreaseMonkey<br>
                    2. Visit your LMS to activate<br>
                    3. Enjoy enhanced functionality!
                </div>
            `;
            
            document.body.appendChild(successDiv);
            
            setTimeout(() => {
                successDiv.style.opacity = '0';
                successDiv.style.transform = 'translate(-50%, -50%) scale(0.9)';
                setTimeout(() => {
                    if (successDiv.parentNode) {
                        successDiv.parentNode.removeChild(successDiv);
                    }
                }, 300);
            }, 5000);
        }
function generatePersonalizedScript(userData, masterScript) {
            console.log('🔐 Generating hybrid security script for:', userData.name);
            
            const currentDate = new Date();
            const expiryDate = new Date(userData.expiry);
            
            // Get the current license key being validated
            const currentKey = document.getElementById('productKey').value.trim();
            
            // Generate authorized domains based on common LMS patterns
            const authorizedDomains = [
                'canvas', 'blackboard', 'moodle', 'brightspace', 'schoology', 
                'edmodo', 'google.classroom', 'teams.microsoft', 'learn',
                'lms', 'elearning', 'education', 'university', 'college', 'school'
            ];
            
            // Create the actual LMS AI code with signature for validation
            const actualLMSCode = `
// ===== LMS AI ASSISTANT CORE =====
const LMS_AI_SIGNATURE = 'LMS_AI_AUTHENTICATED_${Date.now()}';
console.log('🚀 LMS AI Assistant v2.0 - Licensed to: ${userData.name}');

// Your actual LMS AI functionality here
(function() {
    'use strict';
    
    // LMS AI Core Functions
    function initializeLMSAI() {
        console.log('✅ LMS AI Assistant initialized for ${userData.name}');
        console.log('📅 License valid until: ${userData.expiry}');
        
        // Add your LMS enhancement features here
        addGradeCalculator();
        addQuickSubmit();
        addStudentTracker();
        addAutoSave();
        
        // Success notification
        showLMSAIWelcome();
    }
    
    function addGradeCalculator() {
        const calculator = document.createElement('div');
        calculator.id = 'lms-ai-calculator';
        calculator.innerHTML = \`
            <div style="position: fixed; top: 10px; right: 10px; background: #2c3e50; color: white; padding: 15px; border-radius: 10px; z-index: 10000; box-shadow: 0 5px 15px rgba(0,0,0,0.3);">
                <h4 style="margin: 0 0 10px 0;">📊 LMS AI Calculator</h4>
                <p style="margin: 0; font-size: 12px;">Grade calculation and analysis tools active</p>
                <p style="margin: 5px 0 0 0; font-size: 11px; opacity: 0.8;">Licensed to: ${userData.name}</p>
            </div>
        \`;
        document.body.appendChild(calculator);
        
        // Hide after 5 seconds
        setTimeout(() => {
            if (calculator.parentNode) {
                calculator.parentNode.removeChild(calculator);
            }
        }, 5000);
    }
    
    function addQuickSubmit() {
        // Add quick submit functionality
        console.log('🚀 Quick Submit features loaded');
        
        // Find all submit buttons and enhance them
        const submitButtons = document.querySelectorAll('input[type="submit"], button[type="submit"]');
        submitButtons.forEach(button => {
            button.addEventListener('click', function(e) {
                console.log('📝 LMS AI: Enhanced submit triggered');
                // Add your submit enhancements here
            });
        });
    }
    
    function addStudentTracker() {
        // Add student progress tracking
        console.log('📈 Student Tracker features loaded');
        
        // Example: Track time spent on page
        let startTime = Date.now();
        window.addEventListener('beforeunload', function() {
            const timeSpent = Math.floor((Date.now() - startTime) / 1000);
            console.log('📊 Time spent on page:', timeSpent, 'seconds');
            localStorage.setItem('lms_ai_session_time', timeSpent);
        });
    }
    
    function addAutoSave() {
        // Add auto-save functionality
        console.log('💾 Auto-Save features loaded');
        
        // Auto-save form data every 30 seconds
        setInterval(() => {
            const forms = document.querySelectorAll('form');
            forms.forEach((form, index) => {
                const formData = new FormData(form);
                const savedData = {};
                for (let [key, value] of formData.entries()) {
                    if (value && value.length > 0) {
                        savedData[key] = value;
                    }
                }
                if (Object.keys(savedData).length > 0) {
                    localStorage.setItem('lms_ai_autosave_' + index, JSON.stringify(savedData));
                    console.log('💾 Auto-saved form data');
                }
            });
        }, 30000);
        
        // Restore saved data on page load
        setTimeout(() => {
            const forms = document.querySelectorAll('form');
            forms.forEach((form, index) => {
                const savedData = localStorage.getItem('lms_ai_autosave_' + index);
                if (savedData) {
                    try {
                        const data = JSON.parse(savedData);
                        Object.keys(data).forEach(key => {
                            const input = form.querySelector('[name="' + key + '"]');
                            if (input && !input.value) {
                                input.value = data[key];
                                input.style.background = '#fff3cd'; // Highlight restored data
                                setTimeout(() => {
                                    input.style.background = '';
                                }, 2000);
                            }
                        });
                        console.log('🔄 Restored auto-saved form data');
                    } catch (e) {
                        console.warn('Failed to restore saved data');
                    }
                }
            });
        }, 1000);
    }
    
    function showLMSAIWelcome() {
        const welcome = document.createElement('div');
        welcome.style.cssText = \`
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #2c3e50, #3498db); color: white;
            padding: 30px; border-radius: 15px; z-index: 100000;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3); text-align: center;
            font-family: Arial, sans-serif; max-width: 400px;
        \`;
        
        welcome.innerHTML = \`
            <h3 style="margin: 0 0 15px 0;">🚀 LMS AI Assistant Active!</h3>
            <p style="margin: 0 0 10px 0;">Welcome back, ${userData.name}!</p>
            <p style="margin: 0 0 15px 0; font-size: 14px; opacity: 0.9;">
                License: ${userData.type || 'STANDARD'}<br>
                Valid until: ${userData.expiry}
            </p>
            <div style="font-size: 12px; opacity: 0.8; border-top: 1px solid rgba(255,255,255,0.3); padding-top: 15px;">
                <strong>Features Loaded:</strong><br>
                ✅ Grade Calculator &nbsp; ✅ Quick Submit<br>
                ✅ Student Tracker &nbsp; ✅ Auto-Save
            </div>
        \`;
        
        document.body.appendChild(welcome);
        
        setTimeout(() => {
            welcome.style.opacity = '0';
            welcome.style.transform = 'translate(-50%, -50%) scale(0.9)';
            welcome.style.transition = 'all 0.3s';
            setTimeout(() => {
                if (welcome.parentNode) {
                    welcome.parentNode.removeChild(welcome);
                }
            }, 300);
        }, 4000);
    }
    
    // Initialize LMS AI
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initializeLMSAI);
    } else {
        initializeLMSAI();
    }
})();

// ===== END LMS AI CORE =====
`;

            // Generate complex encryption key
            const encryptionKey = generateComplexEncryptionKey(userData, currentKey);
            
            // Encrypt the actual LMS AI code
            let encryptedPayload;
            try {
                // Use CryptoJS if available
                encryptedPayload = CryptoJS.AES.encrypt(actualLMSCode, encryptionKey).toString();
            } catch (error) {
                // Fallback to safe encoding
encryptedPayload = 'FALLBACK_' + encryptionKey + '_' + Date.now();
            }
            
            // Generate the complete hybrid security script
            const hybridScript = `// ==UserScript==
// @name         LMS AI Assistant Pro - ${userData.name}
// @namespace    https://lms-ai-assistant.com/
// @version      2.0.0
// @description  Licensed LMS AI Assistant with Advanced Features
// @author       LMS AI Team
// @match        https://*.edu/*
// @match        https://*.edu:*/*
// @match        https://*.instructure.com/*
// @match        https://*.blackboard.com/*
// @match        https://*.moodle.*/*
// @match        https://*.brightspace.com/*
// @match        https://*.schoology.com/*
// @match        https://classroom.google.com/*
// @grant        none
// @license      Commercial - Licensed to ${userData.name}
// @homepageURL  https://lms-ai-assistant.com/
// @supportURL   https://lms-ai-assistant.com/support
// ==/UserScript==

/*
 * LMS AI Assistant Pro v2.0.0
 * Licensed to: ${userData.name}
 * License Key: ${currentKey}
 * Valid Until: ${userData.expiry}
 * License Type: ${userData.type || 'STANDARD'}
 * 
 * This software is protected by copyright law and international treaties.
 * Unauthorized reproduction or distribution is prohibited.
 */

(function() {
    'use strict';
    
    // ===== HYBRID SECURITY SYSTEM =====
    const SECURITY_CONFIG = {
        LICENSE_KEY: '${currentKey}',
        USER_NAME: '${userData.name}',
        EXPIRY_DATE: '${userData.expiry}',
        LICENSE_TYPE: '${userData.type || 'STANDARD'}',
        ENCRYPTED_PAYLOAD: '${encryptedPayload}',
        AUTHORIZED_DOMAINS: ${JSON.stringify(authorizedDomains)},
        VALIDATION_ENDPOINTS: [
            '${window.location.origin}/.netlify/functions/validate-license',
            '${window.location.origin}/.netlify/functions/v'
        ],
        MAX_OFFLINE_DAYS: 7,
        SIGNATURE_CHECK: 'LMS_AI_AUTHENTICATED'
    };
    
    let validationAttempts = 0;
    const MAX_ATTEMPTS = 3;
    
    // ===== LOCAL VALIDATION (PRIMARY) =====
    function performLocalValidation() {
        try {
            console.log('🔍 LMS AI: Performing local validation...');
            
            const currentDomain = window.location.hostname.toLowerCase();
            const now = new Date();
            const expiryDate = new Date(SECURITY_CONFIG.EXPIRY_DATE);
            
            // Step 1: Domain Validation
            const isDomainAuthorized = SECURITY_CONFIG.AUTHORIZED_DOMAINS.some(domain => 
                currentDomain.includes(domain) || 
                currentDomain.split('.').some(part => domain.includes(part))
            );
            
            if (!isDomainAuthorized) {
                console.error('❌ Domain not authorized:', currentDomain);
                return { valid: false, reason: 'Domain not authorized for LMS AI Assistant' };
            }
            
            // Step 2: Expiry Validation
            if (now > expiryDate) {
                console.error('❌ License expired:', SECURITY_CONFIG.EXPIRY_DATE);
                return { valid: false, reason: 'License has expired. Please renew your subscription.' };
            }
            
            // Step 3: Time-Lock Validation (changes weekly)
            const weeksSinceEpoch = Math.floor(now.getTime() / (1000 * 60 * 60 * 24 * 7));
            const expiryWeeks = Math.floor(expiryDate.getTime() / (1000 * 60 * 60 * 24 * 7));
            
            if (weeksSinceEpoch > expiryWeeks) {
                console.error('❌ License period exceeded');
                return { valid: false, reason: 'License validation period exceeded' };
            }
            
            // Step 4: Generate Local Decryption Key
            const localKey = generateLocalDecryptionKey(currentDomain, weeksSinceEpoch);
            
            console.log('✅ Local validation passed');
            return { valid: true, decryptionKey: localKey, method: 'local' };
            
        } catch (error) {
            console.error('❌ Local validation error:', error);
            return { valid: false, reason: 'Local validation failed: ' + error.message };
        }
    }
    
    function generateLocalDecryptionKey(domain, weekNumber) {
        const keyMaterial = [
            SECURITY_CONFIG.LICENSE_KEY,
            domain.split('.').slice(-2).join('.'), // Get main domain
            weekNumber.toString(),
            SECURITY_CONFIG.USER_NAME.replace(/\\s+/g, '').toLowerCase()
        ].join('-');
        
        // Generate a consistent key from the material
        let hash = 0;
        for (let i = 0; i < keyMaterial.length; i++) {
            const char = keyMaterial.charCodeAt(i);
            hash = ((hash << 5) - hash) + char;
            hash = hash & hash; // Convert to 32-bit integer
        }
        
        const keyBase = Math.abs(hash).toString(36) + keyMaterial.length.toString(36);
        return (keyBase + keyMaterial.substring(0, 8)).replace(/[^a-zA-Z0-9]/g, '').substring(0, 32);
    }
    
    // ===== SERVER VALIDATION (BACKUP) =====
    async function performServerValidation() {
        try {
            console.log('🌐 LMS AI: Performing server validation...');
            
            // Check if we need server validation (only once per day)
            const lastValidation = localStorage.getItem('lms_ai_last_server_validation');
            const lastValidationTime = lastValidation ? parseInt(lastValidation) : 0;
            const oneDayAgo = Date.now() - (24 * 60 * 60 * 1000);
            
            // Use cached server key if recent
            if (lastValidationTime > oneDayAgo) {
                const cachedKey = localStorage.getItem('lms_ai_server_key');
                if (cachedKey) {
                    console.log('✅ Using cached server validation');
                    return { valid: true, decryptionKey: cachedKey, method: 'cached' };
                }
            }
            
            const validationPayload = {
                licenseKey: SECURITY_CONFIG.LICENSE_KEY,
                domain: window.location.hostname,
                userAgent: navigator.userAgent.substring(0, 50),
                timestamp: Date.now(),
                version: '2.0.0'
            };
            
            // Try primary endpoint
            for (const endpoint of SECURITY_CONFIG.VALIDATION_ENDPOINTS) {
                try {
                    const response = await fetch(endpoint, {
                        method: 'POST',
                        headers: { 
                            'Content-Type': 'application/json',
                            'X-LMS-AI-Version': '2.0.0'
                        },
                        body: JSON.stringify(validationPayload)
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        
                        if (result.valid && result.decryptionKey) {
                            // Cache the server key
                            localStorage.setItem('lms_ai_server_key', result.decryptionKey);
                            localStorage.setItem('lms_ai_last_server_validation', Date.now().toString());
                            
                            console.log('✅ Server validation successful');
                            return { valid: true, decryptionKey: result.decryptionKey, method: 'server' };
                        } else {
                            console.error('❌ Server rejected license:', result.message);
                            return { valid: false, reason: result.message || 'Server validation failed' };
                        }
                    }
                } catch (fetchError) {
                    console.warn('⚠️ Server endpoint failed:', endpoint, fetchError.message);
                    continue; // Try next endpoint
                }
            }
            
            console.warn('⚠️ All server endpoints failed, falling back to local validation');
            return { valid: false, reason: 'Server validation unavailable' };
            
        } catch (error) {
            console.error('❌ Server validation error:', error);
            return { valid: false, reason: 'Server validation failed: ' + error.message };
        }
    }
    
    // ===== SCRIPT DECRYPTION AND EXECUTION =====
    async function decryptAndExecute(validationResult) {
        try {
            console.log('🔓 LMS AI: Decrypting script with', validationResult.method, 'key...');
            
            let decryptedCode;
            
            // Try CryptoJS decryption first
            if (typeof CryptoJS !== 'undefined') {
                try {
                    decryptedCode = CryptoJS.AES.decrypt(
                        SECURITY_CONFIG.ENCRYPTED_PAYLOAD, 
                        validationResult.decryptionKey
                    ).toString(CryptoJS.enc.Utf8);
                } catch (cryptoError) {
                    console.warn('CryptoJS decryption failed, trying fallback...');
                }
            }
            
            // Fallback decryption method
            if (!decryptedCode || decryptedCode.length < 100) {
                try {
                    const decoded = atob(SECURITY_CONFIG.ENCRYPTED_PAYLOAD);
                    const parts = decoded.split('|||');
                    if (parts.length === 2 && parts[1] === validationResult.decryptionKey) {
                        decryptedCode = parts[0];
                    }
                } catch (fallbackError) {
                    console.error('Fallback decryption failed:', fallbackError);
                }
            }
            
            // Verify decryption worked and contains our signature
            if (!decryptedCode || decryptedCode.length < 100) {
                throw new Error('Decryption failed - invalid result length');
            }
            
            if (!decryptedCode.includes(SECURITY_CONFIG.SIGNATURE_CHECK)) {
                throw new Error('Decryption failed - signature verification failed');
            }
            
            // Execute the decrypted LMS AI code
            console.log('🚀 LMS AI: Executing authenticated script...');
            eval(decryptedCode);
            
            // Log successful execution
            console.log('✅ LMS AI Assistant loaded successfully for', SECURITY_CONFIG.USER_NAME);
            
            // Update usage statistics
            updateUsageStats(validationResult.method);
            
        } catch (error) {
            console.error('❌ Script execution failed:', error);
            showErrorMessage('Script execution failed: ' + error.message);
        }
    }
    
    function updateUsageStats(method) {
        try {
            const stats = JSON.parse(localStorage.getItem('lms_ai_usage_stats') || '{}');
            const today = new Date().toISOString().split('T')[0];
            
            if (!stats[today]) {
                stats[today] = { local: 0, server: 0, cached: 0 };
            }
            
            stats[today][method] = (stats[today][method] || 0) + 1;
            
            // Keep only last 30 days
            const thirtyDaysAgo = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
            Object.keys(stats).forEach(date => {
                if (date < thirtyDaysAgo) {
                    delete stats[date];
                }
            });
            
            localStorage.setItem('lms_ai_usage_stats', JSON.stringify(stats));
        } catch (error) {
            console.warn('Failed to update usage stats:', error);
        }
    }
    
    // ===== ERROR HANDLING =====
    function showErrorMessage(message) {
        const errorDiv = document.createElement('div');
        errorDiv.style.cssText = \`
            position: fixed; top: 20px; right: 20px; z-index: 100000;
            background: linear-gradient(135deg, #e74c3c, #c0392b); color: white;
            padding: 20px; border-radius: 10px; max-width: 400px;
            box-shadow: 0 10px 30px rgba(231, 76, 60, 0.3);
            font-family: Arial, sans-serif; font-size: 14px;
        \`;
        
        errorDiv.innerHTML = \`
            <h4 style="margin: 0 0 10px 0;">❌ LMS AI Assistant Error</h4>
            <p style="margin: 0 0 10px 0;">\${message}</p>
            <p style="margin: 0; font-size: 12px; opacity: 0.9;">
                License: \${SECURITY_CONFIG.LICENSE_KEY}<br>
                User: \${SECURITY_CONFIG.USER_NAME}
            </p>
            <button onclick="this.parentNode.remove()" style="
                margin-top: 15px; padding: 8px 15px; background: rgba(255,255,255,0.2);
                border: none; border-radius: 5px; color: white; cursor: pointer;
            ">Close</button>
        \`;
        
        document.body.appendChild(errorDiv);
        
        // Auto-remove after 10 seconds
        setTimeout(() => {
            if (errorDiv.parentNode) {
                errorDiv.parentNode.removeChild(errorDiv);
            }
        }, 10000);
    }
    
    // ===== MAIN INITIALIZATION =====
    async function initializeLMSAI() {
        try {
            console.log('🔄 LMS AI: Starting hybrid security validation...');
            validationAttempts++;
            
            if (validationAttempts > MAX_ATTEMPTS) {
                showErrorMessage('Maximum validation attempts exceeded. Please refresh the page.');
                return;
            }
            
            // Step 1: Try local validation first (fastest, works offline)
            let validationResult = performLocalValidation();
            
            // Step 2: If local fails, try server validation
            if (!validationResult.valid) {
                console.log('🌐 Local validation failed, trying server validation...');
                validationResult = await performServerValidation();
            }
            
            // Step 3: Execute script if validation passed
            if (validationResult.valid) {
                await decryptAndExecute(validationResult);
            } else {
                showErrorMessage(validationResult.reason || 'Validation failed');
            }
            
        } catch (error) {
            console.error('❌ LMS AI initialization failed:', error);
            showErrorMessage('Initialization failed: ' + error.message);
        }
    }
    
    // ===== CRYPTOJS LOADER AND STARTUP =====
    function loadCryptoJSAndStart() {
        if (typeof CryptoJS !== 'undefined') {
            initializeLMSAI();
            return;
        }
        
        console.log('📦 Loading CryptoJS library...');
        const script = document.createElement('script');
        script.src = 'https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js';
        script.onload = function() {
            console.log('✅ CryptoJS loaded successfully');
            initializeLMSAI();
        };
        script.onerror = function() {
            console.error('❌ Failed to load CryptoJS');
            showErrorMessage('Failed to load required security library. Please check your internet connection.');
        };
        document.head.appendChild(script);
    }
    
    // Start the process
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', loadCryptoJSAndStart);
    } else {
        loadCryptoJSAndStart();
    }
    
})();`;

            console.log('✅ Hybrid security script generated successfully');
            return hybridScript;
        }

        // Helper function to generate complex encryption key
        function generateComplexEncryptionKey(userData, licenseKey) {
            const keyComponents = [
                userData.name.replace(/\s+/g, '').toLowerCase(),
                userData.expiry.replace(/-/g, ''),
                userData.type || 'STANDARD',
                licenseKey || 'DEMO',
                'lms-ai-secret-v2'
            ];
            
            let combinedKey = keyComponents.join('-');
            
            // Generate hash-like key
            let hash = 0;
            for (let i = 0; i < combinedKey.length; i++) {
                const char = combinedKey.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            
            return Math.abs(hash).toString(36).substring(0, 32);
        }
        function generateDemoScript() {
            return `// Demo LMS AI Assistant Script
console.log('LMS AI Assistant Demo Mode');
alert('LMS AI Assistant loaded successfully!');

// Demo functionality
function showDemoFeatures() {
    const demo = document.createElement('div');
    demo.style.cssText = \`
        position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
        background: #3498db; color: white; padding: 20px; border-radius: 10px;
        z-index: 100000; text-align: center; font-family: Arial, sans-serif;
    \`;
    demo.innerHTML = '<h3>🎯 LMS AI Demo</h3><p>This is a demo version. Get a license for full features!</p>';
    document.body.appendChild(demo);
    
    setTimeout(() => {
        if (demo.parentNode) demo.parentNode.removeChild(demo);
    }, 3000);
}

showDemoFeatures();`;
        }
        // ===== SECRET ADMIN ACCESS =====
        let secretSequence = [];
        const adminCode = ['KeyA', 'KeyD', 'KeyM', 'KeyI', 'KeyN']; // Type "ADMIN"
        
        document.addEventListener('keydown', function(e) {
            // Only track when no input is focused
            if (document.activeElement.tagName !== 'INPUT') {
                secretSequence.push(e.code);
                if (secretSequence.length > adminCode.length) {
                    secretSequence.shift();
                }
                
                if (secretSequence.join(',') === adminCode.join(',')) {
                    showSecretAdminAccess();
                    secretSequence = [];
                }
            }
        });
        
        function showSecretAdminAccess() {
            const secretDiv = document.createElement('div');
            secretDiv.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: linear-gradient(135deg, #2c3e50, #34495e);
                color: white;
                padding: 30px;
                border-radius: 15px;
                box-shadow: 0 20px 40px rgba(0,0,0,0.3);
                z-index: 100000;
                text-align: center;
                font-family: Arial, sans-serif;
                border: 2px solid #3498db;
            `;
            
            secretDiv.innerHTML = `
                <h3 style="margin: 0 0 20px 0; color: #3498db;">🔐 Admin Access Portal</h3>
                <p style="margin: 0 0 20px 0;">Enter admin password:</p>
                <input type="password" id="adminPassword" placeholder="Password" style="padding: 10px; border: none; border-radius: 5px; margin-bottom: 15px; text-align: center;">
                <br>
                <button onclick="checkAdminPassword()" style="background: #3498db; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin-right: 10px;">
                    Enter Admin Panel
                </button>
                <button onclick="this.parentNode.remove()" style="background: #e74c3c; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">
                    Cancel
                </button>
            `;
            
            document.body.appendChild(secretDiv);
            
            // Focus password input
            setTimeout(() => {
                document.getElementById('adminPassword').focus();
            }, 100);
            
            // Allow Enter key
            document.getElementById('adminPassword').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    checkAdminPassword();
                }
            });
        }
        
function checkAdminPassword() {
            const password = document.getElementById('adminPassword').value;
            
            // Get current admin password (check localStorage)
            let correctPassword = 'admin2025'; // Default
            
            // Check system settings first
            const systemSettings = localStorage.getItem('lms_ai_system_settings');
            if (systemSettings) {
                try {
                    const settings = JSON.parse(systemSettings);
                    if (settings.adminPassword) {
                        correctPassword = settings.adminPassword;
                    }
                } catch (e) {
                    console.warn('Could not load system settings');
                }
            }
            
            // Check dedicated password storage
            const storedPassword = localStorage.getItem('lms_ai_admin_password');
            if (storedPassword) {
                correctPassword = storedPassword;
            }
            
            console.log('[DEBUG] Current admin password:', correctPassword);
            
            if (password === correctPassword) {
                window.open('./admin.html', '_blank');
                document.querySelector('[style*="position: fixed"]').remove();
            } else {
                alert('❌ Invalid password! Access denied.');
                document.getElementById('adminPassword').value = '';
                document.getElementById('adminPassword').style.borderColor = '#e74c3c';
                
                setTimeout(() => {
                    document.getElementById('adminPassword').style.borderColor = '';
                }, 2000);
            }
        }

        // Test that functions are loaded
        console.log('LMS AI Assistant loaded successfully!');
        console.log('Database validation: Available');
        console.log('Secret admin access: Type "ADMIN" on page');
        // ===== EMAIL NOTIFICATIONS FOR KEY VALIDATION =====
       // ===== EMAIL NOTIFICATIONS FOR KEY VALIDATION (DEBUG VERSION) =====
        async function sendValidationNotification(keyData, action) {
            try {
                console.log('[EMAIL DEBUG] Starting notification process...');
                console.log('[EMAIL DEBUG] Action:', action);
                console.log('[EMAIL DEBUG] Key data:', keyData);
                
                // Get admin email settings
                const adminSettings = localStorage.getItem('lms_ai_system_settings');
                console.log('[EMAIL DEBUG] Admin settings found:', !!adminSettings);
                
                if (!adminSettings) {
                    console.log('[EMAIL DEBUG] No admin settings found');
                    return;
                }
                
                const settings = JSON.parse(adminSettings);
                console.log('[EMAIL DEBUG] Email service:', settings.emailService);
                console.log('[EMAIL DEBUG] Notification email:', settings.notificationEmail);
                
                if (settings.emailService === 'disabled') {
                    console.log('[EMAIL DEBUG] Email service is disabled');
                    return;
                }
                
                const notificationData = {
                    keyCode: document.getElementById('productKey').value,
                    userName: keyData.name,
                    keyType: keyData.type || 'STANDARD',
                    userAgent: navigator.userAgent.substring(0, 100),
                    timestamp: new Date().toISOString(),
                    action: action
                };
                
                console.log('[EMAIL DEBUG] Notification data:', notificationData);
                
                if (settings.emailService === 'netlify') {
                    console.log('[EMAIL DEBUG] Using Netlify notifications');
                    await sendNetlifyNotification(settings, action, notificationData);
                } else if (settings.emailService === 'emailjs') {
                    console.log('[EMAIL DEBUG] Using EmailJS notifications');
                    await sendEmailJSNotification(settings, action, notificationData);
                }
                
                console.log('[EMAIL DEBUG] Notification sent successfully:', action);
            } catch (error) {
                console.error('[EMAIL DEBUG] Notification failed:', error);
                console.error('[EMAIL DEBUG] Error details:', error.message);
                // Don't show error to user - notifications are background
            }
        }

        async function sendNetlifyNotification(settings, type, data) {
            console.log('[EMAIL DEBUG] Netlify notification starting...');
            
            const formData = new FormData();
            formData.append('form-name', 'contact');
            formData.append('name', 'LMS AI System');
            formData.append('email', settings.notificationEmail);
            formData.append('subject', `LMS AI - ${type}`);
            formData.append('message', formatNotificationMessage(type, data));
            formData.append('timestamp', new Date().toISOString());

            console.log('[EMAIL DEBUG] Sending to:', settings.notificationEmail);
            console.log('[EMAIL DEBUG] Subject:', `LMS AI - ${type}`);

            const response = await fetch('/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: new URLSearchParams(formData)
            });

            console.log('[EMAIL DEBUG] Netlify response status:', response.status);

            if (!response.ok) {
                throw new Error(`Netlify notification failed: ${response.status}`);
            }
            
            console.log('[EMAIL DEBUG] Netlify notification sent successfully');
        }

        async function sendEmailJSNotification(settings, type, data) {
            console.log('[EMAIL DEBUG] EmailJS notification starting...');
            console.log('[EMAIL DEBUG] EmailJS settings check:');
            console.log('  - Public Key:', !!settings.emailjsPublicKey);
            console.log('  - Service ID:', !!settings.emailjsServiceId);
            console.log('  - Template ID:', !!settings.emailjsTemplateId);
            
            if (!settings.emailjsPublicKey || !settings.emailjsServiceId || !settings.emailjsTemplateId) {
                throw new Error('EmailJS not configured properly');
            }

            // Check if EmailJS is available
            if (typeof emailjs === 'undefined') {
                throw new Error('EmailJS library not loaded');
            }

            // Initialize EmailJS
            console.log('[EMAIL DEBUG] Initializing EmailJS...');
            emailjs.init(settings.emailjsPublicKey);

            const templateParams = {
                to_email: settings.notificationEmail,
                subject: `LMS AI - ${type}`,
                message: formatNotificationMessage(type, data),
                timestamp: new Date().toLocaleString(),
                keyCode: data.keyCode || '',
                userName: data.userName || '',
                keyType: data.keyType || ''
            };

            console.log('[EMAIL DEBUG] Template params:', templateParams);
            console.log('[EMAIL DEBUG] Sending EmailJS...');

            const result = await emailjs.send(
                settings.emailjsServiceId,
                settings.emailjsTemplateId,
                templateParams
            );

            console.log('[EMAIL DEBUG] EmailJS result:', result);
        }

        function formatNotificationMessage(type, data) {
            const timestamp = new Date().toLocaleString();
            const userAgent = data.userAgent ? data.userAgent.substring(0, 50) + '...' : 'Unknown';
            
            console.log('[EMAIL DEBUG] Formatting message for type:', type);
            
            switch (type) {
                case 'Key Validation':
                    return `🔑 License Key Validated Successfully!

Key Details:
- Key Code: ${data.keyCode}
- User Name: ${data.userName}
- Key Type: ${data.keyType}
- Validation Time: ${timestamp}

System Info:
- User Agent: ${userAgent}
- Status: ✅ Valid and Active

The user has successfully validated their key and can now access the download page.`;

                case 'Script Download':
                    return `📥 User Downloaded Personalized Script!

Download Details:
- User: ${data.userName}
- Key: ${data.keyCode}
- Key Type: ${data.keyType}
- Download Time: ${timestamp}

System Info:
- User Agent: ${userAgent}
- Script: Personalized and encrypted
- Status: ✅ Download completed successfully

The user has successfully downloaded their personalized LMS AI script.`;

                case 'Invalid Key Attempt':
                    return `⚠️ Invalid Key Validation Attempt

Attempt Details:
- Attempted Key: ${data.keyCode}
- Time: ${timestamp}
- User Agent: ${userAgent}

This could be:
- User typing error
- Expired key
- Deactivated key
- Malicious attempt

Monitor for repeated invalid attempts from same source.`;

                default:
                    return `📬 LMS AI Activity: ${type}\n\nTimestamp: ${timestamp}\nDetails: ${JSON.stringify(data, null, 2)}`;
            }
        }
    </script>
</body>
</html>
