<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LMS AI Assistant Pro</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 50px auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            text-align: center;
        }
        h1 {
            color: #333;
            margin-bottom: 10px;
        }
        .subtitle {
            color: #666;
            margin-bottom: 30px;
        }
        input {
            padding: 15px;
            width: 300px;
            border: 2px solid #ddd;
            border-radius: 8px;
            margin: 10px;
            font-size: 16px;
        }
        input:focus {
            border-color: #667eea;
            outline: none;
        }
        button {
            padding: 15px 30px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: transform 0.2s;
        }
        button:hover {
            transform: translateY(-2px);
        }
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        .status {
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
            font-weight: bold;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info {
            margin-top: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }
        .hidden {
            display: none;
        }
        .download-section {
            margin-top: 20px;
            padding: 20px;
            background: #e8f5e8;
            border-radius: 8px;
        }
        .loading {
            color: #666;
            font-style: italic;
        }
    </style>
    <!-- EmailJS for notifications -->
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
</head>
<body>
    <div class="container">
        <h1>🚀 LMS AI Assistant Pro</h1>
        <p class="subtitle">Enhanced Learning Management System Assistant</p>
        
        <div id="keySection">
            <p>Enter your product key to download the script:</p>
            <input type="text" id="productKey" placeholder="Enter your product key" maxlength="50">
            <br>
            <button onclick="validateAndDownload()" id="validateBtn">Validate Key</button>
            
            <div id="status" class="status hidden"></div>
        </div>
        
        <div id="downloadSection" class="download-section hidden">
            <h3>✅ Key Validated Successfully!</h3>
            <p>Welcome, <span id="userName"></span>!</p>
            <p>License valid until: <span id="expiry"></span></p>
            <button onclick="downloadScript()" id="downloadBtn">📥 Download Your Script</button>
        </div>
        
        <div class="info">
            <h3>📚 Installation Instructions:</h3>
            <p><strong>Step 1:</strong> Install ScriptCat or GreaseMonkey browser extension</p>
            <p><strong>Step 2:</strong> Enter your product key above</p>
            <p><strong>Step 3:</strong> Download your personalized script</p>
            <p><strong>Step 4:</strong> Install the script in your browser extension</p>
            <p><strong>Step 5:</strong> Visit your LMS and enjoy enhanced functionality!</p>
            
            <hr style="margin: 20px 0;">
            <p><strong>🔧 Support:</strong> Contact your script provider for help</p>
            <p><strong>🔄 Updates:</strong> Re-download from this page for latest version</p>
        </div>
    </div>

    <script>
        // ===== SAFE ENCODING FUNCTIONS =====
        function safeBase64Encode(str) {
            try {
                // First try native btoa
                return btoa(str);
            } catch (error) {
                // Fallback for Unicode characters
                return btoa(encodeURIComponent(str).replace(/%([0-9A-F]{2})/g,
                    function toSolidBytes(match, p1) {
                        return String.fromCharCode('0x' + p1);
                    }
                ));
            }
        }
        
        function safeBase64Decode(str) {
            try {
                return atob(str);
            } catch (error) {
                try {
                    return decodeURIComponent(atob(str).split('').map(function(c) {
                        return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                    }).join(''));
                } catch (e) {
                    return str; // Return original if all else fails
                }
            }
        }
        
        function generateSafeKey(components) {
            // Create a safe key without Unicode issues
            const cleanComponents = components.map(comp => 
                comp.replace(/[^\w\-\.]/g, '').toLowerCase()
            );
            
            let hash = 0;
            const keyString = cleanComponents.join('-');
            
            for (let i = 0; i < keyString.length; i++) {
                const char = keyString.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash; // Convert to 32-bit integer
            }
            
            return Math.abs(hash).toString(36).padStart(8, '0').substring(0, 32);
        }
        // ===== ENCRYPTION FUNCTIONS =====
        function simpleEncrypt(text, key) {
            try {
                const utf8Text = unescape(encodeURIComponent(text));
                let result = '';
                
                for (let i = 0; i < utf8Text.length; i++) {
                    const charCode = utf8Text.charCodeAt(i);
                    const keyChar = key.charCodeAt(i % key.length);
                    const encrypted = charCode ^ keyChar;
                    result += String.fromCharCode(encrypted);
                }
                
                return btoa(result);
            } catch (e) {
                console.error('Encryption error:', e);
                return btoa(text.replace(/[^\x00-\x7F]/g, "?"));
            }
        }

        function simpleDecrypt(encryptedText, key) {
            try {
                const decoded = atob(encryptedText);
                let result = '';
                
                for (let i = 0; i < decoded.length; i++) {
                    const charCode = decoded.charCodeAt(i);
                    const keyChar = key.charCodeAt(i % key.length);
                    const decrypted = charCode ^ keyChar;
                    result += String.fromCharCode(decrypted);
                }
                
                return decodeURIComponent(escape(result));
            } catch (e) {
                console.error('Decryption error:', e);
                return null;
            }
        }
// ===== DATABASE-POWERED KEY VALIDATION =====
async function validateProductKey(key) {
    try {
        console.log('[LMS AI] Validating key with database:', key);
        
        // Try database first - FIXED TO MATCH ADMIN PANEL
        const response = await fetch('/.netlify/functions/validate-key', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ 
                licenseKey: key,  // ← CHANGED from 'keyCode' to 'licenseKey'
                action: 'validate'
            })
        });
        
        if (response.ok) {
            const result = await response.json();
            console.log('[LMS AI] Database validation result:', result);
            
            // Make sure the response format matches what you expect
            if (result.valid && result.user) {
                return {
                    valid: true,
                    message: "Valid key! Preparing your personalized script...",
                    userData: {
                        name: result.user.name,
                        email: result.user.email,
                        expiry: result.user.expiry,
                        type: result.user.type || 'STANDARD',
                        active: result.user.active
                    }
                };
            } else {
                return {
                    valid: false,
                    message: result.message || "Invalid license key"
                };
            }
        }
        
        throw new Error('Database unavailable');
    } catch (error) {
        console.warn('[LMS AI] Database validation failed, using fallback:', error);
        
        // Fallback to hardcoded keys
        return validateKeyFallback(key);
    }
}

// Keep your existing fallback function unchanged
function validateKeyFallback(key) {
    console.log('[LMS AI] Fallback validation for key:', key);
    
    // ===== PATTERN-BASED VALIDATION FOR LMS-AI KEYS =====
    const lmsPattern = /^LMS-AI-2025-[A-Z0-9]{8}$/;
    if (lmsPattern.test(key)) {
        console.log('[LMS AI] Valid LMS-AI pattern detected');
        return {
            valid: true,
            message: "Valid LMS AI key! Preparing your personalized script...",
            userData: {
                name: "LMS AI User",
                email: "user@example.com",
                type: "STANDARD",
                expiry: "2025-12-31",
                active: true,
                encryptionKey: "lms-ai-key-2025"
            }
        };
    }
    
    // ===== EXISTING FALLBACK KEYS =====
    const fallbackKeys = {
        "DEMO-2025-TEST": {
            name: "Demo User",
            email: "demo@example.com",
            type: "DEMO",
            expiry: "2025-12-31",
            active: true,
            encryptionKey: "demo-secret-key-2025"
        },
        "ADMIN-2025-MASTER": {
            name: "Administrator",
            email: "admin@example.com", 
            type: "ADMIN",
            expiry: "2099-12-31",
            active: true,
            encryptionKey: "admin-master-key-2025"
        },
        "JOHN-2025-ABC123": {
            name: "John Smith",
            email: "john@example.com",
            type: "STANDARD",
            expiry: "2025-12-31",
            active: true,
            encryptionKey: "john-secret-key-2025"
        }
    };
    
    // ===== VALIDATION LOGIC =====
    if (!key || key.trim() === '') {
        return { valid: false, message: "Please enter a product key" };
    }
    
    const keyData = fallbackKeys[key.toUpperCase()];
    
    if (!keyData) {
        return { valid: false, message: "Invalid product key. Please check your key and try again." };
    }
    
    if (!keyData.active) {
        return { valid: false, message: "This key has been deactivated. Please contact support." };
    }
    
    const today = new Date();
    const expiryDate = new Date(keyData.expiry);
    
    if (today > expiryDate) {
        return { valid: false, message: "This key has expired. Please renew your license." };
    }
    
    return { 
        valid: true, 
        message: "Valid key! Preparing your personalized script...", 
        userData: keyData 
    };
}
        // ===== SCRIPT FILE LOADING =====
        async function loadMasterScript() {
            try {
                console.log('Loading master script from lms-ai-script.js...');
                const response = await fetch('./lms-ai-script.js');
                
                if (!response.ok) {
                    throw new Error(`Failed to fetch script: ${response.status} ${response.statusText}`);
                }
                
                const scriptContent = await response.text();
                console.log('Master script loaded successfully, length:', scriptContent.length);
                return scriptContent;
            } catch (error) {
                console.error('Failed to load master script:', error);
                return `
// Demo script fallback - real script file not found
console.log('[LMS AI] Demo script loaded (fallback)');
alert('LMS AI Assistant Pro Demo Mode\\nReal script file not found at ./lms-ai-script.js');
                `;
            }
        }

        // ===== USAGE TRACKING =====
        function logKeyUsage(key, action) {
            const timestamp = new Date().toISOString();
            console.log(`[${timestamp}] Key: ${key}, Action: ${action}`);
        }

        // ===== MAIN APPLICATION =====
        let currentUserData = null;
        
        async function validateAndDownload() {
            const keyInput = document.getElementById('productKey');
            const statusDiv = document.getElementById('status');
            const validateBtn = document.getElementById('validateBtn');
            const downloadSection = document.getElementById('downloadSection');
            
            const key = keyInput.value.trim();
            
            validateBtn.disabled = true;
            validateBtn.textContent = 'Validating...';
            
            try {
                const result = await validateProductKey(key);
                
                statusDiv.classList.remove('hidden', 'success', 'error');
                
                if (result.valid) {
                    statusDiv.classList.add('success');
                    statusDiv.textContent = result.message;
                    
                    currentUserData = result.userData;
                    document.getElementById('userName').textContent = result.userData.name;
                    document.getElementById('expiry').textContent = result.userData.expiry;
                    downloadSection.classList.remove('hidden');
                    
                    // 📧 Send validation notification
                    sendValidationNotification(result.userData, 'Key Validation');
                    
                } else {
                    statusDiv.classList.add('error');
                    statusDiv.textContent = result.message;
                    downloadSection.classList.add('hidden');
                    
                    // 📧 Send invalid key attempt notification
                    sendValidationNotification({ name: 'Unknown' }, 'Invalid Key Attempt');
                }
                
            } catch (error) {
                statusDiv.classList.remove('hidden', 'success');
                statusDiv.classList.add('error');
                statusDiv.textContent = 'Validation failed. Please try again.';
                
                // 📧 Send error notification
                sendValidationNotification({ name: 'Error' }, 'Validation Error');
            } finally {
                validateBtn.disabled = false;
                validateBtn.textContent = 'Validate Key';
            }
        }
        
      async function downloadScript() {
            if (!currentUserData) {
                alert('Please validate your key first!');
                return;
            }
            
            const downloadBtn = document.getElementById('downloadBtn');
            downloadBtn.disabled = true;
            downloadBtn.textContent = '📥 Generating Script...';
            
            try {
                // Load the master script or use demo
                let masterScript;
                try {
                    const response = await fetch('./lms-ai-script.js');
                    if (response.ok) {
                        masterScript = await response.text();
                    } else {
                        throw new Error('Master script not found');
                    }
                } catch (error) {
                    console.warn('Using demo script:', error);
                    masterScript = generateDemoScript();
                }
                
                downloadBtn.textContent = '📥 Preparing Download...';
                
                setTimeout(() => {
                    const scriptContent = generatePersonalizedScript(currentUserData, masterScript);
                    const blob = new Blob([scriptContent], { type: 'application/javascript' });
                    const url = URL.createObjectURL(blob);
                    
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `lms-ai-assistant-${currentUserData.name.replace(/\s+/g, '-').toLowerCase()}.user.js`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    
                    downloadBtn.textContent = '✅ Download Complete!';
                    
                    // 📧 Send download notification
                    sendValidationNotification(currentUserData, 'Script Download');
                    
                    // Show success message
                    setTimeout(() => {
                        showDownloadSuccessMessage();
                    }, 1000);
                    
                    setTimeout(() => {
                        downloadBtn.disabled = false;
                        downloadBtn.textContent = '📥 Download Your Script';
                    }, 3000);
                    
                }, 1000);
                
            } catch (error) {
                console.error('Download failed:', error);
                downloadBtn.disabled = false;
                downloadBtn.textContent = '❌ Download Failed';
                alert('Failed to generate script. Please try again.');
                
                setTimeout(() => {
                    downloadBtn.textContent = '📥 Download Your Script';
                }, 3000);
            }
        }

        function generateDemoScript() {
            return `// Demo LMS AI Assistant Script
console.log('LMS AI Assistant Demo Mode');
alert('LMS AI Assistant loaded successfully!');
// Add your actual script functionality here`;
        }

        function showDownloadSuccessMessage() {
            const successDiv = document.createElement('div');
            successDiv.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: linear-gradient(135deg, #27ae60, #2ecc71);
                color: white;
                padding: 30px;
                border-radius: 15px;
                box-shadow: 0 10px 30px rgba(39, 174, 96, 0.3);
                z-index: 100000;
                text-align: center;
                font-family: Arial, sans-serif;
                max-width: 400px;
            `;
            
            successDiv.innerHTML = `
                <h3 style="margin: 0 0 15px 0;">🎉 Download Successful!</h3>
                <p style="margin: 0 0 10px 0;">Your personalized LMS AI script is ready!</p>
                <p style="margin: 0 0 20px 0; font-size: 14px; opacity: 0.9;">
                    Licensed to: ${currentUserData.name}<br>
                    Valid until: ${currentUserData.expiry}
                </p>
                <div style="font-size: 12px; opacity: 0.8; border-top: 1px solid rgba(255,255,255,0.3); padding-top: 15px;">
                    <strong>Next Steps:</strong><br>
                    1. Install in ScriptCat/GreaseMonkey<br>
                    2. Visit your LMS to activate<br>
                    3. Enjoy enhanced functionality!
                </div>
            `;
            
            document.body.appendChild(successDiv);
            
            setTimeout(() => {
                successDiv.style.opacity = '0';
                successDiv.style.transform = 'translate(-50%, -50%) scale(0.9)';
                setTimeout(() => {
                    if (successDiv.parentNode) {
                        successDiv.parentNode.removeChild(successDiv);
                    }
                }, 300);
            }, 5000);
        }
function generatePersonalizedScript(userData, masterScript) {
            console.log('🔐 Generating secure loader script for:', userData.name);
            
            // Get the current license key being validated
            const currentKey = document.getElementById('productKey').value.trim();
            
            // Generate authorized domains
            const authorizedDomains = [
                'canvas', 'blackboard', 'moodle', 'brightspace', 'schoology', 
                'edmodo', 'google.classroom', 'teams.microsoft', 'learn',
                'lms', 'elearning', 'education', 'university', 'college', 'school'
            ];
            
            // Generate encryption key for this user
            const encryptionKey = generateUserEncryptionKey(userData, currentKey);
            
            // Create the secure loader script
            const loaderScript = `// ==UserScript==
// @name         LMS AI Assistant Pro - ${userData.name}
// @namespace    https://lms-ai-assistant.com/
// @version      2.0.0
// @description  Licensed LMS AI Assistant with Advanced Features
// @author       LMS AI Team
// @match        https://*.edu/*
// @match        https://*.edu:*/*
// @match        https://*.instructure.com/*
// @match        https://*.blackboard.com/*
// @match        https://*.moodle.*/*
// @match        https://*.brightspace.com/*
// @match        https://*.schoology.com/*
// @match        https://classroom.google.com/*
// @grant        none
// @license      Commercial - Licensed to ${userData.name}
// @homepageURL  https://lms-ai-assistant.com/
// @supportURL   https://lms-ai-assistant.com/support
// ==/UserScript==

/*
 * LMS AI Assistant Pro v2.0.0 - Secure Loader
 * Licensed to: ${userData.name}
 * License Key: ${currentKey}
 * Valid Until: ${userData.expiry}
 * License Type: ${userData.type || 'STANDARD'}
 * 
 * This is a secure loader that fetches and decrypts the main LMS AI script.
 * The actual functionality is stored securely on the server.
 */

(function() {
    'use strict';
    
    // ===== SECURE CONFIGURATION =====
    const SECURITY_CONFIG = {
        LICENSE_KEY: '${currentKey}',
        USER_NAME: '${userData.name}',
        EXPIRY_DATE: '${userData.expiry}',
        LICENSE_TYPE: '${userData.type || 'STANDARD'}',
        ENCRYPTION_KEY: '${encryptionKey}',
        AUTHORIZED_DOMAINS: ${JSON.stringify(authorizedDomains)},
        SCRIPT_URL: '${window.location.origin}/script/lms-ai-script.js',
        VALIDATION_URL: '${window.location.origin}/.netlify/functions/validate-license',
        LOADER_VERSION: '2.0.0'
    };
    
    let validationAttempts = 0;
    const MAX_ATTEMPTS = 3;
    let scriptLoaded = false;
    
    // ===== DOMAIN AND LICENSE VALIDATION =====
    function performSecurityValidation() {
        try {
            console.log('🔍 LMS AI Loader: Performing security validation...');
            
            const currentDomain = window.location.hostname.toLowerCase();
            const now = new Date();
            const expiryDate = new Date(SECURITY_CONFIG.EXPIRY_DATE);
            
            // Step 1: Domain Validation
            const isDomainAuthorized = SECURITY_CONFIG.AUTHORIZED_DOMAINS.some(domain => 
                currentDomain.includes(domain) || 
                currentDomain.split('.').some(part => domain.includes(part))
            );
            
            if (!isDomainAuthorized) {
                return { 
                    valid: false, 
                    reason: \`❌ Domain "\${currentDomain}" is not authorized.\\n\\nThis script only works on educational LMS platforms.\` 
                };
            }
            
            // Step 2: License Expiry Check
            if (now > expiryDate) {
                return { 
                    valid: false, 
                    reason: \`❌ License expired on \${SECURITY_CONFIG.EXPIRY_DATE}.\\n\\nPlease renew your subscription to continue using LMS AI Assistant.\` 
                };
            }
            
            // Step 3: Time-based validation
            const daysSinceEpoch = Math.floor(now.getTime() / (1000 * 60 * 60 * 24));
            const expiryDays = Math.floor(expiryDate.getTime() / (1000 * 60 * 60 * 24));
            
            if (daysSinceEpoch > expiryDays) {
                return { 
                    valid: false, 
                    reason: '❌ License validation period exceeded. Please download a fresh script.' 
                };
            }
            
            console.log('✅ Security validation passed');
            return { valid: true, method: 'local' };
            
        } catch (error) {
            return { 
                valid: false, 
                reason: '❌ Security validation failed: ' + error.message 
            };
        }
    }
    
    // ===== SERVER VALIDATION =====
    async function performServerValidation() {
        try {
            console.log('🌐 LMS AI Loader: Checking license with server...');
            
            const validationPayload = {
                licenseKey: SECURITY_CONFIG.LICENSE_KEY,
                domain: window.location.hostname,
                userAgent: navigator.userAgent.substring(0, 50),
                timestamp: Date.now(),
                loaderVersion: SECURITY_CONFIG.LOADER_VERSION
            };
            
            const response = await fetch(SECURITY_CONFIG.VALIDATION_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(validationPayload)
            });
            
            if (response.ok) {
                const result = await response.json();
                
                if (result.valid) {
                    console.log('✅ Server validation successful');
                    return { valid: true, method: 'server', decryptionKey: result.decryptionKey };
                } else {
                    return { 
                        valid: false, 
                        reason: result.message || '❌ Server validation failed' 
                    };
                }
            } else {
                console.warn('⚠️ Server validation unavailable, proceeding with local validation');
                return { valid: true, method: 'offline' };
            }
            
        } catch (error) {
            console.warn('⚠️ Server validation failed, proceeding offline:', error.message);
            return { valid: true, method: 'offline' };
        }
    }
    
    // ===== LOAD AND DECRYPT MAIN SCRIPT =====
    async function loadMainScript(validationResult) {
        try {
            console.log('📦 LMS AI Loader: Loading main script...');
            
            // Fetch the main LMS AI script
            const response = await fetch(SECURITY_CONFIG.SCRIPT_URL + '?v=' + Date.now(), {
                cache: 'no-cache',
                headers: {
                    'X-LMS-AI-License': SECURITY_CONFIG.LICENSE_KEY,
                    'X-LMS-AI-User': SECURITY_CONFIG.USER_NAME
                }
            });
            
            if (!response.ok) {
                throw new Error(\`Failed to load script: HTTP \${response.status}\`);
            }
            
            let scriptContent = await response.text();
            
            // Check if script is encrypted
            if (scriptContent.includes('ENCRYPTED_LMS_AI_SCRIPT')) {
                console.log('🔓 LMS AI Loader: Decrypting main script...');
                scriptContent = decryptScript(scriptContent, validationResult.decryptionKey || SECURITY_CONFIG.ENCRYPTION_KEY);
            }
            
            // Validate script content
            if (!scriptContent || scriptContent.length < 100) {
                throw new Error('Invalid script content received');
            }
            
            // Execute the main LMS AI script
            console.log('🚀 LMS AI Loader: Executing main script...');
            
            // Create script context with user info
            const scriptContext = {
                LMS_AI_USER: SECURITY_CONFIG.USER_NAME,
                LMS_AI_LICENSE: SECURITY_CONFIG.LICENSE_KEY,
                LMS_AI_EXPIRY: SECURITY_CONFIG.EXPIRY_DATE,
                LMS_AI_TYPE: SECURITY_CONFIG.LICENSE_TYPE,
                LMS_AI_LOADER_VERSION: SECURITY_CONFIG.LOADER_VERSION
            };
            
            // Inject context and execute
            const contextScript = \`
                window.LMS_AI_CONTEXT = \${JSON.stringify(scriptContext)};
                \${scriptContent}
            \`;
            
            eval(contextScript);
            
            scriptLoaded = true;
            console.log('✅ LMS AI Assistant loaded successfully for', SECURITY_CONFIG.USER_NAME);
            
            // Track successful load
            trackScriptUsage(validationResult.method);
            
            // Send notification to admin
            notifyAdminOfUsage();
            
        } catch (error) {
            console.error('❌ Failed to load main script:', error);
            showErrorMessage('Failed to load LMS AI script: ' + error.message + '\\n\\nPlease check your internet connection and try refreshing the page.');
        }
    }
    
    // ===== SCRIPT DECRYPTION =====
    function decryptScript(encryptedContent, key) {
        try {
            // Simple decryption - you can enhance this
            const lines = encryptedContent.split('\\n');
            const decryptedLines = lines.map(line => {
                if (line.includes('ENCRYPTED_LMS_AI_SCRIPT')) {
                    return line.replace('ENCRYPTED_LMS_AI_SCRIPT', '');
                }
                return line;
            });
            
            return decryptedLines.join('\\n');
        } catch (error) {
            console.error('Decryption failed:', error);
            return encryptedContent; // Return as-is if decryption fails
        }
    }
    
    // ===== USAGE TRACKING =====
    function trackScriptUsage(method) {
        try {
            const usage = JSON.parse(localStorage.getItem('lms_ai_usage_tracking') || '{}');
            const today = new Date().toISOString().split('T')[0];
            
            if (!usage[today]) {
                usage[today] = { loads: 0, method: [] };
            }
            
            usage[today].loads++;
            usage[today].method.push(method);
            
            // Keep only last 30 days
            const thirtyDaysAgo = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
            Object.keys(usage).forEach(date => {
                if (date < thirtyDaysAgo) {
                    delete usage[date];
                }
            });
            
            localStorage.setItem('lms_ai_usage_tracking', JSON.stringify(usage));
        } catch (error) {
            console.warn('Usage tracking failed:', error);
        }
    }
    
    // ===== ADMIN NOTIFICATION =====
    async function notifyAdminOfUsage() {
        try {
            // Send usage notification to admin (non-blocking)
            fetch('${window.location.origin}/.netlify/functions/notify-usage', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    licenseKey: SECURITY_CONFIG.LICENSE_KEY,
                    userName: SECURITY_CONFIG.USER_NAME,
                    domain: window.location.hostname,
                    timestamp: new Date().toISOString(),
                    action: 'script_loaded'
                })
            }).catch(() => {}); // Silent fail
        } catch (error) {
            // Silent fail - admin notification is not critical
        }
    }
    
    // ===== ERROR DISPLAY =====
    function showErrorMessage(message) {
        const errorDiv = document.createElement('div');
        errorDiv.style.cssText = \`
            position: fixed; top: 20px; right: 20px; z-index: 100000;
            background: linear-gradient(135deg, #e74c3c, #c0392b); color: white;
            padding: 20px; border-radius: 10px; max-width: 400px;
            box-shadow: 0 10px 30px rgba(231, 76, 60, 0.3);
            font-family: Arial, sans-serif; font-size: 14px; line-height: 1.4;
        \`;
        
        errorDiv.innerHTML = \`
            <h4 style="margin: 0 0 10px 0;">❌ LMS AI Assistant Error</h4>
            <p style="margin: 0 0 15px 0;">\${message}</p>
            <div style="font-size: 12px; opacity: 0.9; border-top: 1px solid rgba(255,255,255,0.3); padding-top: 10px;">
                <strong>License:</strong> \${SECURITY_CONFIG.LICENSE_KEY}<br>
                <strong>User:</strong> \${SECURITY_CONFIG.USER_NAME}<br>
                <strong>Expires:</strong> \${SECURITY_CONFIG.EXPIRY_DATE}
            </div>
            <button onclick="this.parentNode.remove()" style="
                margin-top: 15px; padding: 8px 15px; background: rgba(255,255,255,0.2);
                border: none; border-radius: 5px; color: white; cursor: pointer;
            ">Close</button>
        \`;
        
        document.body.appendChild(errorDiv);
        
        setTimeout(() => {
            if (errorDiv.parentNode) {
                errorDiv.parentNode.removeChild(errorDiv);
            }
        }, 15000);
    }
    
    // ===== SUCCESS INDICATOR =====
    function showLoadingIndicator() {
        const indicator = document.createElement('div');
        indicator.id = 'lms-ai-loading';
        indicator.style.cssText = \`
            position: fixed; top: 20px; left: 20px; z-index: 99999;
            background: linear-gradient(135deg, #3498db, #2980b9); color: white;
            padding: 15px 20px; border-radius: 10px; font-family: Arial, sans-serif;
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3); font-size: 14px;
        \`;
        
        indicator.innerHTML = \`
            <div style="display: flex; align-items: center;">
                <div style="width: 20px; height: 20px; border: 2px solid rgba(255,255,255,0.3); border-radius: 50%; border-top-color: white; animation: spin 1s linear infinite; margin-right: 10px;"></div>
                <span>🚀 Loading LMS AI Assistant...</span>
            </div>
            <style>
                @keyframes spin { to { transform: rotate(360deg); } }
            </style>
        \`;
        
        document.body.appendChild(indicator);
        
        return indicator;
    }
    
    // ===== MAIN INITIALIZATION =====
    async function initializeLMSAI() {
        let loadingIndicator = null;
        
        try {
            console.log('🔄 LMS AI Loader: Starting initialization...');
            validationAttempts++;
            
            if (validationAttempts > MAX_ATTEMPTS) {
                showErrorMessage('Maximum validation attempts exceeded. Please refresh the page and try again.');
                return;
            }
            
            if (scriptLoaded) {
                console.log('ℹ️ LMS AI already loaded, skipping...');
                return;
            }
            
            // Show loading indicator
            loadingIndicator = showLoadingIndicator();
            
            // Step 1: Local security validation
            const localValidation = performSecurityValidation();
            
            if (!localValidation.valid) {
                if (loadingIndicator) loadingIndicator.remove();
                showErrorMessage(localValidation.reason);
                return;
            }
            
            // Step 2: Server validation
            const serverValidation = await performServerValidation();
            
            if (!serverValidation.valid) {
                if (loadingIndicator) loadingIndicator.remove();
                showErrorMessage(serverValidation.reason);
                return;
            }
            
            // Step 3: Load main script
            await loadMainScript(serverValidation);
            
            // Remove loading indicator
            if (loadingIndicator) {
                loadingIndicator.innerHTML = '<span style="color: #27ae60;">✅ LMS AI Assistant Loaded!</span>';
                setTimeout(() => {
                    if (loadingIndicator.parentNode) {
                        loadingIndicator.remove();
                    }
                }, 2000);
            }
            
        } catch (error) {
            console.error('❌ LMS AI Loader initialization failed:', error);
            if (loadingIndicator) loadingIndicator.remove();
            showErrorMessage('Initialization failed: ' + error.message + '\\n\\nPlease try refreshing the page.');
        }
    }
    
    // ===== START THE LOADER =====
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initializeLMSAI);
    } else {
        // Small delay to ensure page is ready
        setTimeout(initializeLMSAI, 500);
    }
    
})();`;

            console.log('✅ Secure loader script generated successfully');
            return loaderScript;
        }

        // Helper function to generate user-specific encryption key
        function generateUserEncryptionKey(userData, licenseKey) {
            const components = [
                userData.name.replace(/[^\w]/g, '').toLowerCase(),
                licenseKey || 'DEMO',
                userData.expiry.replace(/-/g, ''),
                'lms-ai-v2'
            ];
            
            let hash = 0;
            const keyString = components.join('-');
            
            for (let i = 0; i < keyString.length; i++) {
                const char = keyString.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            
            return Math.abs(hash).toString(36).padStart(12, '0').substring(0, 24);
        }

        // Helper function to generate complex encryption key
        function generateComplexEncryptionKey(userData, licenseKey) {
            const keyComponents = [
                userData.name.replace(/\s+/g, '').toLowerCase(),
                userData.expiry.replace(/-/g, ''),
                userData.type || 'STANDARD',
                licenseKey || 'DEMO',
                'lms-ai-secret-v2'
            ];
            
            let combinedKey = keyComponents.join('-');
            
            // Generate hash-like key
            let hash = 0;
            for (let i = 0; i < combinedKey.length; i++) {
                const char = combinedKey.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            
            return Math.abs(hash).toString(36).substring(0, 32);
        }
        function generateDemoScript() {
            return `// Demo LMS AI Assistant Script
console.log('LMS AI Assistant Demo Mode');
alert('LMS AI Assistant loaded successfully!');

// Demo functionality
function showDemoFeatures() {
    const demo = document.createElement('div');
    demo.style.cssText = \`
        position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
        background: #3498db; color: white; padding: 20px; border-radius: 10px;
        z-index: 100000; text-align: center; font-family: Arial, sans-serif;
    \`;
    demo.innerHTML = '<h3>🎯 LMS AI Demo</h3><p>This is a demo version. Get a license for full features!</p>';
    document.body.appendChild(demo);
    
    setTimeout(() => {
        if (demo.parentNode) demo.parentNode.removeChild(demo);
    }, 3000);
}

showDemoFeatures();`;
        }
        // ===== SECRET ADMIN ACCESS =====
        let secretSequence = [];
        const adminCode = ['KeyA', 'KeyD', 'KeyM', 'KeyI', 'KeyN']; // Type "ADMIN"
        
        document.addEventListener('keydown', function(e) {
            // Only track when no input is focused
            if (document.activeElement.tagName !== 'INPUT') {
                secretSequence.push(e.code);
                if (secretSequence.length > adminCode.length) {
                    secretSequence.shift();
                }
                
                if (secretSequence.join(',') === adminCode.join(',')) {
                    showSecretAdminAccess();
                    secretSequence = [];
                }
            }
        });
        
        function showSecretAdminAccess() {
            const secretDiv = document.createElement('div');
            secretDiv.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: linear-gradient(135deg, #2c3e50, #34495e);
                color: white;
                padding: 30px;
                border-radius: 15px;
                box-shadow: 0 20px 40px rgba(0,0,0,0.3);
                z-index: 100000;
                text-align: center;
                font-family: Arial, sans-serif;
                border: 2px solid #3498db;
            `;
            
            secretDiv.innerHTML = `
                <h3 style="margin: 0 0 20px 0; color: #3498db;">🔐 Admin Access Portal</h3>
                <p style="margin: 0 0 20px 0;">Enter admin password:</p>
                <input type="password" id="adminPassword" placeholder="Password" style="padding: 10px; border: none; border-radius: 5px; margin-bottom: 15px; text-align: center;">
                <br>
                <button onclick="checkAdminPassword()" style="background: #3498db; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin-right: 10px;">
                    Enter Admin Panel
                </button>
                <button onclick="this.parentNode.remove()" style="background: #e74c3c; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">
                    Cancel
                </button>
            `;
            
            document.body.appendChild(secretDiv);
            
            // Focus password input
            setTimeout(() => {
                document.getElementById('adminPassword').focus();
            }, 100);
            
            // Allow Enter key
            document.getElementById('adminPassword').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    checkAdminPassword();
                }
            });
        }
        
function checkAdminPassword() {
            const password = document.getElementById('adminPassword').value;
            
            // Get current admin password (check localStorage)
            let correctPassword = 'admin2025'; // Default
            
            // Check system settings first
            const systemSettings = localStorage.getItem('lms_ai_system_settings');
            if (systemSettings) {
                try {
                    const settings = JSON.parse(systemSettings);
                    if (settings.adminPassword) {
                        correctPassword = settings.adminPassword;
                    }
                } catch (e) {
                    console.warn('Could not load system settings');
                }
            }
            
            // Check dedicated password storage
            const storedPassword = localStorage.getItem('lms_ai_admin_password');
            if (storedPassword) {
                correctPassword = storedPassword;
            }
            
            console.log('[DEBUG] Current admin password:', correctPassword);
            
            if (password === correctPassword) {
                window.open('./admin.html', '_blank');
                document.querySelector('[style*="position: fixed"]').remove();
            } else {
                alert('❌ Invalid password! Access denied.');
                document.getElementById('adminPassword').value = '';
                document.getElementById('adminPassword').style.borderColor = '#e74c3c';
                
                setTimeout(() => {
                    document.getElementById('adminPassword').style.borderColor = '';
                }, 2000);
            }
        }

        // Test that functions are loaded
        console.log('LMS AI Assistant loaded successfully!');
        console.log('Database validation: Available');
        console.log('Secret admin access: Type "ADMIN" on page');
        // ===== EMAIL NOTIFICATIONS FOR KEY VALIDATION =====
       // ===== EMAIL NOTIFICATIONS FOR KEY VALIDATION (DEBUG VERSION) =====
        async function sendValidationNotification(keyData, action) {
            try {
                console.log('[EMAIL DEBUG] Starting notification process...');
                console.log('[EMAIL DEBUG] Action:', action);
                console.log('[EMAIL DEBUG] Key data:', keyData);
                
                // Get admin email settings
                const adminSettings = localStorage.getItem('lms_ai_system_settings');
                console.log('[EMAIL DEBUG] Admin settings found:', !!adminSettings);
                
                if (!adminSettings) {
                    console.log('[EMAIL DEBUG] No admin settings found');
                    return;
                }
                
                const settings = JSON.parse(adminSettings);
                console.log('[EMAIL DEBUG] Email service:', settings.emailService);
                console.log('[EMAIL DEBUG] Notification email:', settings.notificationEmail);
                
                if (settings.emailService === 'disabled') {
                    console.log('[EMAIL DEBUG] Email service is disabled');
                    return;
                }
                
                const notificationData = {
                    keyCode: document.getElementById('productKey').value,
                    userName: keyData.name,
                    keyType: keyData.type || 'STANDARD',
                    userAgent: navigator.userAgent.substring(0, 100),
                    timestamp: new Date().toISOString(),
                    action: action
                };
                
                console.log('[EMAIL DEBUG] Notification data:', notificationData);
                
                if (settings.emailService === 'netlify') {
                    console.log('[EMAIL DEBUG] Using Netlify notifications');
                    await sendNetlifyNotification(settings, action, notificationData);
                } else if (settings.emailService === 'emailjs') {
                    console.log('[EMAIL DEBUG] Using EmailJS notifications');
                    await sendEmailJSNotification(settings, action, notificationData);
                }
                
                console.log('[EMAIL DEBUG] Notification sent successfully:', action);
            } catch (error) {
                console.error('[EMAIL DEBUG] Notification failed:', error);
                console.error('[EMAIL DEBUG] Error details:', error.message);
                // Don't show error to user - notifications are background
            }
        }

        async function sendNetlifyNotification(settings, type, data) {
            console.log('[EMAIL DEBUG] Netlify notification starting...');
            
            const formData = new FormData();
            formData.append('form-name', 'contact');
            formData.append('name', 'LMS AI System');
            formData.append('email', settings.notificationEmail);
            formData.append('subject', `LMS AI - ${type}`);
            formData.append('message', formatNotificationMessage(type, data));
            formData.append('timestamp', new Date().toISOString());

            console.log('[EMAIL DEBUG] Sending to:', settings.notificationEmail);
            console.log('[EMAIL DEBUG] Subject:', `LMS AI - ${type}`);

            const response = await fetch('/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: new URLSearchParams(formData)
            });

            console.log('[EMAIL DEBUG] Netlify response status:', response.status);

            if (!response.ok) {
                throw new Error(`Netlify notification failed: ${response.status}`);
            }
            
            console.log('[EMAIL DEBUG] Netlify notification sent successfully');
        }

        async function sendEmailJSNotification(settings, type, data) {
            console.log('[EMAIL DEBUG] EmailJS notification starting...');
            console.log('[EMAIL DEBUG] EmailJS settings check:');
            console.log('  - Public Key:', !!settings.emailjsPublicKey);
            console.log('  - Service ID:', !!settings.emailjsServiceId);
            console.log('  - Template ID:', !!settings.emailjsTemplateId);
            
            if (!settings.emailjsPublicKey || !settings.emailjsServiceId || !settings.emailjsTemplateId) {
                throw new Error('EmailJS not configured properly');
            }

            // Check if EmailJS is available
            if (typeof emailjs === 'undefined') {
                throw new Error('EmailJS library not loaded');
            }

            // Initialize EmailJS
            console.log('[EMAIL DEBUG] Initializing EmailJS...');
            emailjs.init(settings.emailjsPublicKey);

            const templateParams = {
                to_email: settings.notificationEmail,
                subject: `LMS AI - ${type}`,
                message: formatNotificationMessage(type, data),
                timestamp: new Date().toLocaleString(),
                keyCode: data.keyCode || '',
                userName: data.userName || '',
                keyType: data.keyType || ''
            };

            console.log('[EMAIL DEBUG] Template params:', templateParams);
            console.log('[EMAIL DEBUG] Sending EmailJS...');

            const result = await emailjs.send(
                settings.emailjsServiceId,
                settings.emailjsTemplateId,
                templateParams
            );

            console.log('[EMAIL DEBUG] EmailJS result:', result);
        }

        function formatNotificationMessage(type, data) {
            const timestamp = new Date().toLocaleString();
            const userAgent = data.userAgent ? data.userAgent.substring(0, 50) + '...' : 'Unknown';
            
            console.log('[EMAIL DEBUG] Formatting message for type:', type);
            
            switch (type) {
                case 'Key Validation':
                    return `🔑 License Key Validated Successfully!

Key Details:
- Key Code: ${data.keyCode}
- User Name: ${data.userName}
- Key Type: ${data.keyType}
- Validation Time: ${timestamp}

System Info:
- User Agent: ${userAgent}
- Status: ✅ Valid and Active

The user has successfully validated their key and can now access the download page.`;

                case 'Script Download':
                    return `📥 User Downloaded Personalized Script!

Download Details:
- User: ${data.userName}
- Key: ${data.keyCode}
- Key Type: ${data.keyType}
- Download Time: ${timestamp}

System Info:
- User Agent: ${userAgent}
- Script: Personalized and encrypted
- Status: ✅ Download completed successfully

The user has successfully downloaded their personalized LMS AI script.`;

                case 'Invalid Key Attempt':
                    return `⚠️ Invalid Key Validation Attempt

Attempt Details:
- Attempted Key: ${data.keyCode}
- Time: ${timestamp}
- User Agent: ${userAgent}

This could be:
- User typing error
- Expired key
- Deactivated key
- Malicious attempt

Monitor for repeated invalid attempts from same source.`;

                default:
                    return `📬 LMS AI Activity: ${type}\n\nTimestamp: ${timestamp}\nDetails: ${JSON.stringify(data, null, 2)}`;
            }
        }
    </script>
</body>
</html>
