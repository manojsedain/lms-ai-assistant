<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LMS AI - Admin Panel</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 900px;
            margin: 30px auto;
            padding: 20px;
            background: linear-gradient(135deg, #2c3e50, #3498db);
            min-height: 100vh;
        }
        .login-container {
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            text-align: center;
            max-width: 400px;
            margin: 100px auto;
        }
        .admin-container {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            display: none;
        }
        .login-container h1 {
            color: #2c3e50;
            margin-bottom: 30px;
        }
        .login-container input {
            width: 100%;
            padding: 15px;
            border: 2px solid #bdc3c7;
            border-radius: 8px;
            font-size: 16px;
            margin-bottom: 20px;
            text-align: center;
            box-sizing: border-box;
        }
        .login-container input:focus {
            border-color: #3498db;
            outline: none;
        }
        .login-container button {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            width: 100%;
        }
        .login-container button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
        }
        .error-message {
            color: #e74c3c;
            margin-top: 15px;
            font-weight: bold;
        }
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
        }
        .admin-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 2px solid #ecf0f1;
            border-radius: 10px;
            background: #f8f9fa;
        }
        .admin-section h3 {
            margin-top: 0;
            color: #34495e;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #2c3e50;
        }
        input, select {
            width: 100%;
            padding: 12px;
            border: 2px solid #bdc3c7;
            border-radius: 8px;
            font-size: 14px;
            box-sizing: border-box;
            transition: border-color 0.3s;
        }
        input:focus, select:focus {
            border-color: #3498db;
            outline: none;
            box-shadow: 0 0 5px rgba(52, 152, 219, 0.3);
        }
        button {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            margin-right: 10px;
            margin-bottom: 10px;
            transition: all 0.3s;
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
        }
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }
        .btn-success {
            background: linear-gradient(135deg, #27ae60, #229954) !important;
        }
        .btn-danger {
            background: linear-gradient(135deg, #e74c3c, #c0392b) !important;
        }
        .btn-warning {
            background: linear-gradient(135deg, #f39c12, #e67e22) !important;
        }
        .btn-secondary {
            background: linear-gradient(135deg, #95a5a6, #7f8c8d) !important;
        }
        .generated-key {
            background: linear-gradient(135deg, #d5f4e6, #c8e6c9);
            padding: 20px;
            border-radius: 10px;
            margin-top: 15px;
            border-left: 5px solid #27ae60;
            box-shadow: 0 2px 10px rgba(39, 174, 96, 0.2);
        }
        .key-list {
            background: #ffffff;
            padding: 15px;
            border-radius: 10px;
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #ecf0f1;
        }
        .key-item {
            background: linear-gradient(135deg, #ffffff, #f8f9fa);
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            border-left: 4px solid #3498db;
            position: relative;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            transition: all 0.3s;
        }
        .key-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.15);
        }
        .key-item.expired {
            border-left-color: #e74c3c;
            opacity: 0.8;
        }
        .key-item.inactive {
            border-left-color: #f39c12;
            opacity: 0.9;
        }
        .delete-btn, .toggle-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            padding: 5px 10px !important;
            font-size: 12px !important;
            margin: 0 !important;
        }
        .toggle-btn {
            right: 100px;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
            padding: 25px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(231, 76, 60, 0.3);
            transition: transform 0.3s;
        }
        .stat-card:hover {
            transform: translateY(-5px);
        }
        .stat-card.blue {
            background: linear-gradient(135deg, #3498db, #2980b9);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
        }
        .stat-card.green {
            background: linear-gradient(135deg, #27ae60, #229954);
            box-shadow: 0 5px 15px rgba(39, 174, 96, 0.3);
        }
        .stat-card.orange {
            background: linear-gradient(135deg, #f39c12, #e67e22);
            box-shadow: 0 5px 15px rgba(243, 156, 18, 0.3);
        }
        .stat-number {
            font-size: 36px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .stat-label {
            font-size: 14px;
            opacity: 0.9;
        }
        .hidden {
            display: none;
        }
        textarea {
            width: 100%;
            height: 300px;
            padding: 15px;
            border: 2px solid #bdc3c7;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            box-sizing: border-box;
            background: #f8f9fa;
        }
        .success-message {
            background: linear-gradient(135deg, #d5f4e6, #c8e6c9);
            color: #27ae60;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 5px solid #27ae60;
            font-weight: bold;
        }
        .database-status {
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 5px solid #3498db;
            background: linear-gradient(135deg, #e3f2fd, #bbdefb);
        }
        .connection-test {
            display: inline-block;
            padding: 8px 15px;
            background: #3498db;
            color: white;
            border-radius: 5px;
            font-size: 12px;
            margin-left: 10px;
        }
        .loading-spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginContainer" class="login-container">
        <h1>üîê Admin Login</h1>
        <p>Enter password to access admin panel:</p>
        <input type="password" id="loginPassword" placeholder="Enter admin password">
        <button onclick="attemptLogin()">üöÄ Login</button>
        <div id="errorMessage" class="error-message hidden"></div>
    </div>
<!-- Admin Panel (Hidden) -->
    <div id="adminContainer" class="admin-container">
        <h1>üîë LMS AI Assistant - Admin Panel</h1>
        
        <!-- Header Controls -->
        <div style="text-align: right; margin-bottom: 20px; padding: 15px; background: #ecf0f1; border-radius: 8px;">
            <span style="color: #7f8c8d; margin-right: 20px;">üë§ Administrator</span>
            <button onclick="testDatabaseConnection()" class="btn-secondary">üîç Test DB</button>
            <button onclick="logout()" class="btn-danger">üö™ Logout</button>
        </div>
        
        <!-- Database Connection Status -->
        <div class="database-status" id="dbStatus">
            <strong>üóÑÔ∏è Database Status:</strong> 
            <span id="dbStatusText">Checking connection...</span>
            <span class="loading-spinner" id="dbSpinner"></span>
        </div>
        
        <!-- Statistics Dashboard -->
        <div class="admin-section">
            <h3>üìä System Statistics</h3>
            <div class="stats">
                <div class="stat-card blue">
                    <div class="stat-number" id="totalKeys">0</div>
                    <div class="stat-label">Total Keys</div>
                </div>
                <div class="stat-card green">
                    <div class="stat-number" id="activeKeys">0</div>
                    <div class="stat-label">Active Keys</div>
                </div>
                <div class="stat-card red">
                    <div class="stat-number" id="expiredKeys">0</div>
                    <div class="stat-label">Expired Keys</div>
                </div>
                <div class="stat-card orange">
                    <div class="stat-number" id="totalDownloads">0</div>
                    <div class="stat-label">Total Downloads</div>
                </div>
            </div>
        </div>

        <!-- Key Generator -->
        <div class="admin-section">
            <h3>üîë Generate New Key</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <div>
                    <div class="form-group">
                        <label for="userName">üë§ User Name:</label>
                        <input type="text" id="userName" placeholder="Enter full name (e.g., John Smith)">
                    </div>
                    <div class="form-group">
                        <label for="keyDuration">‚è∞ License Duration:</label>
                        <select id="keyDuration">
                            <option value="1">1 Month</option>
                            <option value="3">3 Months</option>
                            <option value="6">6 Months</option>
                            <option value="12" selected>1 Year</option>
                            <option value="24">2 Years</option>
                            <option value="0">Permanent</option>
                        </select>
                    </div>
                </div>
                <div>
                    <div class="form-group">
                        <label for="keyType">üè∑Ô∏è Key Type:</label>
                        <select id="keyType">
                            <option value="STANDARD">Standard User</option>
                            <option value="PREMIUM">Premium User</option>
                            <option value="ADMIN">Admin User</option>
                            <option value="TEST">Test User</option>
                            <option value="STUDENT">Student User</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="userEmail">üìß Email (Optional):</label>
                        <input type="email" id="userEmail" placeholder="user@example.com">
                    </div>
                </div>
            </div>
            
            <div style="margin-top: 20px;">
                <button onclick="generateNewKey()" class="btn-success">üîë Generate Key</button>
                <button onclick="saveKeyToDatabase()" id="saveBtn" class="btn-success" disabled>üíæ Save to Database</button>
                <button onclick="clearKeyForm()" class="btn-secondary">üóëÔ∏è Clear Form</button>
            </div>
            
            <div id="generatedKeyDisplay" class="generated-key hidden">
                <h4>‚úÖ New Key Generated Successfully!</h4>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div>
                        <strong>üîë Key Code:</strong> <span id="newKeyCode" style="font-family: monospace; background: #fff; padding: 5px; border-radius: 3px;"></span><br>
                        <strong>üë§ User Name:</strong> <span id="newKeyName"></span><br>
                        <strong>‚è∞ Expires:</strong> <span id="newKeyExpiry"></span>
                    </div>
                    <div>
                        <strong>üè∑Ô∏è Type:</strong> <span id="newKeyType"></span><br>
                        <strong>üîê Encryption Key:</strong> <small id="newEncryptionKey" style="font-family: monospace; word-break: break-all;"></small>
                    </div>
                </div>
                <button onclick="copyKeyToClipboard()" class="btn-secondary" style="margin-top: 10px;">üìã Copy Key</button>
            </div>
            
            <div id="saveSuccess" class="success-message hidden">
                ‚úÖ Key saved successfully! It will work immediately on the main site.
            </div>
        </div>

        <!-- Key Management -->
        <div class="admin-section">
            <h3>üìã Key Database Management</h3>
            <div style="margin-bottom: 15px;">
                <button onclick="refreshKeyList()" class="btn-success">üîÑ Refresh List</button>
                <button onclick="loadFromDatabase()" class="btn-success">‚òÅÔ∏è Load from Database</button>
                <button onclick="exportDatabase()" class="btn-warning">üì§ Export Database</button>
                <button onclick="showImportSection()" class="btn-secondary">üì• Backup/Restore</button>
                <span style="margin-left: 20px; color: #7f8c8d; font-size: 14px;" id="keyCount">0 keys loaded</span>
            </div>
            
            <div id="keyList" class="key-list">
                <div style="text-align: center; color: #7f8c8d; padding: 40px;">
                    <h4>üîç Loading keys...</h4>
                    <p>Please wait while we fetch the key database.</p>
                </div>
            </div>
        </div>
<!-- Import/Export Section -->
        <div id="importSection" class="admin-section hidden">
            <h3>üì• Database Backup & Restore</h3>
            <p><strong>üìã Instructions:</strong></p>
            <ul>
                <li><strong>Backup:</strong> Copy the JSON content below and save it safely</li>
                <li><strong>Restore:</strong> Paste JSON content and click restore (overwrites current database)</li>
                <li><strong>Database File:</strong> You can also download as a file and upload to your server</li>
            </ul>
            
            <div class="form-group">
                <label for="exportData">üóÑÔ∏è Database JSON Content:</label>
                <textarea id="exportData" placeholder="Database JSON content will appear here..."></textarea>
            </div>
            
            <div style="margin-top: 15px;">
                <button onclick="copyToClipboard()" class="btn-success">üìã Copy to Clipboard</button>
                <button onclick="downloadDatabase()" class="btn-success">üíæ Download File</button>
                <button onclick="restoreFromJson()" class="btn-warning">üì• Restore from JSON</button>
                <button onclick="hideImportSection()" class="btn-secondary">‚ùå Close</button>
            </div>
        </div>

        <!-- System Logs -->
        <div class="admin-section">
            <h3>üìú System Activity Log</h3>
            <div style="margin-bottom: 15px;">
                <button onclick="refreshActivityLog()" class="btn-success">üîÑ Refresh</button>
                <button onclick="clearActivityLog()" class="btn-danger">üóëÔ∏è Clear Log</button>
                <select id="logFilter" onchange="filterActivityLog()" style="margin-left: 10px;">
                    <option value="all">All Activities</option>
                    <option value="validation">Key Validations</option>
                    <option value="creation">Key Creation</option>
                    <option value="download">Downloads</option>
                    <option value="error">Errors</option>
                </select>
            </div>
            
            <div id="activityLog" class="key-list" style="max-height: 250px;">
                <div style="text-align: center; color: #7f8c8d; padding: 20px;">
                    <p>üìä Activity log will appear here...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ===== CONFIGURATION =====
        const ADMIN_PASSWORD = 'admin2025';
        const API_BASE = '/.netlify/functions';
        
        // ===== GLOBAL VARIABLES =====
        let keysDatabase = {};
        let currentGeneratedKey = null;
        let activityLog = [];
        let isDatabaseConnected = false;

        // ===== LOGIN SYSTEM =====
        function attemptLogin() {
            const password = document.getElementById('loginPassword').value;
            const errorDiv = document.getElementById('errorMessage');
            
            if (password === ADMIN_PASSWORD) {
                document.getElementById('loginContainer').style.display = 'none';
                document.getElementById('adminContainer').style.display = 'block';
                initializeAdmin();
                logActivity('admin_login', 'Administrator logged in');
            } else {
                errorDiv.textContent = '‚ùå Invalid password! Access denied.';
                errorDiv.classList.remove('hidden');
                document.getElementById('loginPassword').value = '';
                document.getElementById('loginPassword').style.borderColor = '#e74c3c';
                
                setTimeout(() => {
                    errorDiv.classList.add('hidden');
                    document.getElementById('loginPassword').style.borderColor = '#bdc3c7';
                }, 3000);
                
                logActivity('admin_login_failed', 'Failed login attempt');
            }
        }
        
        function logout() {
            if (confirm('üö™ Are you sure you want to logout?')) {
                document.getElementById('loginContainer').style.display = 'block';
                document.getElementById('adminContainer').style.display = 'none';
                document.getElementById('loginPassword').value = '';
                logActivity('admin_logout', 'Administrator logged out');
            }
        }

        // ===== DATABASE CONNECTION =====
        async function testDatabaseConnection() {
            const statusText = document.getElementById('dbStatusText');
            const spinner = document.getElementById('dbSpinner');
            
            statusText.textContent = 'Testing connection...';
            spinner.style.display = 'inline-block';
            
            try {
                const response = await fetch(`${API_BASE}/list-keys?admin=${ADMIN_PASSWORD}`);
                
                if (response.ok) {
                    const data = await response.json();
                    isDatabaseConnected = true;
                    statusText.textContent = `‚úÖ Connected - ${data.keys ? data.keys.length : 0} keys in database`;
                    statusText.style.color = '#27ae60';
                    logActivity('database_test', 'Database connection successful');
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                isDatabaseConnected = false;
                statusText.textContent = `‚ùå Connection failed - Using local storage`;
                statusText.style.color = '#e74c3c';
                logActivity('database_test_failed', `Database connection failed: ${error.message}`);
            } finally {
                spinner.style.display = 'none';
            }
        }

        // ===== ACTIVITY LOGGING =====
        function logActivity(type, message) {
            const timestamp = new Date().toISOString();
            const logEntry = {
                timestamp: timestamp,
                type: type,
                message: message,
                id: Date.now()
            };
            
            activityLog.unshift(logEntry); // Add to beginning
            
            // Keep only last 100 entries
            if (activityLog.length > 100) {
                activityLog = activityLog.slice(0, 100);
            }
            
            // Store in localStorage
            localStorage.setItem('lms_ai_activity_log', JSON.stringify(activityLog));
            
            console.log(`[${timestamp}] ${type}: ${message}`);
        }

        function refreshActivityLog() {
            const stored = localStorage.getItem('lms_ai_activity_log');
            if (stored) {
                activityLog = JSON.parse(stored);
            }
            
            filterActivityLog();
        }

        function filterActivityLog() {
            const filter = document.getElementById('logFilter').value;
            const logDiv = document.getElementById('activityLog');
            
            let filteredLog = activityLog;
            if (filter !== 'all') {
                filteredLog = activityLog.filter(entry => entry.type.includes(filter));
            }
            
            if (filteredLog.length === 0) {
                logDiv.innerHTML = '<div style="text-align: center; color: #7f8c8d; padding: 20px;"><p>üìä No activities found for this filter.</p></div>';
                return;
            }
            
            logDiv.innerHTML = filteredLog.map(entry => `
                <div class="key-item" style="font-size: 12px;">
                    <strong>${entry.type.toUpperCase()}</strong><br>
                    <small>${new Date(entry.timestamp).toLocaleString()}</small><br>
                    ${entry.message}
                </div>
            `).join('');
        }

        function clearActivityLog() {
            if (confirm('üóëÔ∏è Are you sure you want to clear the activity log?')) {
                activityLog = [];
                localStorage.removeItem('lms_ai_activity_log');
                refreshActivityLog();
                logActivity('log_cleared', 'Activity log cleared by administrator');
            }
        }
// ===== KEY GENERATION =====
        function generateNewKey() {
            const userName = document.getElementById('userName').value.trim();
            const duration = parseInt(document.getElementById('keyDuration').value);
            const keyType = document.getElementById('keyType').value;
            const userEmail = document.getElementById('userEmail').value.trim();

            if (!userName) {
                alert('‚ùå Please enter a user name');
                return;
            }

            // Generate key components
            const namePrefix = userName.toUpperCase().replace(/[^A-Z]/g, '').substring(0, 4).padEnd(4, 'X');
            const year = new Date().getFullYear();
            const random = Math.random().toString(36).substring(2, 8).toUpperCase();
            
            const keyCode = `${namePrefix}-${year}-${random}`;
            
            // Calculate expiry date
            let expiryDate;
            if (duration === 0) {
                expiryDate = "2099-12-31"; // Permanent
            } else {
                const expiry = new Date();
                expiry.setMonth(expiry.getMonth() + duration);
                expiryDate = expiry.toISOString().split('T')[0];
            }

            // Generate encryption key
            const encryptionKey = `${userName.toLowerCase().replace(/\s+/g, '-')}-secret-key-${year}`;

            currentGeneratedKey = {
                keyCode: keyCode,
                userName: userName,
                expiryDate: expiryDate,
                encryptionKey: encryptionKey,
                keyType: keyType,
                userEmail: userEmail,
                createdAt: new Date().toISOString(),
                active: true,
                downloadCount: 0
            };

            // Display generated key
            document.getElementById('newKeyCode').textContent = keyCode;
            document.getElementById('newKeyName').textContent = userName;
            document.getElementById('newKeyExpiry').textContent = expiryDate;
            document.getElementById('newKeyType').textContent = keyType;
            document.getElementById('newEncryptionKey').textContent = encryptionKey.substring(0, 30) + '...';
            document.getElementById('generatedKeyDisplay').classList.remove('hidden');
            document.getElementById('saveSuccess').classList.add('hidden');
            
            // Enable save button
            document.getElementById('saveBtn').disabled = false;
            
            logActivity('key_generated', `Generated key ${keyCode} for ${userName}`);
        }

async function saveKeyToDatabase() {
            if (!currentGeneratedKey) {
                alert('‚ùå Please generate a key first!');
                return;
            }

            const saveBtn = document.getElementById('saveBtn');
            const originalText = saveBtn.textContent;
            saveBtn.disabled = true;
            saveBtn.textContent = 'üíæ Saving...';

            try {
                // Always save to localStorage for immediate use
                const localKeys = JSON.parse(localStorage.getItem('lms_ai_local_keys') || '{}');
                localKeys[currentGeneratedKey.keyCode] = {
                    name: currentGeneratedKey.userName,
                    expiry: currentGeneratedKey.expiryDate,
                    active: currentGeneratedKey.active,
                    encryptionKey: currentGeneratedKey.encryptionKey,
                    type: currentGeneratedKey.keyType,
                    created: currentGeneratedKey.createdAt.split('T')[0],
                    download_count: 0
                };
                localStorage.setItem('lms_ai_local_keys', JSON.stringify(localKeys));
                
                // Also add to current database
                keysDatabase[currentGeneratedKey.keyCode] = localKeys[currentGeneratedKey.keyCode];
                
                // Try database save (but don't fail if it doesn't work)
                try {
                    const response = await fetch(`${API_BASE}/create-key`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            keyCode: currentGeneratedKey.keyCode,
                            userName: currentGeneratedKey.userName,
                            expiryDate: currentGeneratedKey.expiryDate,
                            encryptionKey: currentGeneratedKey.encryptionKey,
                            keyType: currentGeneratedKey.keyType,
                            adminPassword: ADMIN_PASSWORD
                        })
                    });

                    if (response.ok) {
                        document.getElementById('saveSuccess').innerHTML = '‚úÖ Key saved to database and localStorage!';
                        logActivity('key_saved_both', `Key ${currentGeneratedKey.keyCode} saved to both database and localStorage`);
                    } else {
                        throw new Error('Database unavailable');
                    }
                } catch (dbError) {
                    document.getElementById('saveSuccess').innerHTML = '‚úÖ Key saved locally! (Will work immediately on main site)';
                    logActivity('key_saved_local_only', `Key ${currentGeneratedKey.keyCode} saved to localStorage only`);
                }
                
                document.getElementById('saveSuccess').classList.remove('hidden');
                
            } catch (error) {
                console.error('Save failed:', error);
                alert('‚ùå Failed to save key: ' + error.message);
                logActivity('key_save_failed', `Failed to save key: ${error.message}`);
            } finally {
                saveBtn.disabled = false;
                saveBtn.textContent = originalText;
                refreshKeyList();
                updateStatistics();
            }
        }
       function clearKeyForm() {
            document.getElementById('userName').value = '';
            document.getElementById('userEmail').value = '';
            document.getElementById('keyDuration').value = '12';
            document.getElementById('keyType').value = 'STANDARD';
            document.getElementById('generatedKeyDisplay').classList.add('hidden');
            document.getElementById('saveSuccess').classList.add('hidden');
            document.getElementById('saveBtn').disabled = true;
            currentGeneratedKey = null;
        }

        function copyKeyToClipboard() {
            if (currentGeneratedKey) {
                navigator.clipboard.writeText(currentGeneratedKey.keyCode).then(() => {
                    alert('üìã Key copied to clipboard!');
                }).catch(() => {
                    // Fallback for older browsers
                    const textArea = document.createElement('textarea');
                    textArea.value = currentGeneratedKey.keyCode;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    alert('üìã Key copied to clipboard!');
                });
            }
        }

        // ===== KEY MANAGEMENT =====
        async function loadFromDatabase() {
            try {
                const response = await fetch(`${API_BASE}/list-keys?admin=${ADMIN_PASSWORD}`);
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.success && result.keys) {
                        keysDatabase = {};
                        result.keys.forEach(key => {
                            keysDatabase[key.key_code] = {
                                name: key.user_name,
                                expiry: key.expiry_date.split('T')[0],
                                active: key.active,
                                encryptionKey: key.encryption_key || 'legacy-key',
                                type: key.key_type || 'STANDARD',
                                created: key.created_at ? key.created_at.split('T')[0] : 'Unknown',
                                last_used: key.last_used,
                                download_count: key.download_count || 0
                            };
                        });
                        
                        logActivity('keys_loaded_db', `Loaded ${result.keys.length} keys from database`);
                        refreshKeyList();
                        updateStatistics();
                        return;
                    }
                }
                throw new Error('Database load failed');
                
            } catch (error) {
                console.warn('Database load failed, using localStorage:', error);
                loadFromLocalStorage();
            }
        }

        function loadFromLocalStorage() {
            const localKeys = JSON.parse(localStorage.getItem('lms_ai_local_keys') || '{}');
            keysDatabase = { ...localKeys };
            logActivity('keys_loaded_local', `Loaded ${Object.keys(keysDatabase).length} keys from localStorage`);
            refreshKeyList();
            updateStatistics();
        }

        function refreshKeyList() {
            const keyListDiv = document.getElementById('keyList');
            const keyCount = Object.keys(keysDatabase).length;
            
            document.getElementById('keyCount').textContent = `${keyCount} keys loaded`;

            if (keyCount === 0) {
                keyListDiv.innerHTML = `
                    <div style="text-align: center; color: #7f8c8d; padding: 40px;">
                        <h4>üì≠ No keys found</h4>
                        <p>Generate some keys to get started, or load from database.</p>
                        <button onclick="loadFromDatabase()" class="btn-success">‚òÅÔ∏è Try Loading from Database</button>
                    </div>
                `;
                return;
            }

            const sortedKeys = Object.entries(keysDatabase).sort((a, b) => {
                const dateA = new Date(a[1].created || '2025-01-01');
                const dateB = new Date(b[1].created || '2025-01-01');
                return dateB - dateA; // Newest first
            });

            keyListDiv.innerHTML = sortedKeys.map(([keyCode, keyData]) => {
                const isExpired = new Date() > new Date(keyData.expiry);
                const isActive = keyData.active;
                
                let statusClass = '';
                let statusIcon = '';
                let statusText = '';
                
                if (isExpired) {
                    statusClass = 'expired';
                    statusIcon = 'üî¥';
                    statusText = 'EXPIRED';
                } else if (!isActive) {
                    statusClass = 'inactive';
                    statusIcon = 'üü°';
                    statusText = 'INACTIVE';
                } else {
                    statusIcon = 'üü¢';
                    statusText = 'ACTIVE';
                }
                
                const lastUsed = keyData.last_used ? 
                    new Date(keyData.last_used).toLocaleDateString() : 'Never';
                
                return `
                    <div class="key-item ${statusClass}">
                        <div style="margin-right: 200px;">
                            <strong>üë§ ${keyData.name}</strong> 
                            <span style="background: #ecf0f1; padding: 2px 8px; border-radius: 3px; font-size: 11px; margin-left: 10px;">
                                ${keyData.type || 'STANDARD'}
                            </span><br>
                            <small><strong>üîë Key:</strong> <code>${keyCode}</code></small><br>
                            <small><strong>‚è∞ Expires:</strong> ${keyData.expiry} | <strong>üìÖ Created:</strong> ${keyData.created || 'Unknown'}</small><br>
                            <small><strong>üìä Status:</strong> ${statusIcon} ${statusText} | <strong>üì• Downloads:</strong> ${keyData.download_count || 0} | <strong>üïí Last Used:</strong> ${lastUsed}</small>
                        </div>
                        
                        <button onclick="toggleKeyStatus('${keyCode}')" class="toggle-btn btn-warning">
                            ${isActive ? 'üîí Deactivate' : 'üîì Activate'}
                        </button>
                        <button onclick="deleteKey('${keyCode}')" class="delete-btn btn-danger">
                            üóëÔ∏è Delete
                        </button>
                    </div>
                `;
            }).join('');
        }

        async function toggleKeyStatus(keyCode) {
            const keyData = keysDatabase[keyCode];
            if (!keyData) return;
            
            const newStatus = !keyData.active;
            
            try {
                // Try to update in database first
                const response = await fetch(`${API_BASE}/update-key`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        keyCode: keyCode,
                        active: newStatus,
                        adminPassword: ADMIN_PASSWORD
                    })
                });
                
                if (!response.ok) {
                    throw new Error('Database update failed');
                }
            } catch (error) {
                console.warn('Database update failed, updating locally only');
            }
            
            // Update locally
            keyData.active = newStatus;
            
            // Update localStorage
            const localKeys = JSON.parse(localStorage.getItem('lms_ai_local_keys') || '{}');
            if (localKeys[keyCode]) {
                localKeys[keyCode].active = newStatus;
                localStorage.setItem('lms_ai_local_keys', JSON.stringify(localKeys));
            }
            
            const status = newStatus ? 'activated' : 'deactivated';
            logActivity('key_status_changed', `Key ${keyCode} ${status}`);
            
            refreshKeyList();
            updateStatistics();
            alert(`‚úÖ Key ${keyCode} has been ${status}`);
        }

        async function deleteKey(keyCode) {
            if (!confirm(`‚ö†Ô∏è Are you sure you want to delete key ${keyCode}?\n\nThis action cannot be undone and will immediately invalidate the key.`)) {
                return;
            }

            try {
                // Try to delete from database first
                const response = await fetch(`${API_BASE}/delete-key`, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        keyCode: keyCode,
                        adminPassword: ADMIN_PASSWORD
                    })
                });
                
                if (!response.ok) {
                    throw new Error('Database delete failed');
                }
            } catch (error) {
                console.warn('Database delete failed, deleting locally only');
            }
            
            // Delete locally
            delete keysDatabase[keyCode];
            
            // Delete from localStorage
            const localKeys = JSON.parse(localStorage.getItem('lms_ai_local_keys') || '{}');
            delete localKeys[keyCode];
            localStorage.setItem('lms_ai_local_keys', JSON.stringify(localKeys));
            
            logActivity('key_deleted', `Key ${keyCode} deleted permanently`);
            
            refreshKeyList();
            updateStatistics();
            alert(`‚úÖ Key ${keyCode} has been deleted permanently`);
        }

        // ===== STATISTICS =====
        function updateStatistics() {
            const keys = Object.values(keysDatabase);
            const now = new Date();
            
            const totalKeys = keys.length;
            const activeKeys = keys.filter(k => k.active && new Date(k.expiry) > now).length;
            const expiredKeys = keys.filter(k => new Date(k.expiry) <= now).length;
            const totalDownloads = keys.reduce((sum, k) => sum + (k.download_count || 0), 0);
            
            document.getElementById('totalKeys').textContent = totalKeys;
            document.getElementById('activeKeys').textContent = activeKeys;
            document.getElementById('expiredKeys').textContent = expiredKeys;
            document.getElementById('totalDownloads').textContent = totalDownloads;
        }

        // ===== IMPORT/EXPORT =====
        function exportDatabase() {
            const exportData = {
                keys: keysDatabase,
                exported_at: new Date().toISOString(),
                version: "1.0",
                total_keys: Object.keys(keysDatabase).length
            };
            
            const jsonString = JSON.stringify(exportData, null, 2);
            document.getElementById('exportData').value = jsonString;
            showImportSection();
            
            logActivity('database_exported', `Exported ${Object.keys(keysDatabase).length} keys`);
        }

        function showImportSection() {
            document.getElementById('importSection').classList.remove('hidden');
            if (!document.getElementById('exportData').value) {
                exportDatabase();
            }
        }

        function hideImportSection() {
            document.getElementById('importSection').classList.add('hidden');
        }

        function copyToClipboard() {
            const exportData = document.getElementById('exportData');
            exportData.select();
            navigator.clipboard.writeText(exportData.value).then(() => {
                alert('‚úÖ Database JSON copied to clipboard!\n\nYou can save this as a backup file.');
            }).catch(() => {
                document.execCommand('copy');
                alert('‚úÖ Database JSON copied to clipboard!');
            });
        }

        function downloadDatabase() {
            const content = document.getElementById('exportData').value;
            const blob = new Blob([content], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `lms-ai-database-backup-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            alert('‚úÖ Database backup downloaded!\n\nKeep this file safe for restore purposes.');
            logActivity('database_downloaded', 'Database backup file downloaded');
        }

        function restoreFromJson() {
            const jsonContent = document.getElementById('exportData').value.trim();
            
            if (!jsonContent) {
                alert('‚ùå Please paste JSON content first!');
                return;
            }
            
            if (!confirm('‚ö†Ô∏è This will overwrite your current database!\n\nAre you sure you want to restore from this backup?')) {
                return;
            }
            
            try {
                const data = JSON.parse(jsonContent);
                
                if (data.keys && typeof data.keys === 'object') {
                    keysDatabase = data.keys;
                    localStorage.setItem('lms_ai_local_keys', JSON.stringify(data.keys));
                    
                    refreshKeyList();
                    updateStatistics();
                    
                    alert(`‚úÖ Database restored successfully!\n\nRestored ${Object.keys(data.keys).length} keys.`);
                    logActivity('database_restored', `Restored ${Object.keys(data.keys).length} keys from backup`);
                    
                    hideImportSection();
                } else {
                    throw new Error('Invalid backup format');
                }
                
            } catch (error) {
                alert(`‚ùå Restore failed!\n\nError: ${error.message}\n\nPlease check the JSON format.`);
                logActivity('database_restore_failed', `Restore failed: ${error.message}`);
            }
        }

        // ===== INITIALIZATION =====
        function initializeAdmin() {
            // Test database connection
            testDatabaseConnection();
            
            // Load activity log
            refreshActivityLog();
            
            // Try to load keys from database, fallback to localStorage
            loadFromDatabase();
            
            // Set up auto-refresh every 5 minutes
            setInterval(() => {
                if (isDatabaseConnected) {
                    loadFromDatabase();
                }
            }, 5 * 60 * 1000);
            
            console.log('Admin panel initialized successfully');
            logActivity('admin_initialized', 'Admin panel loaded and initialized');
        }

        // ===== EVENT LISTENERS =====
        document.addEventListener('DOMContentLoaded', function() {
            // Allow Enter key on login
            document.getElementById('loginPassword').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    attemptLogin();
                }
            });
            
            // Allow Enter key on user name field to generate key
            document.addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && e.target.id === 'userName') {
                    generateNewKey();
                }
            });
        });

        // ===== UTILITY FUNCTIONS =====
        function formatDate(dateString) {
            return new Date(dateString).toLocaleDateString();
        }

        function formatTimestamp(timestamp) {
            return new Date(timestamp).toLocaleString();
        }

        // Initialize on load
        console.log('LMS AI Admin Panel loaded successfully!');
        console.log('Database integration: Enabled');
        console.log('Local storage fallback: Enabled');
    </script>
</body>
</html>