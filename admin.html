<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LMS AI - Admin Panel</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 900px;
            margin: 30px auto;
            padding: 20px;
            background: linear-gradient(135deg, #2c3e50, #3498db);
            min-height: 100vh;
        }
        .login-container {
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            text-align: center;
            max-width: 400px;
            margin: 100px auto;
        }
        .admin-container {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            display: none;
        }
        .login-container h1 {
            color: #2c3e50;
            margin-bottom: 30px;
        }
        .login-container input {
            width: 100%;
            padding: 15px;
            border: 2px solid #bdc3c7;
            border-radius: 8px;
            font-size: 16px;
            margin-bottom: 20px;
            text-align: center;
            box-sizing: border-box;
        }
        .login-container input:focus {
            border-color: #3498db;
            outline: none;
        }
        .login-container button {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            width: 100%;
        }
        .login-container button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
        }
        .error-message {
            color: #e74c3c;
            margin-top: 15px;
            font-weight: bold;
        }
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
        }
        .admin-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 2px solid #ecf0f1;
            border-radius: 10px;
            background: #f8f9fa;
        }
        .admin-section h3 {
            margin-top: 0;
            color: #34495e;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #2c3e50;
        }
        input, select {
            width: 100%;
            padding: 12px;
            border: 2px solid #bdc3c7;
            border-radius: 8px;
            font-size: 14px;
            box-sizing: border-box;
            transition: border-color 0.3s;
        }
        input:focus, select:focus {
            border-color: #3498db;
            outline: none;
            box-shadow: 0 0 5px rgba(52, 152, 219, 0.3);
        }
        button {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            margin-right: 10px;
            margin-bottom: 10px;
            transition: all 0.3s;
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
        }
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }
        .btn-success {
            background: linear-gradient(135deg, #27ae60, #229954) !important;
        }
        .btn-danger {
            background: linear-gradient(135deg, #e74c3c, #c0392b) !important;
        }
        .btn-warning {
            background: linear-gradient(135deg, #f39c12, #e67e22) !important;
        }
        .btn-secondary {
            background: linear-gradient(135deg, #95a5a6, #7f8c8d) !important;
        }
        .generated-key {
            background: linear-gradient(135deg, #d5f4e6, #c8e6c9);
            padding: 20px;
            border-radius: 10px;
            margin-top: 15px;
            border-left: 5px solid #27ae60;
            box-shadow: 0 2px 10px rgba(39, 174, 96, 0.2);
        }
        .key-list {
            background: #ffffff;
            padding: 15px;
            border-radius: 10px;
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #ecf0f1;
        }
        .key-item {
            background: linear-gradient(135deg, #ffffff, #f8f9fa);
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            border-left: 4px solid #3498db;
            position: relative;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            transition: all 0.3s;
        }
        .key-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.15);
        }
        .key-item.expired {
            border-left-color: #e74c3c;
            opacity: 0.8;
        }
        .key-item.inactive {
            border-left-color: #f39c12;
            opacity: 0.9;
        }
        .delete-btn, .toggle-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            padding: 5px 10px !important;
            font-size: 12px !important;
            margin: 0 !important;
        }
        .toggle-btn {
            right: 100px;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
            padding: 25px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(231, 76, 60, 0.3);
            transition: transform 0.3s;
        }
        .stat-card:hover {
            transform: translateY(-5px);
        }
        .stat-card.blue {
            background: linear-gradient(135deg, #3498db, #2980b9);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
        }
        .stat-card.green {
            background: linear-gradient(135deg, #27ae60, #229954);
            box-shadow: 0 5px 15px rgba(39, 174, 96, 0.3);
        }
        .stat-card.orange {
            background: linear-gradient(135deg, #f39c12, #e67e22);
            box-shadow: 0 5px 15px rgba(243, 156, 18, 0.3);
        }
        .stat-number {
            font-size: 36px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .stat-label {
            font-size: 14px;
            opacity: 0.9;
        }
        .hidden {
            display: none;
        }
        textarea {
            width: 100%;
            height: 300px;
            padding: 15px;
            border: 2px solid #bdc3c7;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            box-sizing: border-box;
            background: #f8f9fa;
        }
        .success-message {
            background: linear-gradient(135deg, #d5f4e6, #c8e6c9);
            color: #27ae60;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 5px solid #27ae60;
            font-weight: bold;
        }
        .database-status {
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 5px solid #3498db;
            background: linear-gradient(135deg, #e3f2fd, #bbdefb);
        }
        .connection-test {
            display: inline-block;
            padding: 8px 15px;
            background: #3498db;
            color: white;
            border-radius: 5px;
            font-size: 12px;
            margin-left: 10px;
        }
        .loading-spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
    <!-- EmailJS for notifications -->
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginContainer" class="login-container">
        <h1>üîê Admin Login</h1>
        <p>Enter password to access admin panel:</p>
        <input type="password" id="loginPassword" placeholder="Enter admin password">
        <button onclick="attemptLogin()">üöÄ Login</button>
        <div id="errorMessage" class="error-message hidden"></div>
    </div>
<!-- Admin Panel (Hidden) -->
    <div id="adminContainer" class="admin-container">
        <h1>üîë LMS AI Assistant - Admin Panel</h1>
        <!-- Admin Settings -->
        <div class="admin-section">
            <h3>‚öôÔ∏è System Settings</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
                <div>
                    <h4>üîê Security Settings</h4>
                    <div class="form-group">
                        <label for="newAdminPassword">New Admin Password:</label>
                        <input type="password" id="newAdminPassword" placeholder="Enter new password">
                    </div>
                    <button onclick="changeAdminPassword()" class="btn-warning">üîë Update Password</button>
                    
                    <h4 style="margin-top: 20px;">üìß Email Settings</h4>
                    <div class="form-group">
                        <label for="notificationEmail">Notification Email:</label>
                        <input type="email" id="notificationEmail" placeholder="admin@yoursite.com">
                    </div>
                    <div class="form-group">
                        <label for="emailService">Email Service:</label>
                        <select id="emailService">
                            <option value="disabled">Disabled</option>
                            <option value="emailjs">EmailJS (Free)</option>
                            <option value="netlify">Netlify Forms</option>
                        </select>
                    </div>
                    <button onclick="saveEmailSettings()" class="btn-success">üíæ Save Email Settings</button>
                </div>
                
                <div>
                    <h4>üí≥ Payment Settings</h4>
                    <div class="form-group">
                        <label for="paypalClientId">PayPal Client ID:</label>
                        <input type="text" id="paypalClientId" placeholder="Your PayPal client ID">
                    </div>
                    <div class="form-group">
                        <label for="paypalEnvironment">PayPal Environment:</label>
                        <select id="paypalEnvironment">
                            <option value="sandbox">Sandbox (Testing)</option>
                            <option value="production">Production (Live)</option>
                        </select>
                    </div>
                    <button onclick="savePayPalSettings()" class="btn-success">üíæ Save PayPal Settings</button>
                    
                    <h4 style="margin-top: 20px;">üí∞ Pricing</h4>
                    <div class="form-group">
                        <label for="keyPrice">Price per Key (USD):</label>
                        <input type="number" id="keyPrice" placeholder="29.99" step="0.01">
                    </div>
                    <button onclick="savePricingSettings()" class="btn-success">üíæ Save Pricing</button>
                </div>
            </div>
        </div>

        <!-- Bulk Key Generation -->
        <div class="admin-section">
            <h3>üì¶ Bulk Key Generation</h3>
            <p>Generate multiple keys at once for bulk distribution.</p>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px;">
                <div>
                    <div class="form-group">
                        <label for="bulkCount">Number of Keys:</label>
                        <input type="number" id="bulkCount" min="1" max="1000" value="10" placeholder="10">
                    </div>
                    <div class="form-group">
                        <label for="bulkPrefix">Name Prefix:</label>
                        <input type="text" id="bulkPrefix" value="User" placeholder="User, Student, Trial">
                    </div>
                </div>
                <div>
                    <div class="form-group">
                        <label for="bulkDuration">Duration (All Keys):</label>
                        <select id="bulkDuration">
                            <option value="1">1 Month</option>
                            <option value="3">3 Months</option>
                            <option value="6">6 Months</option>
                            <option value="12" selected>1 Year</option>
                            <option value="24">2 Years</option>
                            <option value="0">Permanent</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="bulkType">Key Type (All Keys):</label>
                        <select id="bulkType">
                            <option value="STANDARD">Standard</option>
                            <option value="PREMIUM">Premium</option>
                            <option value="STUDENT">Student</option>
                            <option value="TRIAL">Trial</option>
                            <option value="BULK">Bulk</option>
                        </select>
                    </div>
                </div>
                <div>
                    <div class="form-group">
                        <label for="bulkStartNumber">Start Number:</label>
                        <input type="number" id="bulkStartNumber" value="1" min="1" placeholder="1">
                    </div>
                    <div class="form-group">
                        <label for="bulkPadding">Number Padding:</label>
                        <select id="bulkPadding">
                            <option value="1">1 (User1, User2)</option>
                            <option value="2">2 (User01, User02)</option>
                            <option value="3" selected>3 (User001, User002)</option>
                            <option value="4">4 (User0001, User0002)</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <div style="margin-top: 20px;">
                <button onclick="generateBulkKeys()" class="btn-success">üì¶ Generate Bulk Keys</button>
                <button onclick="exportBulkKeys()" class="btn-warning" id="exportBulkBtn" disabled>üì§ Export as CSV</button>
                <button onclick="clearBulkKeys()" class="btn-danger">üóëÔ∏è Clear Bulk</button>
            </div>
            
            <div id="bulkKeysList" class="key-list hidden" style="max-height: 300px;">
                <!-- Bulk keys will appear here -->
            </div>
        </div>
        
        <!-- Header Controls -->
        <div style="text-align: right; margin-bottom: 20px; padding: 15px; background: #ecf0f1; border-radius: 8px;">
            <span style="color: #7f8c8d; margin-right: 20px;">üë§ Administrator</span>
            <button onclick="testDatabaseConnection()" class="btn-secondary">üîç Test DB</button>
            <button onclick="logout()" class="btn-danger">üö™ Logout</button>
        </div>
        
        <!-- Database Connection Status -->
        <div class="database-status" id="dbStatus">
            <strong>üóÑÔ∏è Database Status:</strong> 
            <span id="dbStatusText">Checking connection...</span>
            <span class="loading-spinner" id="dbSpinner"></span>
        </div>
        
        <!-- Statistics Dashboard -->
        <div class="admin-section">
            <h3>üìä System Statistics</h3>
            <div class="stats">
                <div class="stat-card blue">
                    <div class="stat-number" id="totalKeys">0</div>
                    <div class="stat-label">Total Keys</div>
                </div>
                <div class="stat-card green">
                    <div class="stat-number" id="activeKeys">0</div>
                    <div class="stat-label">Active Keys</div>
                </div>
                <div class="stat-card red">
                    <div class="stat-number" id="expiredKeys">0</div>
                    <div class="stat-label">Expired Keys</div>
                </div>
                <div class="stat-card orange">
                    <div class="stat-number" id="totalDownloads">0</div>
                    <div class="stat-label">Total Downloads</div>
                </div>
            </div>
        </div>

        <!-- Key Generator -->
        <div class="admin-section">
            <h3>üîë Generate New Key</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <div>
                    <div class="form-group">
                        <label for="userName">üë§ User Name:</label>
                        <input type="text" id="userName" placeholder="Enter full name (e.g., John Smith)">
                    </div>
                    <div class="form-group">
                        <label for="keyDuration">‚è∞ License Duration:</label>
                        <select id="keyDuration">
                            <option value="1">1 Month</option>
                            <option value="3">3 Months</option>
                            <option value="6">6 Months</option>
                            <option value="12" selected>1 Year</option>
                            <option value="24">2 Years</option>
                            <option value="0">Permanent</option>
                        </select>
                    </div>
                </div>
                <div>
                    <div class="form-group">
                        <label for="keyType">üè∑Ô∏è Key Type:</label>
                        <select id="keyType">
                            <option value="STANDARD">Standard User</option>
                            <option value="PREMIUM">Premium User</option>
                            <option value="ADMIN">Admin User</option>
                            <option value="TEST">Test User</option>
                            <option value="STUDENT">Student User</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="userEmail">üìß Email (Optional):</label>
                        <input type="email" id="userEmail" placeholder="user@example.com">
                    </div>
                </div>
            </div>
            
            <div style="margin-top: 20px;">
                <button onclick="generateNewKey()" class="btn-success">üîë Generate Key</button>
                <button onclick="saveKeyToDatabase()" id="saveBtn" class="btn-success" disabled>üíæ Save to Database</button>
                <button onclick="clearKeyForm()" class="btn-secondary">üóëÔ∏è Clear Form</button>
            </div>
            
            <div id="generatedKeyDisplay" class="generated-key hidden">
                <h4>‚úÖ New Key Generated Successfully!</h4>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div>
                        <strong>üîë Key Code:</strong> <span id="newKeyCode" style="font-family: monospace; background: #fff; padding: 5px; border-radius: 3px;"></span><br>
                        <strong>üë§ User Name:</strong> <span id="newKeyName"></span><br>
                        <strong>‚è∞ Expires:</strong> <span id="newKeyExpiry"></span>
                    </div>
                    <div>
                        <strong>üè∑Ô∏è Type:</strong> <span id="newKeyType"></span><br>
                        <strong>üîê Encryption Key:</strong> <small id="newEncryptionKey" style="font-family: monospace; word-break: break-all;"></small>
                    </div>
                </div>
                <button onclick="copyKeyToClipboard()" class="btn-secondary" style="margin-top: 10px;">üìã Copy Key</button>
            </div>
            
            <div id="saveSuccess" class="success-message hidden">
                ‚úÖ Key saved successfully! It will work immediately on the main site.
            </div>
        </div>

        <!-- Key Management -->
        <div class="admin-section">
            <h3>üìã Key Database Management</h3>
            <div style="margin-bottom: 15px;">
                <button onclick="refreshKeyList()" class="btn-success">üîÑ Refresh List</button>
                <button onclick="loadFromDatabase()" class="btn-success">‚òÅÔ∏è Load from Database</button>
                <button onclick="exportDatabase()" class="btn-warning">üì§ Export Database</button>
                <button onclick="showImportSection()" class="btn-secondary">üì• Backup/Restore</button>
                <span style="margin-left: 20px; color: #7f8c8d; font-size: 14px;" id="keyCount">0 keys loaded</span>
            </div>
            
            <div id="keyList" class="key-list">
                <div style="text-align: center; color: #7f8c8d; padding: 40px;">
                    <h4>üîç Loading keys...</h4>
                    <p>Please wait while we fetch the key database.</p>
                </div>
            </div>
        </div>
<!-- Import/Export Section -->
        <div id="importSection" class="admin-section hidden">
            <h3>üì• Database Backup & Restore</h3>
            <p><strong>üìã Instructions:</strong></p>
            <ul>
                <li><strong>Backup:</strong> Copy the JSON content below and save it safely</li>
                <li><strong>Restore:</strong> Paste JSON content and click restore (overwrites current database)</li>
                <li><strong>Database File:</strong> You can also download as a file and upload to your server</li>
            </ul>
            
            <div class="form-group">
                <label for="exportData">üóÑÔ∏è Database JSON Content:</label>
                <textarea id="exportData" placeholder="Database JSON content will appear here..."></textarea>
            </div>
            
            <div style="margin-top: 15px;">
                <button onclick="copyToClipboard()" class="btn-success">üìã Copy to Clipboard</button>
                <button onclick="downloadDatabase()" class="btn-success">üíæ Download File</button>
                <button onclick="restoreFromJson()" class="btn-warning">üì• Restore from JSON</button>
                <button onclick="hideImportSection()" class="btn-secondary">‚ùå Close</button>
            </div>
        </div>

        <!-- System Logs -->
        <div class="admin-section">
            <h3>üìú System Activity Log</h3>
            <div style="margin-bottom: 15px;">
                <button onclick="refreshActivityLog()" class="btn-success">üîÑ Refresh</button>
                <button onclick="clearActivityLog()" class="btn-danger">üóëÔ∏è Clear Log</button>
                <select id="logFilter" onchange="filterActivityLog()" style="margin-left: 10px;">
                    <option value="all">All Activities</option>
                    <option value="validation">Key Validations</option>
                    <option value="creation">Key Creation</option>
                    <option value="download">Downloads</option>
                    <option value="error">Errors</option>
                </select>
            </div>
            
            <div id="activityLog" class="key-list" style="max-height: 250px;">
                <div style="text-align: center; color: #7f8c8d; padding: 20px;">
                    <p>üìä Activity log will appear here...</p>
                </div>
            </div>
        </div>
    </div>

  <script>
        // ===== CONFIGURATION =====
        const API_BASE = '/.netlify/functions';
        
        // ===== GLOBAL VARIABLES =====
        let keysDatabase = {};
        let currentGeneratedKey = null;
        let activityLog = [];
        let isDatabaseConnected = false;
        let bulkGeneratedKeys = [];

        // ===== SYSTEM SETTINGS =====
        let systemSettings = {
            adminPassword: 'admin2025',
            notificationEmail: '',
            emailService: 'disabled',
            paypalClientId: '',
            paypalEnvironment: 'sandbox',
            keyPrice: 29.99,
            emailjsPublicKey: '',
            emailjsServiceId: '',
            emailjsTemplateId: ''
        };

        function loadSystemSettings() {
            const stored = localStorage.getItem('lms_ai_system_settings');
            if (stored) {
                try {
                    systemSettings = { ...systemSettings, ...JSON.parse(stored) };
                } catch (e) {
                    console.warn('Could not load system settings');
                }
            }
            
            // Update UI
            if (document.getElementById('notificationEmail')) {
                document.getElementById('notificationEmail').value = systemSettings.notificationEmail;
                document.getElementById('emailService').value = systemSettings.emailService;
                document.getElementById('paypalClientId').value = systemSettings.paypalClientId;
                document.getElementById('paypalEnvironment').value = systemSettings.paypalEnvironment;
                document.getElementById('keyPrice').value = systemSettings.keyPrice;
                document.getElementById('emailjsPublicKey').value = systemSettings.emailjsPublicKey;
                document.getElementById('emailjsServiceId').value = systemSettings.emailjsServiceId;
                document.getElementById('emailjsTemplateId').value = systemSettings.emailjsTemplateId;
                
                toggleEmailFields();
            }
        }

        function saveSystemSettings() {
            localStorage.setItem('lms_ai_system_settings', JSON.stringify(systemSettings));
        }

        // ===== LOGIN SYSTEM =====
        function attemptLogin() {
            const password = document.getElementById('loginPassword').value;
            const errorDiv = document.getElementById('errorMessage');
            
            // Load current admin password from settings
            const stored = localStorage.getItem('lms_ai_system_settings');
            let currentPassword = 'admin2025'; // Default
            
            if (stored) {
                try {
                    const settings = JSON.parse(stored);
                    currentPassword = settings.adminPassword || 'admin2025';
                } catch (e) {
                    console.warn('Could not load settings, using default password');
                }
            }
            
            if (password === currentPassword) {
                document.getElementById('loginContainer').style.display = 'none';
                document.getElementById('adminContainer').style.display = 'block';
                initializeAdmin();
                logActivity('admin_login', 'Administrator logged in');
            } else {
                errorDiv.textContent = '‚ùå Invalid password! Access denied.';
                errorDiv.classList.remove('hidden');
                document.getElementById('loginPassword').value = '';
                document.getElementById('loginPassword').style.borderColor = '#e74c3c';
                
                setTimeout(() => {
                    errorDiv.classList.add('hidden');
                    document.getElementById('loginPassword').style.borderColor = '#bdc3c7';
                }, 3000);
                
                logActivity('admin_login_failed', 'Failed login attempt');
            }
        }
        
        function logout() {
            if (confirm('üö™ Are you sure you want to logout?')) {
                document.getElementById('loginContainer').style.display = 'block';
                document.getElementById('adminContainer').style.display = 'none';
                document.getElementById('loginPassword').value = '';
                logActivity('admin_logout', 'Administrator logged out');
            }
        }

        function changeAdminPassword() {
            const newPassword = document.getElementById('newAdminPassword').value.trim();
            
            if (!newPassword) {
                alert('‚ùå Please enter a new password');
                return;
            }
            
            if (newPassword.length < 6) {
                alert('‚ùå Password must be at least 6 characters');
                return;
            }
            
            if (confirm(`üîë Change admin password to: ${newPassword}?\n\nMake sure you remember this password!`)) {
                systemSettings.adminPassword = newPassword;
                saveSystemSettings();
                
                // Also update the main site password
                localStorage.setItem('lms_ai_admin_password', newPassword);
                
                alert('‚úÖ Admin password updated successfully!\n\nNew password: ' + newPassword + '\n\nThis works for both admin panel and main site secret access.');
                document.getElementById('newAdminPassword').value = '';
                
                logActivity('admin_password_changed', 'Admin password updated');
            }
        }

        // ===== ACTIVITY LOGGING =====
        function logActivity(type, message) {
            const timestamp = new Date().toISOString();
            const logEntry = {
                timestamp: timestamp,
                type: type,
                message: message,
                id: Date.now()
            };
            
            activityLog.unshift(logEntry);
            
            if (activityLog.length > 100) {
                activityLog = activityLog.slice(0, 100);
            }
            
            localStorage.setItem('lms_ai_activity_log', JSON.stringify(activityLog));
            console.log(`[${timestamp}] ${type}: ${message}`);
        }

        // ===== EMAIL FUNCTIONS =====
        function toggleEmailFields() {
            const service = document.getElementById('emailService').value;
            const fields = document.getElementById('emailjsFields');
            
            if (fields) {
                if (service === 'emailjs') {
                    fields.classList.remove('hidden');
                } else {
                    fields.classList.add('hidden');
                }
            }
        }

        function saveEmailSettings() {
            systemSettings.notificationEmail = document.getElementById('notificationEmail').value.trim();
            systemSettings.emailService = document.getElementById('emailService').value;
            systemSettings.emailjsPublicKey = document.getElementById('emailjsPublicKey').value.trim();
            systemSettings.emailjsServiceId = document.getElementById('emailjsServiceId').value.trim();
            systemSettings.emailjsTemplateId = document.getElementById('emailjsTemplateId').value.trim();
            
            saveSystemSettings();
            alert('‚úÖ Email settings saved successfully!');
            
            logActivity('email_settings_updated', `Email service: ${systemSettings.emailService}`);
        }

        function savePayPalSettings() {
            systemSettings.paypalClientId = document.getElementById('paypalClientId').value.trim();
            systemSettings.paypalEnvironment = document.getElementById('paypalEnvironment').value;
            
            saveSystemSettings();
            alert('‚úÖ PayPal settings saved successfully!');
            
            logActivity('paypal_settings_updated', `Environment: ${systemSettings.paypalEnvironment}`);
        }

        function savePricingSettings() {
            const price = parseFloat(document.getElementById('keyPrice').value);
            if (isNaN(price) || price < 0) {
                alert('‚ùå Please enter a valid price');
                return;
            }
            
            systemSettings.keyPrice = price;
            saveSystemSettings();
            alert(`‚úÖ Pricing updated: $${price.toFixed(2)} per key`);
            
            logActivity('pricing_updated', `Key price set to $${price.toFixed(2)}`);
        }

        // ===== KEY GENERATION =====
        function generateNewKey() {
            const userName = document.getElementById('userName').value.trim();
            const duration = parseInt(document.getElementById('keyDuration').value);
            const keyType = document.getElementById('keyType').value;
            const userEmail = document.getElementById('userEmail').value.trim();

            if (!userName) {
                alert('‚ùå Please enter a user name');
                return;
            }

            const namePrefix = userName.toUpperCase().replace(/[^A-Z]/g, '').substring(0, 4).padEnd(4, 'X');
            const year = new Date().getFullYear();
            const random = Math.random().toString(36).substring(2, 8).toUpperCase();
            
            const keyCode = `${namePrefix}-${year}-${random}`;
            
            let expiryDate;
            if (duration === 0) {
                expiryDate = "2099-12-31";
            } else {
                const expiry = new Date();
                expiry.setMonth(expiry.getMonth() + duration);
                expiryDate = expiry.toISOString().split('T')[0];
            }

            const encryptionKey = `${userName.toLowerCase().replace(/\s+/g, '-')}-secret-key-${year}`;

            currentGeneratedKey = {
                keyCode: keyCode,
                userName: userName,
                expiryDate: expiryDate,
                encryptionKey: encryptionKey,
                keyType: keyType,
                userEmail: userEmail,
                createdAt: new Date().toISOString(),
                active: true,
                downloadCount: 0
            };

            document.getElementById('newKeyCode').textContent = keyCode;
            document.getElementById('newKeyName').textContent = userName;
            document.getElementById('newKeyExpiry').textContent = expiryDate;
            document.getElementById('newKeyType').textContent = keyType;
            document.getElementById('newEncryptionKey').textContent = encryptionKey.substring(0, 30) + '...';
            document.getElementById('generatedKeyDisplay').classList.remove('hidden');
            document.getElementById('saveSuccess').classList.add('hidden');
            
            document.getElementById('saveBtn').disabled = false;
            
            logActivity('key_generated', `Generated key ${keyCode} for ${userName}`);
        }

        async function saveKeyToDatabase() {
            if (!currentGeneratedKey) {
                alert('‚ùå Please generate a key first!');
                return;
            }

            const saveBtn = document.getElementById('saveBtn');
            const originalText = saveBtn.textContent;
            saveBtn.disabled = true;
            saveBtn.textContent = 'üíæ Saving...';

            try {
                const localKeys = JSON.parse(localStorage.getItem('lms_ai_local_keys') || '{}');
                localKeys[currentGeneratedKey.keyCode] = {
                    name: currentGeneratedKey.userName,
                    expiry: currentGeneratedKey.expiryDate,
                    active: currentGeneratedKey.active,
                    encryptionKey: currentGeneratedKey.encryptionKey,
                    type: currentGeneratedKey.keyType,
                    created: currentGeneratedKey.createdAt.split('T')[0],
                    download_count: 0
                };
                localStorage.setItem('lms_ai_local_keys', JSON.stringify(localKeys));
                
                keysDatabase[currentGeneratedKey.keyCode] = localKeys[currentGeneratedKey.keyCode];
                
                try {
                    const response = await fetch(`${API_BASE}/create-key`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            keyCode: currentGeneratedKey.keyCode,
                            userName: currentGeneratedKey.userName,
                            expiryDate: currentGeneratedKey.expiryDate,
                            encryptionKey: currentGeneratedKey.encryptionKey,
                            keyType: currentGeneratedKey.keyType,
                            adminPassword: systemSettings.adminPassword
                        })
                    });

                    if (response.ok) {
                        document.getElementById('saveSuccess').innerHTML = '‚úÖ Key saved to database and localStorage!';
                        logActivity('key_saved_both', `Key ${currentGeneratedKey.keyCode} saved to both database and localStorage`);
                    } else {
                        throw new Error('Database unavailable');
                    }
                } catch (dbError) {
                    document.getElementById('saveSuccess').innerHTML = '‚úÖ Key saved locally! (Will work immediately on main site)';
                    logActivity('key_saved_local_only', `Key ${currentGeneratedKey.keyCode} saved to localStorage only`);
                }
                
                document.getElementById('saveSuccess').classList.remove('hidden');
                
            } catch (error) {
                console.error('Save failed:', error);
                alert('‚ùå Failed to save key: ' + error.message);
                logActivity('key_save_failed', `Failed to save key: ${error.message}`);
            } finally {
                saveBtn.disabled = false;
                saveBtn.textContent = originalText;
                refreshKeyList();
                updateStatistics();
            }
        }

        function clearKeyForm() {
            document.getElementById('userName').value = '';
            document.getElementById('userEmail').value = '';
            document.getElementById('keyDuration').value = '12';
            document.getElementById('keyType').value = 'STANDARD';
            document.getElementById('generatedKeyDisplay').classList.add('hidden');
            document.getElementById('saveSuccess').classList.add('hidden');
            document.getElementById('saveBtn').disabled = true;
            currentGeneratedKey = null;
        }

        function copyKeyToClipboard() {
            if (currentGeneratedKey) {
                navigator.clipboard.writeText(currentGeneratedKey.keyCode).then(() => {
                    alert('üìã Key copied to clipboard!');
                }).catch(() => {
                    const textArea = document.createElement('textarea');
                    textArea.value = currentGeneratedKey.keyCode;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    alert('üìã Key copied to clipboard!');
                });
            }
        }

        // ===== KEY MANAGEMENT =====
        function refreshKeyList() {
            const keyListDiv = document.getElementById('keyList');
            const localKeys = JSON.parse(localStorage.getItem('lms_ai_local_keys') || '{}');
            const allKeys = { ...localKeys, ...keysDatabase };
            const keyCount = Object.keys(allKeys).length;
            
            document.getElementById('keyCount').textContent = `${keyCount} keys loaded`;

            if (keyCount === 0) {
                keyListDiv.innerHTML = `
                    <div style="text-align: center; color: #7f8c8d; padding: 40px;">
                        <h4>üì≠ No keys found</h4>
                        <p>Generate some keys to get started.</p>
                    </div>
                `;
                return;
            }

            const sortedKeys = Object.entries(allKeys).sort((a, b) => {
                const dateA = new Date(a[1].created || '2025-01-01');
                const dateB = new Date(b[1].created || '2025-01-01');
                return dateB - dateA;
            });

            keyListDiv.innerHTML = sortedKeys.map(([keyCode, keyData]) => {
                const isExpired = new Date() > new Date(keyData.expiry);
                const isActive = keyData.active;
                
                let statusClass = '';
                let statusIcon = '';
                let statusText = '';
                
                if (isExpired) {
                    statusClass = 'expired';
                    statusIcon = 'üî¥';
                    statusText = 'EXPIRED';
                } else if (!isActive) {
                    statusClass = 'inactive';
                    statusIcon = 'üü°';
                    statusText = 'INACTIVE';
                } else {
                    statusIcon = 'üü¢';
                    statusText = 'ACTIVE';
                }
                
                const lastUsed = keyData.last_used ? 
                    new Date(keyData.last_used).toLocaleDateString() : 'Never';
                
                return `
                    <div class="key-item ${statusClass}">
                        <div style="margin-right: 200px;">
                            <strong>üë§ ${keyData.name}</strong> 
                            <span style="background: #ecf0f1; padding: 2px 8px; border-radius: 3px; font-size: 11px; margin-left: 10px;">
                                ${keyData.type || 'STANDARD'}
                            </span><br>
                            <small><strong>üîë Key:</strong> <code>${keyCode}</code></small><br>
                            <small><strong>‚è∞ Expires:</strong> ${keyData.expiry} | <strong>üìÖ Created:</strong> ${keyData.created || 'Unknown'}</small><br>
                            <small><strong>üìä Status:</strong> ${statusIcon} ${statusText} | <strong>üì• Downloads:</strong> ${keyData.download_count || 0} | <strong>üïí Last Used:</strong> ${lastUsed}</small>
                        </div>
                        
                        <button onclick="toggleKeyStatus('${keyCode}')" class="toggle-btn btn-warning">
                            ${isActive ? 'üîí Deactivate' : 'üîì Activate'}
                        </button>
                        <button onclick="deleteKey('${keyCode}')" class="delete-btn btn-danger">
                            üóëÔ∏è Delete
                        </button>
                    </div>
                `;
            }).join('');
        }

        function toggleKeyStatus(keyCode) {
            const localKeys = JSON.parse(localStorage.getItem('lms_ai_local_keys') || '{}');
            if (localKeys[keyCode]) {
                localKeys[keyCode].active = !localKeys[keyCode].active;
                localStorage.setItem('lms_ai_local_keys', JSON.stringify(localKeys));
                
                if (keysDatabase[keyCode]) {
                    keysDatabase[keyCode].active = localKeys[keyCode].active;
                }
                
                refreshKeyList();
                updateStatistics();
                
                const status = localKeys[keyCode].active ? 'activated' : 'deactivated';
                alert(`‚úÖ Key ${keyCode} has been ${status}`);
                logActivity('key_status_changed', `Key ${keyCode} ${status}`);
            }
        }

        function deleteKey(keyCode) {
            if (!confirm(`‚ö†Ô∏è Are you sure you want to delete key ${keyCode}?\n\nThis action cannot be undone.`)) {
                return;
            }

            const localKeys = JSON.parse(localStorage.getItem('lms_ai_local_keys') || '{}');
            delete localKeys[keyCode];
            localStorage.setItem('lms_ai_local_keys', JSON.stringify(localKeys));
            
            delete keysDatabase[keyCode];
            
            refreshKeyList();
            updateStatistics();
            alert(`‚úÖ Key ${keyCode} has been deleted permanently`);
            logActivity('key_deleted', `Key ${keyCode} deleted permanently`);
        }

        // ===== STATISTICS =====
        function updateStatistics() {
            const localKeys = JSON.parse(localStorage.getItem('lms_ai_local_keys') || '{}');
            const allKeys = { ...keysDatabase, ...localKeys };
            const keys = Object.values(allKeys);
            const now = new Date();
            
            const totalKeys = keys.length;
            const activeKeys = keys.filter(k => k.active && new Date(k.expiry) > now).length;
            const expiredKeys = keys.filter(k => new Date(k.expiry) <= now).length;
            const totalDownloads = keys.reduce((sum, k) => sum + (k.download_count || 0), 0);
            
            document.getElementById('totalKeys').textContent = totalKeys;
            document.getElementById('activeKeys').textContent = activeKeys;
            document.getElementById('expiredKeys').textContent = expiredKeys;
            document.getElementById('totalDownloads').textContent = totalDownloads;
        }

        // ===== ACTIVITY LOG =====
        function refreshActivityLog() {
            const stored = localStorage.getItem('lms_ai_activity_log');
            if (stored) {
                activityLog = JSON.parse(stored);
            }
            filterActivityLog();
        }

        function filterActivityLog() {
            const filter = document.getElementById('logFilter').value;
            const logDiv = document.getElementById('activityLog');
            
            let filteredLog = activityLog;
            if (filter !== 'all') {
                filteredLog = activityLog.filter(entry => entry.type.includes(filter));
            }
            
            if (filteredLog.length === 0) {
                logDiv.innerHTML = '<div style="text-align: center; color: #7f8c8d; padding: 20px;"><p>üìä No activities found.</p></div>';
                return;
            }
            
            logDiv.innerHTML = filteredLog.map(entry => `
                <div class="key-item" style="font-size: 12px;">
                    <strong>${entry.type.toUpperCase()}</strong><br>
                    <small>${new Date(entry.timestamp).toLocaleString()}</small><br>
                    ${entry.message}
                </div>
            `).join('');
        }

        function clearActivityLog() {
            if (confirm('üóëÔ∏è Are you sure you want to clear the activity log?')) {
                activityLog = [];
                localStorage.removeItem('lms_ai_activity_log');
                refreshActivityLog();
                logActivity('log_cleared', 'Activity log cleared by administrator');
            }
        }

        // ===== INITIALIZATION =====
        function initializeAdmin() {
            loadSystemSettings();
            refreshActivityLog();
            refreshKeyList();
            updateStatistics();
            
            console.log('Admin panel initialized successfully');
            logActivity('admin_initialized', 'Admin panel loaded and initialized');
        }

        // ===== EVENT LISTENERS =====
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('loginPassword').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    attemptLogin();
                }
            });
        });

        console.log('LMS AI Admin Panel loaded successfully!');
    </script>
</body>
</html>
