<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LMS AI - Admin Panel</title>
    <!-- EmailJS for notifications -->
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 900px;
            margin: 30px auto;
            padding: 20px;
            background: linear-gradient(135deg, #2c3e50, #3498db);
            min-height: 100vh;
        }
        .login-container {
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            text-align: center;
            max-width: 400px;
            margin: 100px auto;
        }
        .admin-container {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            display: none;
        }
        .login-container h1 {
            color: #2c3e50;
            margin-bottom: 30px;
        }
        .login-container input {
            width: 100%;
            padding: 15px;
            border: 2px solid #bdc3c7;
            border-radius: 8px;
            font-size: 16px;
            margin-bottom: 20px;
            text-align: center;
            box-sizing: border-box;
        }
        .login-container input:focus {
            border-color: #3498db;
            outline: none;
        }
        .login-container button {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            width: 100%;
        }
        .login-container button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
        }
        .error-message {
            color: #e74c3c;
            margin-top: 15px;
            font-weight: bold;
        }
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
        }
        .admin-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 2px solid #ecf0f1;
            border-radius: 10px;
            background: #f8f9fa;
        }
        .admin-section h3 {
            margin-top: 0;
            color: #34495e;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #2c3e50;
        }
        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #bdc3c7;
            border-radius: 8px;
            font-size: 14px;
            box-sizing: border-box;
            transition: border-color 0.3s;
        }
        input:focus, select:focus, textarea:focus {
            border-color: #3498db;
            outline: none;
            box-shadow: 0 0 5px rgba(52, 152, 219, 0.3);
        }
        button {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            margin-right: 10px;
            margin-bottom: 10px;
            transition: all 0.3s;
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
        }
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }
        .btn-success {
            background: linear-gradient(135deg, #27ae60, #229954) !important;
        }
        .btn-danger {
            background: linear-gradient(135deg, #e74c3c, #c0392b) !important;
        }
        .btn-warning {
            background: linear-gradient(135deg, #f39c12, #e67e22) !important;
        }
        .btn-secondary {
            background: linear-gradient(135deg, #95a5a6, #7f8c8d) !important;
        }
        .btn-copy {
            background: linear-gradient(135deg, #9b59b6, #8e44ad) !important;
            padding: 5px 10px !important;
            font-size: 12px !important;
            margin: 2px !important;
        }
        .generated-key {
            background: linear-gradient(135deg, #d5f4e6, #c8e6c9);
            padding: 20px;
            border-radius: 10px;
            margin-top: 15px;
            border-left: 5px solid #27ae60;
            box-shadow: 0 2px 10px rgba(39, 174, 96, 0.2);
        }
        .key-list {
            background: #ffffff;
            padding: 15px;
            border-radius: 10px;
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #ecf0f1;
        }
        .key-item {
            background: linear-gradient(135deg, #ffffff, #f8f9fa);
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            border-left: 4px solid #3498db;
            position: relative;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            transition: all 0.3s;
        }
        .key-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.15);
        }
        .key-item.expired {
            border-left-color: #e74c3c;
            opacity: 0.8;
        }
        .key-item.inactive {
            border-left-color: #f39c12;
            opacity: 0.9;
        }
        .delete-btn, .toggle-btn, .copy-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            padding: 5px 10px !important;
            font-size: 12px !important;
            margin: 0 !important;
        }
        .toggle-btn {
            right: 100px;
        }
        .copy-btn {
            right: 200px;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
            padding: 25px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(231, 76, 60, 0.3);
            transition: transform 0.3s;
        }
        .stat-card:hover {
            transform: translateY(-5px);
        }
        .stat-card.blue {
            background: linear-gradient(135deg, #3498db, #2980b9);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
        }
        .stat-card.green {
            background: linear-gradient(135deg, #27ae60, #229954);
            box-shadow: 0 5px 15px rgba(39, 174, 96, 0.3);
        }
        .stat-card.orange {
            background: linear-gradient(135deg, #f39c12, #e67e22);
            box-shadow: 0 5px 15px rgba(243, 156, 18, 0.3);
        }
        .stat-number {
            font-size: 36px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .stat-label {
            font-size: 14px;
            opacity: 0.9;
        }
        .hidden {
            display: none;
        }
        .success-message {
            background: linear-gradient(135deg, #d5f4e6, #c8e6c9);
            color: #27ae60;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 5px solid #27ae60;
            font-weight: bold;
        }
        .database-status {
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 5px solid #3498db;
            background: linear-gradient(135deg, #e3f2fd, #bbdefb);
        }
        .loading-spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* ===== MOBILE RESPONSIVE DESIGN ===== */
        @media (max-width: 768px) {
            body {
                margin: 10px;
                padding: 10px;
            }
            
            .admin-container {
                padding: 15px;
                margin: 0;
            }
            
            .login-container {
                margin: 50px auto;
                padding: 20px;
                max-width: 300px;
            }
            
            h1 {
                font-size: 24px;
                margin-bottom: 20px;
            }
            
            .admin-section {
                padding: 15px;
                margin-bottom: 20px;
            }
            
            .stats {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }
            
            .stat-card {
                padding: 15px;
            }
            
            .stat-number {
                font-size: 24px;
            }
            
            /* Make form inputs stack on mobile */
            .admin-section > div[style*="grid-template-columns"] {
                display: block !important;
            }
            
            .admin-section > div[style*="grid-template-columns"] > div {
                margin-bottom: 20px;
            }
            
            /* Responsive key items */
            .key-item {
                padding: 10px;
                font-size: 12px;
            }
            
            .key-item div[style*="margin-right"] {
                margin-right: 10px !important;
            }
            
            .copy-btn, .toggle-btn, .delete-btn {
                position: static !important;
                margin: 5px 2px !important;
                padding: 4px 8px !important;
                font-size: 10px !important;
            }
            
            /* Mobile-friendly buttons */
            button {
                margin: 5px 2px;
                padding: 10px 15px;
                font-size: 12px;
            }
            
            /* Responsive bulk generation */
            .admin-section div[style*="grid-template-columns: 1fr 1fr 1fr"] {
                display: block !important;
            }
            
            /* Mobile textarea */
            textarea {
                height: 150px !important;
                font-size: 12px;
            }
            
            /* Hide less important elements on mobile */
            .stat-label {
                font-size: 12px;
            }
            
            /* Mobile navigation */
            .admin-section h3 {
                font-size: 16px;
                padding-bottom: 5px;
            }
        }

        /* Tablet responsive */
        @media (max-width: 1024px) and (min-width: 769px) {
            .stats {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .admin-section > div[style*="grid-template-columns: 1fr 1fr"] {
                display: block !important;
            }
        }

        /* Mobile-first improvements */
        .mobile-hidden {
            display: block;
        }
        
        @media (max-width: 768px) {
            .mobile-hidden {
                display: none;
            }
        }

        /* Touch-friendly buttons */
        @media (max-width: 768px) {
            button:hover {
                transform: none; /* Disable hover effects on mobile */
            }
            
            .key-item:hover {
                transform: none;
            }
        }

        /* PWA Support */
        .pwa-install {
            display: none;
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #3498db;
            color: white;
            padding: 15px;
            border-radius: 50px;
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
            cursor: pointer;
            z-index: 1000;
        }
        
        .pwa-install.show {
            display: block;
        }
    </style>
</head>
<body>
    <!-- Hidden Netlify Form for Notifications -->
    <form name="contact" netlify hidden>
        <input type="text" name="name" />
        <input type="email" name="email" />
        <input type="text" name="subject" />
        <input type="text" name="message" />
        <input type="text" name="timestamp" />
    </form>

    <!-- Login Screen -->
    <div id="loginContainer" class="login-container">
        <h1>ğŸ” Admin Login</h1>
        <p>Enter password to access admin panel:</p>
        <input type="password" id="loginPassword" placeholder="Enter admin password">
        <button onclick="attemptLogin()">ğŸš€ Login</button>
        <div id="errorMessage" class="error-message hidden"></div>
    </div>

    <!-- Admin Panel (Hidden) -->
    <div id="adminContainer" class="admin-container">
        <h1>ğŸ”‘ LMS AI Assistant - Admin Panel</h1>
        
        <!-- Header Controls -->
        <div style="text-align: right; margin-bottom: 20px; padding: 15px; background: #ecf0f1; border-radius: 8px;">
            <span style="color: #7f8c8d; margin-right: 20px;">ğŸ‘¤ Administrator</span>
            <button onclick="testDatabaseConnection()" class="btn-secondary">ğŸ” Test DB</button>
            <button onclick="logout()" class="btn-danger">ğŸšª Logout</button>
        </div>
        <!-- Header Controls -->
        <div style="text-align: right; margin-bottom: 20px; padding: 15px; background: #ecf0f1; border-radius: 8px;">
            <span style="color: #7f8c8d; margin-right: 20px;">ğŸ‘¤ Administrator</span>
            <button onclick="testDatabaseConnection()" class="btn-secondary">ğŸ” Test DB</button>
            <button onclick="logout()" class="btn-danger">ğŸšª Logout</button>
        </div>

        <!-- Mobile App Features -->
        <div class="admin-section" style="background: linear-gradient(135deg, #3498db, #2980b9); color: white;">
            <h3 style="color: white; border-bottom: 2px solid rgba(255,255,255,0.3);">ğŸ“± Mobile Admin Features</h3>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                <div style="text-align: center;">
                    <h4 style="margin: 0; color: white;">ğŸ“Š Quick Stats</h4>
                    <p style="margin: 5px 0; font-size: 14px; opacity: 0.9;">View key statistics at a glance</p>
                    <button onclick="showQuickStats()" class="btn-secondary" style="background: rgba(255,255,255,0.2);">View Stats</button>
                </div>
                <div style="text-align: center;">
                    <h4 style="margin: 0; color: white;">ğŸ”‘ Quick Generate</h4>
                    <p style="margin: 5px 0; font-size: 14px; opacity: 0.9;">Generate key with one tap</p>
                    <button onclick="quickGenerateKey()" class="btn-secondary" style="background: rgba(255,255,255,0.2);">Quick Generate</button>
                </div>
                <div style="text-align: center;">
                    <h4 style="margin: 0; color: white;">ğŸ“§ Quick Test</h4>
                    <p style="margin: 5px 0; font-size: 14px; opacity: 0.9;">Test email notifications</p>
                    <button onclick="quickEmailTest()" class="btn-secondary" style="background: rgba(255,255,255,0.2);">Test Email</button>
                </div>
            </div>
            
            <!-- PWA Install Prompt -->
            <div id="pwaPrompt" class="mobile-hidden" style="margin-top: 20px; padding: 15px; background: rgba(255,255,255,0.1); border-radius: 8px; text-align: center;">
                <h4 style="margin: 0 0 10px 0; color: white;">ğŸ“² Install as App</h4>
                <p style="margin: 0 0 15px 0; font-size: 14px; opacity: 0.9;">Add to home screen for quick access</p>
                <button onclick="installPWA()" style="background: rgba(255,255,255,0.2); color: white;">ğŸ“² Install App</button>
            </div>
        </div>
        
        <!-- Database Connection Status -->
        <div class="database-status" id="dbStatus">
            <!-- your existing database status content -->
        </div>
        <!-- Database Connection Status -->
        <div class="database-status" id="dbStatus">
            <strong>ğŸ—„ï¸ Database Status:</strong> 
            <span id="dbStatusText">Checking connection...</span>
            <span class="loading-spinner" id="dbSpinner"></span>
        </div>
        
        <!-- Statistics Dashboard -->
        <div class="admin-section">
            <h3>ğŸ“Š System Statistics</h3>
            <div class="stats">
                <div class="stat-card blue">
                    <div class="stat-number" id="totalKeys">0</div>
                    <div class="stat-label">Total Keys</div>
                </div>
                <div class="stat-card green">
                    <div class="stat-number" id="activeKeys">0</div>
                    <div class="stat-label">Active Keys</div>
                </div>
                <div class="stat-card red">
                    <div class="stat-number" id="expiredKeys">0</div>
                    <div class="stat-label">Expired Keys</div>
                </div>
                <div class="stat-card orange">
                    <div class="stat-number" id="totalDownloads">0</div>
                    <div class="stat-label">Total Downloads</div>
                </div>
            </div>
        </div>
<!-- Key Generator -->
        <div class="admin-section">
            <h3>ğŸ”‘ Generate New Key</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <div>
                    <div class="form-group">
                        <label for="userName">ğŸ‘¤ User Name:</label>
                        <input type="text" id="userName" placeholder="Enter full name (e.g., John Smith)">
                    </div>
                    <div class="form-group">
                        <label for="keyDuration">â° License Duration:</label>
                        <select id="keyDuration">
                            <option value="1">1 Month</option>
                            <option value="3">3 Months</option>
                            <option value="6">6 Months</option>
                            <option value="12" selected>1 Year</option>
                            <option value="24">2 Years</option>
                            <option value="0">Permanent</option>
                        </select>
                    </div>
                </div>
                <div>
                    <div class="form-group">
                        <label for="keyType">ğŸ·ï¸ Key Type:</label>
                        <select id="keyType">
                            <option value="STANDARD">Standard User</option>
                            <option value="PREMIUM">Premium User</option>
                            <option value="ADMIN">Admin User</option>
                            <option value="TEST">Test User</option>
                            <option value="STUDENT">Student User</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="userEmail">ğŸ“§ Email (Optional):</label>
                        <input type="email" id="userEmail" placeholder="user@example.com">
                    </div>
                </div>
            </div>
            
            <div style="margin-top: 20px;">
                <button onclick="generateNewKey()" class="btn-success">ğŸ”‘ Generate Key</button>
                <button onclick="saveKeyToDatabase()" id="saveBtn" class="btn-success" disabled>ğŸ’¾ Save to Database</button>
                <button onclick="clearKeyForm()" class="btn-secondary">ğŸ—‘ï¸ Clear Form</button>
            </div>
            
            <div id="generatedKeyDisplay" class="generated-key hidden">
                <h4>âœ… New Key Generated Successfully!</h4>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div>
                        <strong>ğŸ”‘ Key Code:</strong> <span id="newKeyCode" style="font-family: monospace; background: #fff; padding: 5px; border-radius: 3px;"></span><br>
                        <strong>ğŸ‘¤ User Name:</strong> <span id="newKeyName"></span><br>
                        <strong>â° Expires:</strong> <span id="newKeyExpiry"></span>
                    </div>
                    <div>
                        <strong>ğŸ·ï¸ Type:</strong> <span id="newKeyType"></span><br>
                        <strong>ğŸ” Encryption Key:</strong> <small id="newEncryptionKey" style="font-family: monospace; word-break: break-all;"></small>
                    </div>
                </div>
                <button onclick="copyKeyToClipboard()" class="btn-secondary" style="margin-top: 10px;">ğŸ“‹ Copy Key</button>
            </div>
            
            <div id="saveSuccess" class="success-message hidden">
                âœ… Key saved successfully! It will work immediately on the main site.
            </div>
        </div>

        <!-- Admin Settings -->
        <div class="admin-section">
            <h3>âš™ï¸ System Settings</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
                <div>
                    <h4>ğŸ” Security Settings</h4>
                    <div class="form-group">
                        <label for="newAdminPassword">New Admin Password:</label>
                        <input type="password" id="newAdminPassword" placeholder="Enter new password">
                    </div>
                    <button onclick="changeAdminPassword()" class="btn-warning">ğŸ”‘ Update Password</button>
                    <h4 style="margin-top: 20px;">ğŸ” Two-Factor Authentication</h4>
                    <div class="form-group">
                        <label for="twoFactorEnabled">Enable 2FA:</label>
                        <select id="twoFactorEnabled" onchange="toggle2FA()">
                            <option value="false">Disabled</option>
                            <option value="email">Email-based 2FA</option>
                            <option value="backup">Backup Codes</option>
                        </select>
                    </div>
                    <div id="twoFactorSection" class="hidden">
                        <div class="form-group">
                            <label for="twoFactorEmail">2FA Email (can be different from notification email):</label>
                            <input type="email" id="twoFactorEmail" placeholder="security@yoursite.com">
                        </div>
                        <div class="form-group">
                            <label>Backup Codes (save these safely):</label>
                            <textarea id="backupCodes" readonly style="height: 100px; background: #f8f9fa;"></textarea>
                        </div>
                        <button onclick="generateBackupCodes()" class="btn-warning">ğŸ”„ Generate New Codes</button>
                        <button onclick="test2FA()" class="btn-secondary">ğŸ§ª Test 2FA</button>
                    </div>
                    <button onclick="save2FASettings()" class="btn-success">ğŸ’¾ Save 2FA Settings</button>
<h4 style="margin-top: 20px;">ğŸ“§ Email Settings</h4>
                    <div class="form-group">
                        <label for="notificationEmail">Notification Email:</label>
                        <input type="email" id="notificationEmail" placeholder="admin@yoursite.com">
                    </div>
                    <div class="form-group">
                        <label for="emailService">Email Service:</label>
                        <select id="emailService" onchange="toggleEmailFields()">
                            <option value="disabled">Disabled</option>
                            <option value="netlify">Netlify Forms</option>
                            <option value="emailjs">EmailJS (Free)</option>
                        </select>
                    </div>
                    <div id="emailjsFields" class="hidden">
                        <div class="form-group">
                            <label for="emailjsPublicKey">EmailJS Public Key:</label>
                            <input type="text" id="emailjsPublicKey" placeholder="Your EmailJS public key">
                            <small style="color: #666; font-size: 12px;">Found in EmailJS Dashboard â†’ Account â†’ General</small>
                        </div>
                        <div class="form-group">
                            <label for="emailjsServiceId">EmailJS Service ID:</label>
                            <input type="text" id="emailjsServiceId" placeholder="service_xxxxxxx">
                            <small style="color: #666; font-size: 12px;">Found in EmailJS Dashboard â†’ Email Services</small>
                        </div>
                        <div class="form-group">
                            <label for="emailjsTemplateId">EmailJS Template ID:</label>
                            <input type="text" id="emailjsTemplateId" placeholder="template_xxxxxxx">
                            <small style="color: #666; font-size: 12px;">Found in EmailJS Dashboard â†’ Email Templates</small>
                        </div>
                        <p style="font-size: 12px; color: #666; background: #f8f9fa; padding: 10px; border-radius: 5px; border-left: 3px solid #3498db;">
                            ğŸ“ <strong>Setup Guide:</strong> <a href="https://emailjs.com" target="_blank">Create free EmailJS account</a> â†’ 
                            Connect Gmail â†’ Create template â†’ Copy IDs above
                        </p>
                    </div>
                    <div style="margin-top: 15px;">
                        <button onclick="saveEmailSettings()" class="btn-success">ğŸ’¾ Save Email Settings</button>
                        <button onclick="quickEmailTest()" class="btn-secondary">ğŸ“§ Quick Test</button>
                    </div>
                    </div>
                
                <div>
                    <h4>ğŸ’³ Payment Settings</h4>
                    <div class="form-group">
                        <label for="paypalClientId">PayPal Client ID:</label>
                        <input type="text" id="paypalClientId" placeholder="Your PayPal client ID">
                    </div>
                    <div class="form-group">
                        <label for="paypalEnvironment">PayPal Environment:</label>
                        <select id="paypalEnvironment">
                            <option value="sandbox">Sandbox (Testing)</option>
                            <option value="production">Production (Live)</option>
                        </select>
                    </div>
                    <button onclick="savePayPalSettings()" class="btn-success">ğŸ’¾ Save PayPal Settings</button>
                    
                    <h4 style="margin-top: 20px;">ğŸ’° Pricing</h4>
                    <div class="form-group">
                        <label for="keyPrice">Price per Key (USD):</label>
                        <input type="number" id="keyPrice" placeholder="29.99" step="0.01">
                    </div>
                    <button onclick="savePricingSettings()" class="btn-success">ğŸ’¾ Save Pricing</button>
                </div>
            </div>
        </div>

        <!-- Bulk Key Generation -->
        <div class="admin-section">
            <h3>ğŸ“¦ Bulk Key Generation</h3>
            <p>Generate multiple keys at once for bulk distribution.</p>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px;">
                <div>
                    <div class="form-group">
                        <label for="bulkCount">Number of Keys:</label>
                        <input type="number" id="bulkCount" min="1" max="1000" value="10" placeholder="10">
                    </div>
                    <div class="form-group">
                        <label for="bulkPrefix">Name Prefix:</label>
                        <input type="text" id="bulkPrefix" value="User" placeholder="User, Student, Trial">
                    </div>
                </div>
                <div>
                    <div class="form-group">
                        <label for="bulkDuration">Duration (All Keys):</label>
                        <select id="bulkDuration">
                            <option value="1">1 Month</option>
                            <option value="3">3 Months</option>
                            <option value="6">6 Months</option>
                            <option value="12" selected>1 Year</option>
                            <option value="24">2 Years</option>
                            <option value="0">Permanent</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="bulkType">Key Type (All Keys):</label>
                        <select id="bulkType">
                            <option value="STANDARD">Standard</option>
                            <option value="PREMIUM">Premium</option>
                            <option value="STUDENT">Student</option>
                            <option value="TRIAL">Trial</option>
                            <option value="BULK">Bulk</option>
                        </select>
                    </div>
                </div>
                <div>
                    <div class="form-group">
                        <label for="bulkStartNumber">Start Number:</label>
                        <input type="number" id="bulkStartNumber" value="1" min="1" placeholder="1">
                    </div>
                    <div class="form-group">
                        <label for="bulkPadding">Number Padding:</label>
                        <select id="bulkPadding">
                            <option value="1">1 (User1, User2)</option>
                            <option value="2">2 (User01, User02)</option>
                            <option value="3" selected>3 (User001, User002)</option>
                            <option value="4">4 (User0001, User0002)</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <div style="margin-top: 20px;">
                <button onclick="generateBulkKeys()" class="btn-success">ğŸ“¦ Generate Bulk Keys</button>
                <button onclick="exportBulkKeys()" class="btn-warning" id="exportBulkBtn" disabled>ğŸ“¤ Export as CSV</button>
                <button onclick="clearBulkKeys()" class="btn-danger">ğŸ—‘ï¸ Clear Bulk</button>
            </div>
            
            <div id="bulkKeysList" class="key-list hidden" style="max-height: 300px;">
                <!-- Bulk keys will appear here -->
            </div>
        </div>
        <!-- Key Renewal System -->
        <div class="admin-section">
            <h3>ğŸ”„ Key Renewal System</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
                <div>
                    <h4>ğŸ” Find Key to Renew</h4>
                    <div class="form-group">
                        <label for="renewalKeyCode">Key Code to Renew:</label>
                        <input type="text" id="renewalKeyCode" placeholder="Enter key code">
                        <button onclick="searchKeyForRenewal()" class="btn-secondary" style="margin-top: 5px;">ğŸ” Search Key</button>
                    </div>
                    
                    <div id="renewalKeyInfo" class="hidden" style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin-top: 15px;">
                        <h5 style="margin-top: 0;">Key Information:</h5>
                        <p><strong>User:</strong> <span id="renewalUserName"></span></p>
                        <p><strong>Current Expiry:</strong> <span id="renewalCurrentExpiry"></span></p>
                        <p><strong>Status:</strong> <span id="renewalStatus"></span></p>
                        <p><strong>Type:</strong> <span id="renewalKeyType"></span></p>
                    </div>
                </div>
                
                <div>
                    <h4>â° Renewal Options</h4>
                    <div class="form-group">
                        <label for="renewalDuration">Extend Duration:</label>
                        <select id="renewalDuration">
                            <option value="1">+1 Month</option>
                            <option value="3">+3 Months</option>
                            <option value="6">+6 Months</option>
                            <option value="12" selected>+1 Year</option>
                            <option value="24">+2 Years</option>
                            <option value="custom">Custom Date</option>
                        </select>
                    </div>
                    
                    <div class="form-group" id="customDateField" style="display: none;">
                        <label for="customExpiryDate">Custom Expiry Date:</label>
                        <input type="date" id="customExpiryDate">
                    </div>
                    
                    <div class="form-group">
                        <label for="renewalReason">Renewal Reason:</label>
                        <select id="renewalReason">
                            <option value="payment">Payment Received</option>
                            <option value="extension">Courtesy Extension</option>
                            <option value="migration">License Migration</option>
                            <option value="upgrade">Account Upgrade</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="renewalNotes">Renewal Notes (Optional):</label>
                        <textarea id="renewalNotes" placeholder="Add notes about this renewal..." style="height: 80px;"></textarea>
                    </div>
                    
                    <button onclick="processKeyRenewal()" id="renewBtn" class="btn-success" disabled>ğŸ”„ Process Renewal</button>
                    <button onclick="clearRenewalForm()" class="btn-secondary">ğŸ—‘ï¸ Clear Form</button>
                </div>
            </div>
            
            <!-- Renewal History -->
            <div style="margin-top: 30px;">
                <h4>ğŸ“œ Recent Renewals</h4>
                <div id="renewalHistory" class="key-list" style="max-height: 200px;">
                    <div style="text-align: center; color: #7f8c8d; padding: 20px;">
                        <p>ğŸ“Š Renewal history will appear here...</p>
                    </div>
                </div>
                <button onclick="loadRenewalHistory()" class="btn-secondary">ğŸ”„ Refresh History</button>
                <button onclick="exportRenewalHistory()" class="btn-warning">ğŸ“¤ Export History</button>
            </div>
        </div>
<!-- Key Management -->
        <div class="admin-section">
            <h3>ğŸ“‹ Key Database Management</h3>
            <div style="margin-bottom: 15px;">
                <button onclick="refreshKeyList()" class="btn-success">ğŸ”„ Refresh List</button>
                <button onclick="loadFromDatabase()" class="btn-success">â˜ï¸ Load from Database</button>
                <button onclick="exportDatabase()" class="btn-warning">ğŸ“¤ Export Database</button>
                <button onclick="showImportSection()" class="btn-secondary">ğŸ“¥ Backup/Restore</button>
                <span style="margin-left: 20px; color: #7f8c8d; font-size: 14px;" id="keyCount">0 keys loaded</span>
            </div>
            
            <div id="keyList" class="key-list">
                <div style="text-align: center; color: #7f8c8d; padding: 40px;">
                    <h4>ğŸ” Loading keys...</h4>
                    <p>Please wait while we fetch the key database.</p>
                </div>
            </div>
        </div>

        <!-- Import/Export Section -->
        <div id="importSection" class="admin-section hidden">
            <h3>ğŸ“¥ Database Backup & Restore</h3>
            <p><strong>ğŸ“‹ Instructions:</strong></p>
            <ul>
                <li><strong>Backup:</strong> Copy the JSON content below and save it safely</li>
                <li><strong>Restore:</strong> Paste JSON content and click restore (overwrites current database)</li>
                <li><strong>Database File:</strong> You can also download as a file and upload to your server</li>
            </ul>
            
            <div class="form-group">
                <label for="exportData">ğŸ—„ï¸ Database JSON Content:</label>
                <textarea id="exportData" placeholder="Database JSON content will appear here..." style="height: 300px;"></textarea>
            </div>
            
            <div style="margin-top: 15px;">
                <button onclick="copyToClipboard()" class="btn-success">ğŸ“‹ Copy to Clipboard</button>
                <button onclick="downloadDatabase()" class="btn-success">ğŸ’¾ Download File</button>
                <button onclick="restoreFromJson()" class="btn-warning">ğŸ“¥ Restore from JSON</button>
                <button onclick="hideImportSection()" class="btn-secondary">âŒ Close</button>
            </div>
        </div>

        <!-- System Logs -->
        <div class="admin-section">
            <h3>ğŸ“œ System Activity Log</h3>
            <div style="margin-bottom: 15px;">
                <button onclick="refreshActivityLog()" class="btn-success">ğŸ”„ Refresh</button>
                <button onclick="clearActivityLog()" class="btn-danger">ğŸ—‘ï¸ Clear Log</button>
                <select id="logFilter" onchange="filterActivityLog()" style="margin-left: 10px; width: auto;">
                    <option value="all">All Activities</option>
                    <option value="validation">Key Validations</option>
                    <option value="creation">Key Creation</option>
                    <option value="download">Downloads</option>
                    <option value="error">Errors</option>
                    <option value="admin">Admin Actions</option>
                </select>
            </div>
            
            <div id="activityLog" class="key-list" style="max-height: 250px;">
                <div style="text-align: center; color: #7f8c8d; padding: 20px;">
                    <p>ğŸ“Š Activity log will appear here...</p>
                </div>
            </div>
        </div>

        <!-- Email Test & Analytics -->
        <div class="admin-section">
            <h3>ğŸ“Š Analytics & Testing</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
                <div>
<div>
                    <h4>ğŸ“§ Quick Email Test</h4>
                    <p style="color: #666; font-size: 14px;">Send a test email to verify your configuration is working.</p>
                    
                    <div class="form-group">
                        <label for="testEmailAddress">Test Email (Optional - will use Notification Email if empty):</label>
                        <input type="email" id="testEmailAddress" placeholder="Leave empty to use notification email above">
                    </div>
                    
                    <div class="form-group">
                        <label for="testEmailSubject">Test Subject:</label>
                        <input type="text" id="testEmailSubject" value="LMS AI Test - Email System Working!" placeholder="Test subject">
                    </div>
                    
                    <div class="form-group">
                        <label for="testEmailMessage">Test Message:</label>
                        <textarea id="testEmailMessage" style="height: 80px;">ğŸ‰ Congratulations!

Your LMS AI email notification system is working perfectly!

âœ… EmailJS is configured correctly
âœ… Email notifications are active
âœ… You'll receive alerts for key activities

Happy licensing! ğŸš€</textarea>
                    </div>
                    
                    <button onclick="sendTestEmail()" class="btn-secondary">ğŸ“§ Send Test Email</button>
                    
                    <div style="margin-top: 15px; padding: 10px; background: #fff3cd; border-radius: 5px; border-left: 3px solid #ffc107;">
                        <small>
                            <strong>ğŸ’¡ How it works:</strong><br>
                            â€¢ If "Test Email" is empty, uses "Notification Email" above<br>
                            â€¢ Check spam folder if email doesn't arrive<br>
                            â€¢ Save email settings first before testing
                        </small>
                    </div>
                </div>
                <div>
                    <h4>ğŸ“ˆ Quick Stats</h4>
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid #3498db;">
                        <p><strong>ğŸ“… Today's Activity:</strong></p>
                        <ul style="margin: 10px 0; padding-left: 20px;">
                            <li>Keys Generated: <span id="todayKeysGenerated">0</span></li>
                            <li>Keys Validated: <span id="todayKeysValidated">0</span></li>
                            <li>Scripts Downloaded: <span id="todayDownloads">0</span></li>
                            <li>Admin Logins: <span id="todayLogins">0</span></li>
                        </ul>
                        <button onclick="calculateTodayStats()" class="btn-secondary" style="font-size: 12px; padding: 8px 15px;">ğŸ”„ Calculate</button>
                    </div>
                    
                    <h4 style="margin-top: 20px;">ğŸ”§ System Info</h4>
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid #27ae60;">
                        <p><strong>ğŸ“ Version:</strong> 2.0.0</p>
                        <p><strong>ğŸ—„ï¸ Storage:</strong> localStorage + Netlify</p>
                        <p><strong>ğŸŒ Environment:</strong> <span id="environmentInfo">Production</span></p>
                        <p><strong>ğŸ“Š Database Size:</strong> <span id="databaseSize">Calculating...</span></p>
                        <button onclick="calculateSystemInfo()" class="btn-secondary" style="font-size: 12px; padding: 8px 15px;">ğŸ”„ Refresh Info</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
<script>
        // ===== CONFIGURATION =====
        const API_BASE = '/.netlify/functions';
        
        // ===== GLOBAL VARIABLES =====
        let keysDatabase = {};
        let currentGeneratedKey = null;
        let activityLog = [];
        let isDatabaseConnected = false;
        let bulkGeneratedKeys = [];

        // ===== SYSTEM SETTINGS =====
        let systemSettings = {
            adminPassword: 'admin2025',
            notificationEmail: '',
            emailService: 'disabled',
            paypalClientId: '',
            paypalEnvironment: 'sandbox',
            keyPrice: 29.99,
            emailjsPublicKey: '',
            emailjsServiceId: '',
            emailjsTemplateId: ''
        };

        function loadSystemSettings() {
            const stored = localStorage.getItem('lms_ai_system_settings');
            if (stored) {
                try {
                    systemSettings = { ...systemSettings, ...JSON.parse(stored) };
                } catch (e) {
                    console.warn('Could not load system settings');
                }
            }
            
            // Update UI if elements exist
            setTimeout(() => {
                if (document.getElementById('notificationEmail')) {
                    document.getElementById('notificationEmail').value = systemSettings.notificationEmail;
                    document.getElementById('emailService').value = systemSettings.emailService;
                    document.getElementById('paypalClientId').value = systemSettings.paypalClientId;
                    document.getElementById('paypalEnvironment').value = systemSettings.paypalEnvironment;
                    document.getElementById('keyPrice').value = systemSettings.keyPrice;
                    document.getElementById('emailjsPublicKey').value = systemSettings.emailjsPublicKey;
                    document.getElementById('emailjsServiceId').value = systemSettings.emailjsServiceId;
                    document.getElementById('emailjsTemplateId').value = systemSettings.emailjsTemplateId;
                    
                    toggleEmailFields();
                }
            }, 100);
        }

        function saveSystemSettings() {
            localStorage.setItem('lms_ai_system_settings', JSON.stringify(systemSettings));
        }

        // ===== LOGIN SYSTEM =====
        function attemptLogin() {
            const password = document.getElementById('loginPassword').value;
            const errorDiv = document.getElementById('errorMessage');
            
            // Load current admin password from settings
            const stored = localStorage.getItem('lms_ai_system_settings');
            let currentPassword = 'admin2025'; // Default
            
            if (stored) {
                try {
                    const settings = JSON.parse(stored);
                    currentPassword = settings.adminPassword || 'admin2025';
                } catch (e) {
                    console.warn('Could not load settings, using default password');
                }
            }
            
            console.log('Current admin password:', currentPassword); // For debugging
            
            if (password === currentPassword) {
                document.getElementById('loginContainer').style.display = 'none';
                document.getElementById('adminContainer').style.display = 'block';
                initializeAdmin();
                logActivity('admin_login', 'Administrator logged in');
            } else {
                errorDiv.textContent = 'âŒ Invalid password! Access denied.';
                errorDiv.classList.remove('hidden');
                document.getElementById('loginPassword').value = '';
                document.getElementById('loginPassword').style.borderColor = '#e74c3c';
                
                setTimeout(() => {
                    errorDiv.classList.add('hidden');
                    document.getElementById('loginPassword').style.borderColor = '#bdc3c7';
                }, 3000);
                
                logActivity('admin_login_failed', 'Failed login attempt');
            }
        }
        
        function logout() {
            if (confirm('ğŸšª Are you sure you want to logout?')) {
                document.getElementById('loginContainer').style.display = 'block';
                document.getElementById('adminContainer').style.display = 'none';
                document.getElementById('loginPassword').value = '';
                logActivity('admin_logout', 'Administrator logged out');
            }
        }

        function changeAdminPassword() {
            const newPassword = document.getElementById('newAdminPassword').value.trim();
            
            if (!newPassword) {
                alert('âŒ Please enter a new password');
                return;
            }
            
            if (newPassword.length < 6) {
                alert('âŒ Password must be at least 6 characters');
                return;
            }
            
            if (confirm(`ğŸ”‘ Change admin password to: ${newPassword}?\n\nMake sure you remember this password!`)) {
                systemSettings.adminPassword = newPassword;
                saveSystemSettings();
                
                // Also update the main site password
                localStorage.setItem('lms_ai_admin_password', newPassword);
                
                alert('âœ… Admin password updated successfully!\n\nNew password: ' + newPassword + '\n\nThis works for both admin panel and main site secret access.');
                document.getElementById('newAdminPassword').value = '';
                
                logActivity('admin_password_changed', 'Admin password updated to: ' + newPassword);
            }
        }

        // ===== ACTIVITY LOGGING =====
        function logActivity(type, message) {
            const timestamp = new Date().toISOString();
            const logEntry = {
                timestamp: timestamp,
                type: type,
                message: message,
                id: Date.now()
            };
            
            activityLog.unshift(logEntry);
            
            if (activityLog.length > 100) {
                activityLog = activityLog.slice(0, 100);
            }
            
            localStorage.setItem('lms_ai_activity_log', JSON.stringify(activityLog));
            console.log(`[${timestamp}] ${type}: ${message}`);
        }

        // ===== EMAIL FUNCTIONS =====
        function toggleEmailFields() {
            const service = document.getElementById('emailService').value;
            const fields = document.getElementById('emailjsFields');
            
            if (fields) {
                if (service === 'emailjs') {
                    fields.classList.remove('hidden');
                } else {
                    fields.classList.add('hidden');
                }
            }
        }

        function saveEmailSettings() {
            systemSettings.notificationEmail = document.getElementById('notificationEmail').value.trim();
            systemSettings.emailService = document.getElementById('emailService').value;
            systemSettings.emailjsPublicKey = document.getElementById('emailjsPublicKey').value.trim();
            systemSettings.emailjsServiceId = document.getElementById('emailjsServiceId').value.trim();
            systemSettings.emailjsTemplateId = document.getElementById('emailjsTemplateId').value.trim();
            
            saveSystemSettings();
            
            if (systemSettings.emailService === 'emailjs' && systemSettings.emailjsPublicKey) {
                emailjs.init(systemSettings.emailjsPublicKey);
            }
            
            alert('âœ… Email settings saved successfully!');
            logActivity('email_settings_updated', `Email service: ${systemSettings.emailService}`);
        }

        async function sendEmailNotification(type, data) {
            if (systemSettings.emailService === 'disabled') {
                return;
            }
            
            try {
                if (systemSettings.emailService === 'netlify') {
                    await sendNetlifyFormEmail(type, data);
                } else if (systemSettings.emailService === 'emailjs') {
                    await sendEmailJSNotification(type, data);
                }
                
                console.log('Email notification sent:', type);
                logActivity('email_sent', `${type} notification sent`);
            } catch (error) {
                console.error('Email send failed:', error);
                logActivity('email_failed', `Failed to send ${type}: ${error.message}`);
            }
        }
// ===== ALIAS FOR COMPATIBILITY =====
    function quickEmailTest() {
            const email = document.getElementById('notificationEmail').value.trim();
            
            if (!email) {
                alert('âŒ Please enter notification email first');
                return;
            }
            
            if (systemSettings.emailService === 'disabled') {
                alert('âŒ Please configure email service first');
                return;
            }
            
            const originalEmail = systemSettings.notificationEmail;
            systemSettings.notificationEmail = email;
            
            sendEmailNotification('Test Email', {
                message: 'Quick test successful! Your email notifications are working.',
                subject: 'LMS AI Quick Test'
            }).then(() => {
                alert('âœ… Test email sent to: ' + email);
            }).catch(error => {
                alert('âŒ Test failed: ' + error.message);
            }).finally(() => {
                systemSettings.notificationEmail = originalEmail;
            });
        }
        function testEmailNotification() {
            sendTestEmail();
        }
        async function sendNetlifyFormEmail(type, data) {
            const formData = new FormData();
            formData.append('form-name', 'contact');
            formData.append('name', 'LMS AI System');
            formData.append('email', systemSettings.notificationEmail);
            formData.append('subject', `LMS AI - ${type}`);
            formData.append('message', formatEmailMessage(type, data));
            formData.append('timestamp', new Date().toISOString());

            const response = await fetch('/', {
                method: 'POST',
                body: formData
            });

            if (!response.ok) {
                throw new Error('Netlify form submission failed');
            }
        }

        async function sendEmailJSNotification(type, data) {
            if (!systemSettings.emailjsPublicKey || !systemSettings.emailjsServiceId || !systemSettings.emailjsTemplateId) {
                throw new Error('EmailJS not configured');
            }

            const templateParams = {
                to_email: systemSettings.notificationEmail,
                subject: `LMS AI - ${type}`,
                message: formatEmailMessage(type, data),
                timestamp: new Date().toLocaleString()
            };

            await emailjs.send(
                systemSettings.emailjsServiceId,
                systemSettings.emailjsTemplateId,
                templateParams
            );
        }

        function formatEmailMessage(type, data) {
            switch (type) {
                case 'Key Validation':
                    return `Key ${data.keyCode} was validated by ${data.userName} at ${new Date().toLocaleString()}`;
                case 'Key Generated':
                    return `New key ${data.keyCode} generated for ${data.userName}`;
                case 'Bulk Keys Generated':
                    return `${data.count} bulk keys generated with prefix ${data.prefix}`;
                case 'Script Download':
                    return `User ${data.userName} downloaded script using key ${data.keyCode}`;
                case 'Test Email':
                    return data.message || 'This is a test email from LMS AI Admin Panel';
                default:
                    return `LMS AI Activity: ${type}`;
            }
        }

async function sendTestEmail() {
            let testEmail = document.getElementById('testEmailAddress').value.trim();
            const testSubject = document.getElementById('testEmailSubject').value.trim() || 'LMS AI Admin Test';
            const testMessage = document.getElementById('testEmailMessage').value.trim() || 'This is a test email from your LMS AI Assistant admin panel.';
            
            // If no test email entered, use notification email
            if (!testEmail) {
                testEmail = document.getElementById('notificationEmail').value.trim();
            }
            
            // Still no email found
            if (!testEmail) {
                alert('âŒ Please enter an email address!\n\nEither:\nâ€¢ Fill in "Test Email Address" field, OR\nâ€¢ Fill in "Notification Email" field');
                return;
            }
            
            if (systemSettings.emailService === 'disabled') {
                alert('âŒ Email service is disabled.\n\nPlease:\n1. Choose EmailJS or Netlify Forms\n2. Configure settings\n3. Save settings\n4. Try test again');
                return;
            }
            
            if (systemSettings.emailService === 'emailjs') {
                if (!systemSettings.emailjsPublicKey || !systemSettings.emailjsServiceId || !systemSettings.emailjsTemplateId) {
                    alert('âŒ EmailJS configuration incomplete.\n\nPlease fill in:\nâ€¢ Public Key\nâ€¢ Service ID\nâ€¢ Template ID\n\nThen save settings and try again.');
                    return;
                }
            }
            
            // Show loading state
            const testBtn = event.target;
            const originalText = testBtn.textContent;
            testBtn.disabled = true;
            testBtn.textContent = 'ğŸ“§ Sending...';
            
            try {
                console.log('Starting test email to:', testEmail);
                
                // Temporarily use test email
                const originalEmail = systemSettings.notificationEmail;
                systemSettings.notificationEmail = testEmail;
                
                await sendEmailNotification('Test Email', {
                    message: testMessage,
                    subject: testSubject,
                    testEmail: testEmail
                });
                
                // Restore original email
                systemSettings.notificationEmail = originalEmail;
                
                alert('âœ… Test email sent successfully!\n\nğŸ“§ Sent to: ' + testEmail + '\n\nğŸ’¡ Check your inbox and spam folder.\n\nGmail may take 1-2 minutes to deliver.');
                logActivity('test_email_sent', `Test email sent to ${testEmail} via ${systemSettings.emailService}`);
                
            } catch (error) {
                console.error('Test email error:', error);
                
                let errorMessage = 'âŒ Failed to send test email:\n\n';
                
                if (error.message.includes('EmailJS')) {
                    errorMessage += 'ğŸ”§ EmailJS Error:\n' + error.message + '\n\nğŸ’¡ Check your EmailJS configuration:\nâ€¢ Public Key\nâ€¢ Service ID\nâ€¢ Template ID\nâ€¢ Gmail service connection';
                } else if (error.message.includes('Netlify')) {
                    errorMessage += 'ğŸ”§ Netlify Forms Error:\n' + error.message + '\n\nğŸ’¡ Make sure Netlify Forms are enabled on your site.';
                } else {
                    errorMessage += error.message;
                }
                
                alert(errorMessage);
                logActivity('test_email_failed', `Test email failed: ${error.message}`);
            } finally {
                // Restore button
                testBtn.disabled = false;
                testBtn.textContent = originalText;
            }
        }

        // ===== COMPATIBILITY ALIAS =====
        function testEmailNotification() {
            sendTestEmail();
        }
function savePayPalSettings() {
            systemSettings.paypalClientId = document.getElementById('paypalClientId').value.trim();
            systemSettings.paypalEnvironment = document.getElementById('paypalEnvironment').value;
            
            saveSystemSettings();
            alert('âœ… PayPal settings saved successfully!');
            
            logActivity('paypal_settings_updated', `Environment: ${systemSettings.paypalEnvironment}`);
        }

        function savePricingSettings() {
            const price = parseFloat(document.getElementById('keyPrice').value);
            if (isNaN(price) || price < 0) {
                alert('âŒ Please enter a valid price');
                return;
            }
            
            systemSettings.keyPrice = price;
            saveSystemSettings();
            alert(`âœ… Pricing updated: $${price.toFixed(2)} per key`);
            
            logActivity('pricing_updated', `Key price set to $${price.toFixed(2)}`);
        }

        // ===== KEY GENERATION =====
function generateKey() {
    // Generate LMS-AI format instead of TEST format
    const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
    let keyCode = '';
    for (let i = 0; i < 8; i++) {
        keyCode += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    return 'LMS-AI-2025-' + keyCode;
}
            const namePrefix = userName.toUpperCase().replace(/[^A-Z]/g, '').substring(0, 4).padEnd(4, 'X');
            const year = new Date().getFullYear();
            const random = Math.random().toString(36).substring(2, 8).toUpperCase();
            
            const keyCode = `${namePrefix}-${year}-${random}`;
            
            let expiryDate;
            if (duration === 0) {
                expiryDate = "2099-12-31";
            } else {
                const expiry = new Date();
                expiry.setMonth(expiry.getMonth() + duration);
                expiryDate = expiry.toISOString().split('T')[0];
            }

            const encryptionKey = `${userName.toLowerCase().replace(/\s+/g, '-')}-secret-key-${year}`;

            currentGeneratedKey = {
                keyCode: keyCode,
                userName: userName,
                expiryDate: expiryDate,
                encryptionKey: encryptionKey,
                keyType: keyType,
                userEmail: userEmail,
                createdAt: new Date().toISOString(),
                active: true,
                downloadCount: 0
            };

            document.getElementById('newKeyCode').textContent = keyCode;
            document.getElementById('newKeyName').textContent = userName;
            document.getElementById('newKeyExpiry').textContent = expiryDate;
            document.getElementById('newKeyType').textContent = keyType;
            document.getElementById('newEncryptionKey').textContent = encryptionKey.substring(0, 30) + '...';
            document.getElementById('generatedKeyDisplay').classList.remove('hidden');
            document.getElementById('saveSuccess').classList.add('hidden');
            
            document.getElementById('saveBtn').disabled = false;
            
            logActivity('key_generated', `Generated key ${keyCode} for ${userName}`);
            
            // Send email notification
            sendEmailNotification('Key Generated', {
                keyCode: keyCode,
                userName: userName,
                keyType: keyType
            });
        }

        async function saveKeyToDatabase() {
            if (!currentGeneratedKey) {
                alert('âŒ Please generate a key first!');
                return;
            }

            const saveBtn = document.getElementById('saveBtn');
            const originalText = saveBtn.textContent;
            saveBtn.disabled = true;
            saveBtn.textContent = 'ğŸ’¾ Saving...';

            try {
                const localKeys = JSON.parse(localStorage.getItem('lms_ai_local_keys') || '{}');
                localKeys[currentGeneratedKey.keyCode] = {
                    name: currentGeneratedKey.userName,
                    expiry: currentGeneratedKey.expiryDate,
                    active: currentGeneratedKey.active,
                    encryptionKey: currentGeneratedKey.encryptionKey,
                    type: currentGeneratedKey.keyType,
                    created: currentGeneratedKey.createdAt.split('T')[0],
                    download_count: 0
                };
                localStorage.setItem('lms_ai_local_keys', JSON.stringify(localKeys));
                
                keysDatabase[currentGeneratedKey.keyCode] = localKeys[currentGeneratedKey.keyCode];
                
                try {
                    const response = await fetch(`${API_BASE}/create-key`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            keyCode: currentGeneratedKey.keyCode,
                            userName: currentGeneratedKey.userName,
                            expiryDate: currentGeneratedKey.expiryDate,
                            encryptionKey: currentGeneratedKey.encryptionKey,
                            keyType: currentGeneratedKey.keyType,
                            adminPassword: systemSettings.adminPassword
                        })
                    });

                    if (response.ok) {
                        document.getElementById('saveSuccess').innerHTML = 'âœ… Key saved to database and localStorage!';
                        logActivity('key_saved_both', `Key ${currentGeneratedKey.keyCode} saved to both database and localStorage`);
                    } else {
                        throw new Error('Database unavailable');
                    }
                } catch (dbError) {
                    document.getElementById('saveSuccess').innerHTML = 'âœ… Key saved locally! (Will work immediately on main site)';
                    logActivity('key_saved_local_only', `Key ${currentGeneratedKey.keyCode} saved to localStorage only`);
                }
                
                document.getElementById('saveSuccess').classList.remove('hidden');
                
            } catch (error) {
                console.error('Save failed:', error);
                alert('âŒ Failed to save key: ' + error.message);
                logActivity('key_save_failed', `Failed to save key: ${error.message}`);
            } finally {
                saveBtn.disabled = false;
                saveBtn.textContent = originalText;
                refreshKeyList();
                updateStatistics();
            }
        }

        function clearKeyForm() {
            document.getElementById('userName').value = '';
            document.getElementById('userEmail').value = '';
            document.getElementById('keyDuration').value = '12';
            document.getElementById('keyType').value = 'STANDARD';
            document.getElementById('generatedKeyDisplay').classList.add('hidden');
            document.getElementById('saveSuccess').classList.add('hidden');
            document.getElementById('saveBtn').disabled = true;
            currentGeneratedKey = null;
        }

        function copyKeyToClipboard() {
            if (currentGeneratedKey) {
                navigator.clipboard.writeText(currentGeneratedKey.keyCode).then(() => {
                    alert('ğŸ“‹ Key copied to clipboard!');
                }).catch(() => {
                    const textArea = document.createElement('textarea');
                    textArea.value = currentGeneratedKey.keyCode;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    alert('ğŸ“‹ Key copied to clipboard!');
                });
            }
        }

        // ===== KEY MANAGEMENT =====
        function refreshKeyList() {
            const keyListDiv = document.getElementById('keyList');
            const localKeys = JSON.parse(localStorage.getItem('lms_ai_local_keys') || '{}');
            const allKeys = { ...localKeys, ...keysDatabase };
            const keyCount = Object.keys(allKeys).length;
            
            document.getElementById('keyCount').textContent = `${keyCount} keys loaded`;

            if (keyCount === 0) {
                keyListDiv.innerHTML = `
                    <div style="text-align: center; color: #7f8c8d; padding: 40px;">
                        <h4>ğŸ“­ No keys found</h4>
                        <p>Generate some keys to get started.</p>
                    </div>
                `;
                return;
            }

            const sortedKeys = Object.entries(allKeys).sort((a, b) => {
                const dateA = new Date(a[1].created || '2025-01-01');
                const dateB = new Date(b[1].created || '2025-01-01');
                return dateB - dateA;
            });

            keyListDiv.innerHTML = sortedKeys.map(([keyCode, keyData]) => {
                const isExpired = new Date() > new Date(keyData.expiry);
                const isActive = keyData.active;
                
                let statusClass = '';
                let statusIcon = '';
                let statusText = '';
                
                if (isExpired) {
                    statusClass = 'expired';
                    statusIcon = 'ğŸ”´';
                    statusText = 'EXPIRED';
                } else if (!isActive) {
                    statusClass = 'inactive';
                    statusIcon = 'ğŸŸ¡';
                    statusText = 'INACTIVE';
                } else {
                    statusIcon = 'ğŸŸ¢';
                    statusText = 'ACTIVE';
                }
                
                const lastUsed = keyData.last_used ? 
                    new Date(keyData.last_used).toLocaleDateString() : 'Never';
                
                return `
                    <div class="key-item ${statusClass}">
                        <div style="margin-right: 250px;">
                            <strong>ğŸ‘¤ ${keyData.name}</strong> 
                            <span style="background: #ecf0f1; padding: 2px 8px; border-radius: 3px; font-size: 11px; margin-left: 10px;">
                                ${keyData.type || 'STANDARD'}
                            </span><br>
                            <small><strong>ğŸ”‘ Key:</strong> <code>${keyCode}</code></small><br>
                            <small><strong>â° Expires:</strong> ${keyData.expiry} | <strong>ğŸ“… Created:</strong> ${keyData.created || 'Unknown'}</small><br>
                            <small><strong>ğŸ“Š Status:</strong> ${statusIcon} ${statusText} | <strong>ğŸ“¥ Downloads:</strong> ${keyData.download_count || 0} | <strong>ğŸ•’ Last Used:</strong> ${lastUsed}</small>
                        </div>
                        
                        <button onclick="copyKeyFromList('${keyCode}')" class="copy-btn btn-copy">
                            ğŸ“‹ Copy
                        </button>
                        <button onclick="toggleKeyStatus('${keyCode}')" class="toggle-btn btn-warning">
                            ${isActive ? 'ğŸ”’ Deactivate' : 'ğŸ”“ Activate'}
                        </button>
                        <button onclick="deleteKey('${keyCode}')" class="delete-btn btn-danger">
                            ğŸ—‘ï¸ Delete
                        </button>
                    </div>
                `;
            }).join('');
        }

        function copyKeyFromList(keyCode) {
            navigator.clipboard.writeText(keyCode).then(() => {
                alert(`ğŸ“‹ Key ${keyCode} copied to clipboard!`);
                logActivity('key_copied', `Key ${keyCode} copied to clipboard`);
            }).catch(() => {
                const textArea = document.createElement('textarea');
                textArea.value = keyCode;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                alert(`ğŸ“‹ Key ${keyCode} copied to clipboard!`);
                logActivity('key_copied', `Key ${keyCode} copied to clipboard`);
            });
        }

        function toggleKeyStatus(keyCode) {
            const localKeys = JSON.parse(localStorage.getItem('lms_ai_local_keys') || '{}');
            if (localKeys[keyCode]) {
                localKeys[keyCode].active = !localKeys[keyCode].active;
                localStorage.setItem('lms_ai_local_keys', JSON.stringify(localKeys));
                
                if (keysDatabase[keyCode]) {
                    keysDatabase[keyCode].active = localKeys[keyCode].active;
                }
                
                refreshKeyList();
                updateStatistics();
                
                const status = localKeys[keyCode].active ? 'activated' : 'deactivated';
                alert(`âœ… Key ${keyCode} has been ${status}`);
                logActivity('key_status_changed', `Key ${keyCode} ${status}`);
            }
        }

        function deleteKey(keyCode) {
            if (!confirm(`âš ï¸ Are you sure you want to delete key ${keyCode}?\n\nThis action cannot be undone.`)) {
                return;
            }

            const localKeys = JSON.parse(localStorage.getItem('lms_ai_local_keys') || '{}');
            delete localKeys[keyCode];
            localStorage.setItem('lms_ai_local_keys', JSON.stringify(localKeys));
            
            delete keysDatabase[keyCode];
            
            refreshKeyList();
            updateStatistics();
            alert(`âœ… Key ${keyCode} has been deleted permanently`);
            logActivity('key_deleted', `Key ${keyCode} deleted permanently`);
        }

        async function loadFromDatabase() {
            // This function could connect to real database in the future
            refreshKeyList();
            updateStatistics();
            logActivity('database_sync', 'Keys loaded from local storage');
        }

        function exportDatabase() {
            const localKeys = JSON.parse(localStorage.getItem('lms_ai_local_keys') || '{}');
            const allKeys = { ...keysDatabase, ...localKeys };
            
            const exportData = {
                keys: allKeys,
                exported_at: new Date().toISOString(),
                version: "2.0.0",
                total_keys: Object.keys(allKeys).length
            };
            
            const jsonString = JSON.stringify(exportData, null, 2);
            document.getElementById('exportData').value = jsonString;
            showImportSection();
            
            logActivity('database_exported', `Exported ${Object.keys(allKeys).length} keys`);
        }

        function showImportSection() {
            document.getElementById('importSection').classList.remove('hidden');
            if (!document.getElementById('exportData').value) {
                exportDatabase();
            }
        }

        function hideImportSection() {
            document.getElementById('importSection').classList.add('hidden');
        }

        function copyToClipboard() {
            const exportData = document.getElementById('exportData');
            exportData.select();
            navigator.clipboard.writeText(exportData.value).then(() => {
                alert('âœ… Database JSON copied to clipboard!\n\nYou can save this as a backup file.');
            }).catch(() => {
                document.execCommand('copy');
                alert('âœ… Database JSON copied to clipboard!');
            });
        }

        function downloadDatabase() {
            const content = document.getElementById('exportData').value;
            const blob = new Blob([content], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `lms-ai-database-backup-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            alert('âœ… Database backup downloaded!\n\nKeep this file safe for restore purposes.');
            logActivity('database_downloaded', 'Database backup file downloaded');
        }

        function restoreFromJson() {
            const jsonContent = document.getElementById('exportData').value.trim();
            
            if (!jsonContent) {
                alert('âŒ Please paste JSON content first!');
                return;
            }
            
            if (!confirm('âš ï¸ This will overwrite your current database!\n\nAre you sure you want to restore from this backup?')) {
                return;
            }
            
            try {
                const data = JSON.parse(jsonContent);
                
                if (data.keys && typeof data.keys === 'object') {
                    keysDatabase = data.keys;
                    localStorage.setItem('lms_ai_local_keys', JSON.stringify(data.keys));
                    
                    refreshKeyList();
                    updateStatistics();
                    
                    alert(`âœ… Database restored successfully!\n\nRestored ${Object.keys(data.keys).length} keys.`);
                    logActivity('database_restored', `Restored ${Object.keys(data.keys).length} keys from backup`);
                    
                    hideImportSection();
                } else {
                    throw new Error('Invalid backup format');
                }
                
            } catch (error) {
                alert(`âŒ Restore failed!\n\nError: ${error.message}\n\nPlease check the JSON format.`);
                logActivity('database_restore_failed', `Restore failed: ${error.message}`);
            }
        }

        // ===== BULK KEY GENERATION =====
        function generateBulkKeys() {
            const count = parseInt(document.getElementById('bulkCount').value);
            const prefix = document.getElementById('bulkPrefix').value.trim();
            const duration = parseInt(document.getElementById('bulkDuration').value);
            const keyType = document.getElementById('bulkType').value;
            const startNumber = parseInt(document.getElementById('bulkStartNumber').value);
            const padding = parseInt(document.getElementById('bulkPadding').value);
            
            if (!count || count < 1 || count > 1000) {
                alert('âŒ Please enter a valid number of keys (1-1000)');
                return;
            }
            
            if (!prefix) {
                alert('âŒ Please enter a name prefix');
                return;
            }
            
            if (confirm(`ğŸ“¦ Generate ${count} keys?\n\nPrefix: ${prefix}\nType: ${keyType}\nThis will take a moment...`)) {
                bulkGeneratedKeys = [];
                const bulkList = document.getElementById('bulkKeysList');
                bulkList.innerHTML = '<div style="text-align: center; padding: 20px;">â³ Generating keys...</div>';
                bulkList.classList.remove('hidden');
                
                setTimeout(() => {
                    for (let i = 0; i < count; i++) {
                        const number = startNumber + i;
                        const paddedNumber = number.toString().padStart(padding, '0');
                        const userName = `${prefix}${paddedNumber}`;
                        
                        const namePrefix = userName.toUpperCase().replace(/[^A-Z]/g, '').substring(0, 4).padEnd(4, 'X');
                        const year = new Date().getFullYear();
                        const random = Math.random().toString(36).substring(2, 8).toUpperCase();
                        const keyCode = `${namePrefix}-${year}-${random}`;
                        
                        let expiryDate;
                        if (duration === 0) {
                            expiryDate = "2099-12-31";
                        } else {
                            const expiry = new Date();
                            expiry.setMonth(expiry.getMonth() + duration);
                            expiryDate = expiry.toISOString().split('T')[0];
                        }
                        
                        const encryptionKey = `${userName.toLowerCase().replace(/\s+/g, '-')}-secret-key-${year}`;
                        
                        const keyData = {
                            keyCode: keyCode,
                            userName: userName,
                            expiryDate: expiryDate,
                            encryptionKey: encryptionKey,
                            keyType: keyType,
                            createdAt: new Date().toISOString(),
                            active: true,
                            bulk: true
                        };
                        
                        bulkGeneratedKeys.push(keyData);
                        
                        keysDatabase[keyCode] = {
                            name: userName,
                            expiry: expiryDate,
                            active: true,
                            encryptionKey: encryptionKey,
                            type: keyType,
                            created: new Date().toISOString().split('T')[0],
                            download_count: 0,
                            bulk: true
                        };
                    }
                    
                    const localKeys = JSON.parse(localStorage.getItem('lms_ai_local_keys') || '{}');
                    bulkGeneratedKeys.forEach(key => {
                        localKeys[key.keyCode] = {
                            name: key.userName,
                            expiry: key.expiryDate,
                            active: key.active,
                            encryptionKey: key.encryptionKey,
                            type: key.keyType,
                            created: key.createdAt.split('T')[0],
                            download_count: 0,
                            bulk: true
                        };
                    });
                    localStorage.setItem('lms_ai_local_keys', JSON.stringify(localKeys));
                    
                    displayBulkKeys();
                    document.getElementById('exportBulkBtn').disabled = false;
                    
                    refreshKeyList();
                    updateStatistics();
                    
                    alert(`âœ… Generated ${count} bulk keys successfully!`);
                    logActivity('bulk_keys_generated', `Generated ${count} ${keyType} keys with prefix ${prefix}`);
                    
                    // Send email notification
                    sendEmailNotification('Bulk Keys Generated', {
                        count: count,
                        prefix: prefix,
                        keyType: keyType
                    });
                    
                }, 500);
            }
        }

        function displayBulkKeys() {
            const bulkList = document.getElementById('bulkKeysList');
            
            if (bulkGeneratedKeys.length === 0) {
                bulkList.classList.add('hidden');
                return;
            }
            
            bulkList.innerHTML = `
                <div style="text-align: center; margin-bottom: 15px;">
                    <strong>ğŸ“¦ ${bulkGeneratedKeys.length} Bulk Keys Generated</strong>
                </div>
                ${bulkGeneratedKeys.map((key, index) => `
                    <div class="key-item" style="font-size: 12px;">
                        <strong>${key.userName}</strong><br>
                        <small><strong>Key:</strong> <code>${key.keyCode}</code></small><br>
                        <small><strong>Expires:</strong> ${key.expiryDate} | <strong>Type:</strong> ${key.keyType}</small>
                        <button onclick="copyKeyFromList('${key.keyCode}')" class="btn-copy" style="position: absolute; top: 10px; right: 10px; padding: 3px 8px; font-size: 10px;">ğŸ“‹</button>
                    </div>
                `).join('')}
            `;
            
            bulkList.classList.remove('hidden');
        }

        function exportBulkKeys() {
            if (bulkGeneratedKeys.length === 0) {
                alert('âŒ No bulk keys to export. Generate some keys first.');
                return;
            }
            
            const headers = ['Username', 'Key Code', 'Expiry Date', 'Key Type', 'Encryption Key', 'Created Date'];
            const csvContent = [
                headers.join(','),
                ...bulkGeneratedKeys.map(key => [
                    key.userName,
                    key.keyCode,
                    key.expiryDate,
                    key.keyType,
                    key.encryptionKey,
                    key.createdAt.split('T')[0]
                ].join(','))
            ].join('\n');
            
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `bulk-keys-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            URL.revokeObjectURL(url);
            
            alert(`âœ… Exported ${bulkGeneratedKeys.length} keys to CSV file!`);
            logActivity('bulk_keys_exported', `Exported ${bulkGeneratedKeys.length} keys to CSV`);
        }

        function clearBulkKeys() {
            if (bulkGeneratedKeys.length === 0) {
                alert('âŒ No bulk keys to clear.');
                return;
            }
            
            if (confirm(`ğŸ—‘ï¸ Clear ${bulkGeneratedKeys.length} bulk keys?\n\nThis will only clear the bulk view, not delete the keys from database.`)) {
                bulkGeneratedKeys = [];
                document.getElementById('bulkKeysList').classList.add('hidden');
                document.getElementById('exportBulkBtn').disabled = true;
                
                alert('âœ… Bulk keys view cleared!');
            }
        }

        // ===== STATISTICS =====
        function updateStatistics() {
            const localKeys = JSON.parse(localStorage.getItem('lms_ai_local_keys') || '{}');
            const allKeys = { ...keysDatabase, ...localKeys };
            const keys = Object.values(allKeys);
            const now = new Date();
            
            const totalKeys = keys.length;
            const activeKeys = keys.filter(k => k.active && new Date(k.expiry) > now).length;
            const expiredKeys = keys.filter(k => new Date(k.expiry) <= now).length;
            const totalDownloads = keys.reduce((sum, k) => sum + (k.download_count || 0), 0);
            
            document.getElementById('totalKeys').textContent = totalKeys;
            document.getElementById('activeKeys').textContent = activeKeys;
            document.getElementById('expiredKeys').textContent = expiredKeys;
            document.getElementById('totalDownloads').textContent = totalDownloads;
        }

        function calculateTodayStats() {
            const today = new Date().toISOString().split('T')[0];
            const todayActivities = activityLog.filter(log => 
                log.timestamp.split('T')[0] === today
            );
            
            const keysGenerated = todayActivities.filter(log => 
                log.type.includes('key_generated') || log.type.includes('bulk_keys_generated')
            ).length;
            
            const keysValidated = todayActivities.filter(log => 
                log.type.includes('validation')
            ).length;
            
            const downloads = todayActivities.filter(log => 
                log.type.includes('download')
            ).length;
            
            const logins = todayActivities.filter(log => 
                log.type.includes('admin_login') && !log.type.includes('failed')
            ).length;
            
            document.getElementById('todayKeysGenerated').textContent = keysGenerated;
            document.getElementById('todayKeysValidated').textContent = keysValidated;
            document.getElementById('todayDownloads').textContent = downloads;
            document.getElementById('todayLogins').textContent = logins;
        }

        function calculateSystemInfo() {
            const localKeys = JSON.parse(localStorage.getItem('lms_ai_local_keys') || '{}');
            const systemSettings = JSON.parse(localStorage.getItem('lms_ai_system_settings') || '{}');
            const activityLog = JSON.parse(localStorage.getItem('lms_ai_activity_log') || '[]');
            
            const totalSize = JSON.stringify(localKeys).length + 
                            JSON.stringify(systemSettings).length + 
                            JSON.stringify(activityLog).length;
            
            const sizeInKB = (totalSize / 1024).toFixed(2);
            
            document.getElementById('databaseSize').textContent = `${sizeInKB} KB`;
            document.getElementById('environmentInfo').textContent = 
                window.location.hostname === 'localhost' ? 'Development' : 'Production';
        }

        // ===== ACTIVITY LOG =====
        function refreshActivityLog() {
            const stored = localStorage.getItem('lms_ai_activity_log');
            if (stored) {
                activityLog = JSON.parse(stored);
            }
            filterActivityLog();
        }

        function filterActivityLog() {
            const filter = document.getElementById('logFilter').value;
            const logDiv = document.getElementById('activityLog');
            
            let filteredLog = activityLog;
            if (filter !== 'all') {
                filteredLog = activityLog.filter(entry => entry.type.includes(filter));
            }
            
            if (filteredLog.length === 0) {
                logDiv.innerHTML = '<div style="text-align: center; color: #7f8c8d; padding: 20px;"><p>ğŸ“Š No activities found.</p></div>';
                return;
            }
            
            logDiv.innerHTML = filteredLog.slice(0, 20).map(entry => `
                <div class="key-item" style="font-size: 12px; border-left-color: ${getLogColor(entry.type)};">
                    <strong>${entry.type.toUpperCase().replace(/_/g, ' ')}</strong><br>
                    <small>${new Date(entry.timestamp).toLocaleString()}</small><br>
                    ${entry.message}
                </div>
            `).join('');
        }

        function getLogColor(type) {
            if (type.includes('error') || type.includes('failed')) return '#e74c3c';
            if (type.includes('success') || type.includes('generated') || type.includes('saved')) return '#27ae60';
            if (type.includes('login') || type.includes('admin')) return '#3498db';
            return '#95a5a6';
        }

        function clearActivityLog() {
            if (confirm('ğŸ—‘ï¸ Are you sure you want to clear the activity log?')) {
                activityLog = [];
                localStorage.removeItem('lms_ai_activity_log');
                refreshActivityLog();
                logActivity('log_cleared', 'Activity log cleared by administrator');
            }
        }

        async function testDatabaseConnection() {
            const statusText = document.getElementById('dbStatusText');
            const spinner = document.getElementById('dbSpinner');
            
            statusText.textContent = 'Testing connection...';
            spinner.style.display = 'inline-block';
            
            try {
                const response = await fetch(`${API_BASE}/test`);
                
                if (response.ok) {
                    const data = await response.json();
                    isDatabaseConnected = true;
                    statusText.textContent = `âœ… Functions connected - ${data.message}`;
                    statusText.style.color = '#27ae60';
                    logActivity('database_test', 'Database connection successful');
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                isDatabaseConnected = false;
                statusText.textContent = `âŒ Functions unavailable - Using localStorage only`;
                statusText.style.color = '#e74c3c';
                logActivity('database_test_failed', `Database connection failed: ${error.message}`);
            } finally {
                spinner.style.display = 'none';
            }
        }

        // ===== INITIALIZATION =====
        function initializeAdmin() {
            loadSystemSettings();
            refreshActivityLog();
            refreshKeyList();
            updateStatistics();
            calculateTodayStats();
            calculateSystemInfo();
            testDatabaseConnection();
            
            console.log('Admin panel initialized successfully');
            logActivity('admin_initialized', 'Admin panel loaded and initialized');
        }

       // ===== EVENT LISTENERS =====
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('loginPassword').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    attemptLogin();
                }
            });
            
            // Auto-refresh statistics every 30 seconds
            setInterval(() => {
                updateStatistics();
                calculateTodayStats();
            }, 30000);
            
            // Initialize EmailJS if configured
            loadSystemSettings();
        });

// ===== EMAILJS CONFIGURATION =====
        let emailJSInitialized = false;

        function initializeEmailJS() {
            if (systemSettings.emailService === 'emailjs' && systemSettings.emailjsPublicKey) {
                try {
                    emailjs.init(systemSettings.emailjsPublicKey);
                    emailJSInitialized = true;
                    console.log('EmailJS initialized successfully');
                    logActivity('emailjs_initialized', 'EmailJS service initialized');
                } catch (error) {
                    console.error('EmailJS initialization failed:', error);
                    emailJSInitialized = false;
                    logActivity('emailjs_failed', `EmailJS initialization failed: ${error.message}`);
                }
            }
        }

        // ===== EMAIL NOTIFICATION FUNCTIONS =====
        async function sendEmailNotification(type, data) {
            if (systemSettings.emailService === 'disabled') {
                console.log('Email notifications disabled');
                return;
            }
            
            try {
                if (systemSettings.emailService === 'netlify') {
                    await sendNetlifyFormEmail(type, data);
                } else if (systemSettings.emailService === 'emailjs') {
                    await sendEmailJSNotification(type, data);
                }
                
                console.log('Email notification sent:', type);
                logActivity('email_sent', `${type} notification sent successfully`);
            } catch (error) {
                console.error('Email send failed:', error);
                logActivity('email_failed', `Failed to send ${type}: ${error.message}`);
                
                // Show user-friendly error
                if (type === 'Test Email') {
                    alert(`âŒ Email test failed:\n${error.message}\n\nPlease check your EmailJS configuration.`);
                }
            }
        }

        async function sendNetlifyFormEmail(type, data) {
            const formData = new FormData();
            formData.append('form-name', 'contact');
            formData.append('name', 'LMS AI System');
            formData.append('email', systemSettings.notificationEmail);
            formData.append('subject', `LMS AI - ${type}`);
            formData.append('message', formatEmailMessage(type, data));
            formData.append('timestamp', new Date().toISOString());

            const response = await fetch('/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: new URLSearchParams(formData)
            });

            if (!response.ok) {
                throw new Error(`Netlify form submission failed: ${response.status}`);
            }
        }

        async function sendEmailJSNotification(type, data) {
            if (!emailJSInitialized) {
                initializeEmailJS();
            }
            
            if (!systemSettings.emailjsPublicKey || !systemSettings.emailjsServiceId || !systemSettings.emailjsTemplateId) {
                throw new Error('EmailJS configuration incomplete. Please check Service ID, Template ID, and Public Key.');
            }

            const templateParams = {
                to_email: systemSettings.notificationEmail,
                subject: `LMS AI - ${type}`,
                message: formatEmailMessage(type, data),
                timestamp: new Date().toLocaleString(),
                keyCode: data.keyCode || '',
                userName: data.userName || '',
                keyType: data.keyType || '',
                count: data.count || ''
            };

            console.log('Sending EmailJS with params:', templateParams);

            const result = await emailjs.send(
                systemSettings.emailjsServiceId,
                systemSettings.emailjsTemplateId,
                templateParams
            );

            console.log('EmailJS result:', result);
            return result;
        }

        function formatEmailMessage(type, data) {
            const timestamp = new Date().toLocaleString();
            
            switch (type) {
                case 'Key Validation':
                    return `ğŸ”‘ Key ${data.keyCode} was successfully validated by user "${data.userName}" at ${timestamp}.\n\nKey Type: ${data.keyType || 'STANDARD'}\nStatus: Valid and Active`;
                    
                case 'Key Generated':
                    return `âœ… New license key generated successfully!\n\nKey Code: ${data.keyCode}\nUser Name: ${data.userName}\nKey Type: ${data.keyType}\nCreated: ${timestamp}`;
                    
                case 'Bulk Keys Generated':
                    return `ğŸ“¦ Bulk key generation completed!\n\nCount: ${data.count} keys\nPrefix: ${data.prefix}\nKey Type: ${data.keyType}\nGenerated: ${timestamp}`;
                    
                case 'Script Download':
                    return `ğŸ“¥ User downloaded personalized script!\n\nUser: ${data.userName}\nKey: ${data.keyCode}\nDownload Time: ${timestamp}`;
                    
                case 'Key Status Changed':
                    return `ğŸ”„ Key status updated!\n\nKey: ${data.keyCode}\nUser: ${data.userName}\nNew Status: ${data.status}\nChanged: ${timestamp}`;
                    
                case 'Key Deleted':
                    return `ğŸ—‘ï¸ Key permanently deleted!\n\nKey: ${data.keyCode}\nUser: ${data.userName}\nDeleted: ${timestamp}`;
                    
                case 'Admin Login':
                    return `ğŸ” Administrator logged into admin panel at ${timestamp}.\n\nSession started successfully.`;
                    
                case 'Test Email':
                    return data.message || `âœ… EmailJS test successful!\n\nThis is a test notification from your LMS AI Assistant admin panel.\n\nSent: ${timestamp}\n\nIf you received this email, your notification system is working correctly!`;
                    
                default:
                    return `ğŸ“¬ LMS AI System Activity: ${type}\n\nTimestamp: ${timestamp}\n\nDetails: ${JSON.stringify(data, null, 2)}`;
            }
        }

        // ===== EMAIL SETTINGS FUNCTIONS =====
        function saveEmailSettings() {
            // Get values from form
            systemSettings.notificationEmail = document.getElementById('notificationEmail').value.trim();
            systemSettings.emailService = document.getElementById('emailService').value;
            systemSettings.emailjsPublicKey = document.getElementById('emailjsPublicKey').value.trim();
            systemSettings.emailjsServiceId = document.getElementById('emailjsServiceId').value.trim();
            systemSettings.emailjsTemplateId = document.getElementById('emailjsTemplateId').value.trim();
            
            // Validate settings
            if (systemSettings.emailService === 'emailjs') {
                if (!systemSettings.emailjsPublicKey) {
                    alert('âŒ Please enter EmailJS Public Key');
                    return;
                }
                if (!systemSettings.emailjsServiceId) {
                    alert('âŒ Please enter EmailJS Service ID');
                    return;
                }
                if (!systemSettings.emailjsTemplateId) {
                    alert('âŒ Please enter EmailJS Template ID');
                    return;
                }
            }
            
            if (systemSettings.emailService !== 'disabled' && !systemSettings.notificationEmail) {
                alert('âŒ Please enter notification email address');
                return;
            }
            
            // Save settings
            saveSystemSettings();
            
            // Initialize EmailJS if configured
            if (systemSettings.emailService === 'emailjs') {
                initializeEmailJS();
            }
            
            alert('âœ… Email settings saved successfully!');
            logActivity('email_settings_updated', `Email service: ${systemSettings.emailService}, Email: ${systemSettings.notificationEmail}`);
        }

        async function sendTestEmail() {
            const testEmail = document.getElementById('testEmailAddress').value.trim();
            const testSubject = document.getElementById('testEmailSubject').value.trim();
            const testMessage = document.getElementById('testEmailMessage').value.trim();
            
            if (!testEmail) {
                alert('âŒ Please enter a test email address');
                return;
            }
            
            if (systemSettings.emailService === 'disabled') {
                alert('âŒ Email service is disabled. Please configure email settings first.');
                return;
            }
            
            if (systemSettings.emailService === 'emailjs' && !emailJSInitialized) {
                alert('âŒ EmailJS not initialized. Please check your configuration and save settings first.');
                return;
            }
            
            // Show loading state
            const testBtn = event.target;
            const originalText = testBtn.textContent;
            testBtn.disabled = true;
            testBtn.textContent = 'ğŸ“§ Sending...';
            
            try {
                // Temporarily use test email
                const originalEmail = systemSettings.notificationEmail;
                systemSettings.notificationEmail = testEmail;
                
                await sendEmailNotification('Test Email', {
                    message: testMessage,
                    subject: testSubject,
                    testEmail: testEmail
                });
                
                // Restore original email
                systemSettings.notificationEmail = originalEmail;
                
                alert('âœ… Test email sent successfully!\n\nCheck your inbox (and spam folder).');
                logActivity('test_email_sent', `Test email sent to ${testEmail}`);
                
            } catch (error) {
                console.error('Test email error:', error);
                alert(`âŒ Failed to send test email:\n\n${error.message}\n\nPlease check your configuration.`);
                logActivity('test_email_failed', `Test email failed: ${error.message}`);
            } finally {
                // Restore button
                testBtn.disabled = false;
                testBtn.textContent = originalText;
            }
        }

        // ===== AUTO-TRIGGER EMAIL NOTIFICATIONS =====
        
        // Modify existing functions to send notifications
        const originalGenerateNewKey = generateNewKey;
        generateNewKey = function() {
            originalGenerateNewKey();
            
            if (currentGeneratedKey) {
                // Send notification after key generation
                setTimeout(() => {
                    sendEmailNotification('Key Generated', {
                        keyCode: currentGeneratedKey.keyCode,
                        userName: currentGeneratedKey.userName,
                        keyType: currentGeneratedKey.keyType
                    });
                }, 1000);
            }
        };

        const originalGenerateBulkKeys = generateBulkKeys;
        generateBulkKeys = function() {
            const count = parseInt(document.getElementById('bulkCount').value);
            const prefix = document.getElementById('bulkPrefix').value.trim();
            const keyType = document.getElementById('bulkType').value;
            
            originalGenerateBulkKeys();
            
            // Send notification after bulk generation
            setTimeout(() => {
                if (bulkGeneratedKeys.length > 0) {
                    sendEmailNotification('Bulk Keys Generated', {
                        count: count,
                        prefix: prefix,
                        keyType: keyType
                    });
                }
            }, 2000);
        };

        const originalAttemptLogin = attemptLogin;
        attemptLogin = function() {
            const password = document.getElementById('loginPassword').value;
            const currentPassword = getCurrentAdminPassword();
            
            if (password === currentPassword) {
                // Send login notification
                sendEmailNotification('Admin Login', {
                    timestamp: new Date().toISOString(),
                    ip: 'Hidden for security'
                });
            }
            
            originalAttemptLogin();
        };

        function getCurrentAdminPassword() {
            const stored = localStorage.getItem('lms_ai_system_settings');
            let currentPassword = 'admin2025';
            
            if (stored) {
                try {
                    const settings = JSON.parse(stored);
                    currentPassword = settings.adminPassword || 'admin2025';
                } catch (e) {
                    console.warn('Could not load settings');
                }
            }
            
            return currentPassword;
        }

        // Auto-save settings when changed
        function autoSaveSettings() {
            saveSystemSettings();
            initializeEmailJS();
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            // Ctrl+G to generate new key
            if (e.ctrlKey && e.key === 'g') {
                e.preventDefault();
                if (document.getElementById('adminContainer').style.display !== 'none') {
                    document.getElementById('userName').focus();
                }
            }
            
            // Ctrl+S to save current key
            if (e.ctrlKey && e.key === 's') {
                e.preventDefault();
                if (currentGeneratedKey && !document.getElementById('saveBtn').disabled) {
                    saveKeyToDatabase();
                }
            }
            
            // Escape to clear forms
            if (e.key === 'Escape') {
                if (document.getElementById('generatedKeyDisplay') && !document.getElementById('generatedKeyDisplay').classList.contains('hidden')) {
                    clearKeyForm();
                }
                if (document.getElementById('importSection') && !document.getElementById('importSection').classList.contains('hidden')) {
                    hideImportSection();
                }
            }
        });

        // Auto-cleanup old activity logs (keep last 100)
        function cleanupActivityLogs() {
            if (activityLog.length > 100) {
                activityLog = activityLog.slice(0, 100);
                localStorage.setItem('lms_ai_activity_log', JSON.stringify(activityLog));
            }
        }

        // Run cleanup every hour
        setInterval(cleanupActivityLogs, 3600000);

        // Warn before page unload if there's unsaved data
        window.addEventListener('beforeunload', function(e) {
            if (currentGeneratedKey && document.getElementById('saveBtn') && !document.getElementById('saveBtn').disabled) {
                e.preventDefault();
                e.returnValue = 'You have an unsaved generated key. Are you sure you want to leave?';
            }
        });

        // Initialize on load
        console.log('LMS AI Admin Panel v2.0.0 loaded successfully!');
        console.log('Features: Key Management, Bulk Generation, Email Notifications, Analytics');
        console.log('Keyboard shortcuts: Ctrl+G (Generate), Ctrl+S (Save), Esc (Clear)');
    // ===== MOBILE APP FEATURES =====
        function showQuickStats() {
            const stats = {
                total: document.getElementById('totalKeys').textContent,
                active: document.getElementById('activeKeys').textContent,
                expired: document.getElementById('expiredKeys').textContent,
                downloads: document.getElementById('totalDownloads').textContent
            };
            
            alert(`ğŸ“Š Quick Stats:\n\nğŸ”‘ Total Keys: ${stats.total}\nâœ… Active: ${stats.active}\nâŒ Expired: ${stats.expired}\nğŸ“¥ Downloads: ${stats.downloads}`);
        }

        function quickGenerateKey() {
            const userName = prompt('ğŸ‘¤ Enter user name:');
            if (!userName) return;
            
            const keyType = prompt('ğŸ·ï¸ Enter key type (STANDARD/PREMIUM/TEST):', 'STANDARD');
            if (!keyType) return;
            
            // Auto-fill form and generate
            document.getElementById('userName').value = userName;
            document.getElementById('keyType').value = keyType.toUpperCase();
            generateNewKey();
            
            if (currentGeneratedKey) {
                setTimeout(() => {
                    saveKeyToDatabase();
                }, 1000);
            }
        }

        function quickEmailTest() {
            const email = systemSettings.notificationEmail || prompt('ğŸ“§ Enter email to test:');
            if (!email) return;
            
            const originalEmail = systemSettings.notificationEmail;
            systemSettings.notificationEmail = email;
            
            sendEmailNotification('Quick Mobile Test', {
                message: 'This is a quick test from the mobile admin interface!'
            }).then(() => {
                alert('âœ… Quick test sent to: ' + email);
            }).catch(error => {
                alert('âŒ Test failed: ' + error.message);
            }).finally(() => {
                systemSettings.notificationEmail = originalEmail;
            });
        }

        // PWA Installation
        let deferredPrompt;
        
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            document.getElementById('pwaPrompt').style.display = 'block';
        });

        function installPWA() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        console.log('PWA installed');
                        document.getElementById('pwaPrompt').style.display = 'none';
                    }
                    deferredPrompt = null;
                });
            }
        }

        // ===== TWO-FACTOR AUTHENTICATION =====
        function toggle2FA() {
            const enabled = document.getElementById('twoFactorEnabled').value;
            const section = document.getElementById('twoFactorSection');
            
            if (enabled !== 'false') {
                section.classList.remove('hidden');
                if (enabled === 'backup') {
                    generateBackupCodes();
                }
            } else {
                section.classList.add('hidden');
            }
        }

        function generateBackupCodes() {
            const codes = [];
            for (let i = 0; i < 10; i++) {
                const code = Math.random().toString(36).substring(2, 8).toUpperCase();
                codes.push(`${i + 1}. ${code}-${Math.random().toString(36).substring(2, 6).toUpperCase()}`);
            }
            
            document.getElementById('backupCodes').value = codes.join('\n');
            
            // Store codes (in real app, these should be hashed)
            systemSettings.backupCodes = codes;
            saveSystemSettings();
            
            alert('ğŸ” New backup codes generated!\n\nSave these codes safely. Each can only be used once.');
        }

        function save2FASettings() {
            systemSettings.twoFactorEnabled = document.getElementById('twoFactorEnabled').value;
            systemSettings.twoFactorEmail = document.getElementById('twoFactorEmail').value.trim();
            
            saveSystemSettings();
            alert('âœ… 2FA settings saved successfully!');
            
            logActivity('2fa_settings_updated', `2FA enabled: ${systemSettings.twoFactorEnabled}`);
        }

        async function test2FA() {
            if (systemSettings.twoFactorEnabled === 'false') {
                alert('âŒ 2FA is not enabled');
                return;
            }
            
            if (systemSettings.twoFactorEnabled === 'email') {
                const code = Math.random().toString(36).substring(2, 8).toUpperCase();
                
                try {
                    await sendEmailNotification('2FA Test Code', {
                        message: `Your 2FA test code is: ${code}\n\nThis code expires in 5 minutes.`,
                        code: code
                    });
                    
                    const userCode = prompt('ğŸ“§ 2FA code sent to your email.\n\nEnter the code:');
                    if (userCode === code) {
                        alert('âœ… 2FA test successful!');
                    } else {
                        alert('âŒ Invalid code');
                    }
                } catch (error) {
                    alert('âŒ 2FA email test failed: ' + error.message);
                }
            } else if (systemSettings.twoFactorEnabled === 'backup') {
                const userCode = prompt('ğŸ” Enter one of your backup codes:');
                const codes = systemSettings.backupCodes || [];
                
                if (codes.some(code => code.includes(userCode))) {
                    alert('âœ… Backup code is valid!');
                } else {
                    alert('âŒ Invalid backup code');
                }
            }
        }

// ===== LOGIN SYSTEM WITH 2FA =====
        async function attemptLogin() {
            const password = document.getElementById('loginPassword').value;
            const errorDiv = document.getElementById('errorMessage');
            
            // Load current admin password from settings
            const stored = localStorage.getItem('lms_ai_system_settings');
            let currentPassword = 'admin2025'; // Default
            
            if (stored) {
                try {
                    const settings = JSON.parse(stored);
                    currentPassword = settings.adminPassword || 'admin2025';
                } catch (e) {
                    console.warn('Could not load settings, using default password');
                }
            }
            
            console.log('[DEBUG] Current admin password:', currentPassword);
            
            if (password !== currentPassword) {
                errorDiv.textContent = 'âŒ Invalid password! Access denied.';
                errorDiv.classList.remove('hidden');
                document.getElementById('loginPassword').value = '';
                document.getElementById('loginPassword').style.borderColor = '#e74c3c';
                
                setTimeout(() => {
                    errorDiv.classList.add('hidden');
                    document.getElementById('loginPassword').style.borderColor = '#bdc3c7';
                }, 3000);
                
                logActivity('admin_login_failed', 'Failed login attempt');
                return;
            }
            
            // Check if 2FA is enabled
            let require2FA = false;
            let settings = {};
            
            if (stored) {
                try {
                    settings = JSON.parse(stored);
                    require2FA = settings.twoFactorEnabled && settings.twoFactorEnabled !== 'false';
                } catch (e) {
                    console.warn('Could not parse 2FA settings');
                }
            }
            
            // Handle 2FA if enabled
            if (require2FA) {
                const success = await handle2FA(settings);
                if (!success) {
                    errorDiv.textContent = 'âŒ 2FA verification failed!';
                    errorDiv.classList.remove('hidden');
                    document.getElementById('loginPassword').value = '';
                    setTimeout(() => {
                        errorDiv.classList.add('hidden');
                    }, 3000);
                    return;
                }
            }
            
            // Successful login
            document.getElementById('loginContainer').style.display = 'none';
            document.getElementById('adminContainer').style.display = 'block';
            initializeAdmin();
            logActivity('admin_login', 'Administrator logged in' + (require2FA ? ' with 2FA' : ''));
        }

        async function handle2FA(settings) {
            if (settings.twoFactorEnabled === 'email') {
                const code = Math.random().toString(36).substring(2, 8).toUpperCase();
                
                try {
                    // Use the existing sendEmailNotification function
                    const originalEmail = systemSettings.notificationEmail;
                    systemSettings.notificationEmail = settings.twoFactorEmail || settings.notificationEmail;
                    
                    await sendEmailNotification('2FA Login Code', {
                        message: `Your login verification code is: ${code}\n\nThis code expires in 5 minutes.\n\nIf you didn't request this, please change your password immediately.`,
                        code: code
                    });
                    
                    systemSettings.notificationEmail = originalEmail;
                    
                    const userCode = prompt('ğŸ” Two-Factor Authentication Required\n\nA verification code has been sent to your email.\nEnter the 6-digit code:');
                    
                    return userCode === code;
                } catch (error) {
                    console.error('2FA email failed:', error);
                    alert('âŒ Failed to send 2FA code. Proceeding without 2FA verification.');
                    return true; // Allow login if email fails
                }
            } else if (settings.twoFactorEnabled === 'backup') {
                const userCode = prompt('ğŸ” Two-Factor Authentication Required\n\nEnter one of your backup codes:');
                if (!userCode) return false;
                
                const codes = settings.backupCodes || [];
                const isValidCode = codes.some(code => code.includes(userCode.toUpperCase()));
                
                if (isValidCode) {
                    // Remove used backup code
                    settings.backupCodes = codes.filter(code => !code.includes(userCode.toUpperCase()));
                    localStorage.setItem('lms_ai_system_settings', JSON.stringify(settings));
                    
                    if (settings.backupCodes.length === 0) {
                        alert('âš ï¸ Warning: You have used your last backup code!\n\nPlease generate new codes in the 2FA settings.');
                    }
                    
                    return true;
                }
                
                return false;
            }
            
            return true; // Default to success if 2FA type not recognized
        }

        async function prompt2FA() {
            const settings = JSON.parse(localStorage.getItem('lms_ai_system_settings') || '{}');
            
            if (settings.twoFactorEnabled === 'email') {
                const code = Math.random().toString(36).substring(2, 8).toUpperCase();
                
                try {
                    await sendEmailNotification('2FA Login Code', {
                        message: `Your login verification code is: ${code}\n\nThis code expires in 5 minutes.\n\nIf you didn't request this, please change your password immediately.`,
                        code: code
                    });
                    
                    const userCode = prompt('ğŸ” Two-Factor Authentication Required\n\nA verification code has been sent to your email.\nEnter the 6-digit code:');
                    
                    if (userCode === code) {
                        return true;
                    } else {
                        alert('âŒ Invalid verification code');
                        return false;
                    }
                } catch (error) {
                    alert('âŒ Failed to send 2FA code. Contact support.');
                    return false;
                }
            } else if (settings.twoFactorEnabled === 'backup') {
                const userCode = prompt('ğŸ” Two-Factor Authentication Required\n\nEnter one of your backup codes:');
                const codes = settings.backupCodes || [];
                
                if (codes.some(code => code.includes(userCode.toUpperCase()))) {
                    // Remove used backup code
                    settings.backupCodes = codes.filter(code => !code.includes(userCode.toUpperCase()));
                    localStorage.setItem('lms_ai_system_settings', JSON.stringify(settings));
                    
                    if (settings.backupCodes.length === 0) {
                        alert('âš ï¸ Warning: You have used your last backup code!\n\nPlease generate new codes in the 2FA settings.');
                    }
                    
                    return true;
                } else {
                    alert('âŒ Invalid backup code');
                    return false;
                }
            }
            
            return true;
        }

        // ===== KEY RENEWAL SYSTEM =====
        let renewalHistory = [];

        function searchKeyForRenewal() {
            const keyCode = document.getElementById('renewalKeyCode').value.trim().toUpperCase();
            if (!keyCode) {
                alert('âŒ Please enter a key code');
                return;
            }
            
            const localKeys = JSON.parse(localStorage.getItem('lms_ai_local_keys') || '{}');
            const keyData = localKeys[keyCode];
            
            if (!keyData) {
                alert('âŒ Key not found');
                document.getElementById('renewalKeyInfo').classList.add('hidden');
                document.getElementById('renewBtn').disabled = true;
                return;
            }
            
            // Display key information
            document.getElementById('renewalUserName').textContent = keyData.name;
            document.getElementById('renewalCurrentExpiry').textContent = keyData.expiry;
            document.getElementById('renewalKeyType').textContent = keyData.type || 'STANDARD';
            
            const now = new Date();
            const expiry = new Date(keyData.expiry);
            const isExpired = now > expiry;
            
            document.getElementById('renewalStatus').textContent = keyData.active ? 
                (isExpired ? 'ğŸ”´ Expired' : 'ğŸŸ¢ Active') : 'ğŸŸ¡ Inactive';
            
            document.getElementById('renewalKeyInfo').classList.remove('hidden');
            document.getElementById('renewBtn').disabled = false;
        }

        function processKeyRenewal() {
            const keyCode = document.getElementById('renewalKeyCode').value.trim().toUpperCase();
            const duration = document.getElementById('renewalDuration').value;
            const reason = document.getElementById('renewalReason').value;
            const notes = document.getElementById('renewalNotes').value.trim();
            
            const localKeys = JSON.parse(localStorage.getItem('lms_ai_local_keys') || '{}');
            const keyData = localKeys[keyCode];
            
            if (!keyData) {
                alert('âŒ Key not found');
                return;
            }
            
            let newExpiry;
            if (duration === 'custom') {
                const customDate = document.getElementById('customExpiryDate').value;
                if (!customDate) {
                    alert('âŒ Please select a custom expiry date');
                    return;
                }
                newExpiry = customDate;
            } else {
                const currentExpiry = new Date(keyData.expiry);
                const extensionMonths = parseInt(duration);
                currentExpiry.setMonth(currentExpiry.getMonth() + extensionMonths);
                newExpiry = currentExpiry.toISOString().split('T')[0];
            }
            
            const oldExpiry = keyData.expiry;
            
            // Update key
            keyData.expiry = newExpiry;
            keyData.active = true; // Reactivate if needed
            localKeys[keyCode] = keyData;
            localStorage.setItem('lms_ai_local_keys', JSON.stringify(localKeys));
            
            // Update main database
            if (keysDatabase[keyCode]) {
                keysDatabase[keyCode].expiry = newExpiry;
                keysDatabase[keyCode].active = true;
            }
            
            // Record renewal
            const renewal = {
                keyCode: keyCode,
                userName: keyData.name,
                oldExpiry: oldExpiry,
                newExpiry: newExpiry,
                reason: reason,
                notes: notes,
                processedBy: 'Administrator',
                processedAt: new Date().toISOString(),
                duration: duration === 'custom' ? 'Custom' : `+${duration} months`
            };
            
            renewalHistory.unshift(renewal);
            localStorage.setItem('lms_ai_renewal_history', JSON.stringify(renewalHistory));
            
            // Send notification
            sendEmailNotification('Key Renewed', {
                keyCode: keyCode,
                userName: keyData.name,
                oldExpiry: oldExpiry,
                newExpiry: newExpiry,
                reason: reason
            });
            
            alert(`âœ… Key renewed successfully!\n\nUser: ${keyData.name}\nOld Expiry: ${oldExpiry}\nNew Expiry: ${newExpiry}`);
            
            logActivity('key_renewed', `Key ${keyCode} renewed from ${oldExpiry} to ${newExpiry} (${reason})`);
            
            // Refresh displays
            refreshKeyList();
            updateStatistics();
            loadRenewalHistory();
            clearRenewalForm();
        }

        function clearRenewalForm() {
            document.getElementById('renewalKeyCode').value = '';
            document.getElementById('renewalNotes').value = '';
            document.getElementById('renewalKeyInfo').classList.add('hidden');
            document.getElementById('renewBtn').disabled = true;
        }

        function loadRenewalHistory() {
            const stored = localStorage.getItem('lms_ai_renewal_history');
            if (stored) {
                renewalHistory = JSON.parse(stored);
            }
            
            const historyDiv = document.getElementById('renewalHistory');
            
            if (renewalHistory.length === 0) {
                historyDiv.innerHTML = '<div style="text-align: center; color: #7f8c8d; padding: 20px;"><p>ğŸ“Š No renewals yet.</p></div>';
                return;
            }
            
            historyDiv.innerHTML = renewalHistory.slice(0, 10).map(renewal => `
                <div class="key-item" style="font-size: 12px; border-left-color: #27ae60;">
                    <strong>${renewal.userName} (${renewal.keyCode})</strong><br>
                    <small><strong>Extended:</strong> ${renewal.oldExpiry} â†’ ${renewal.newExpiry}</small><br>
                    <small><strong>Reason:</strong> ${renewal.reason} | <strong>Duration:</strong> ${renewal.duration}</small><br>
                    <small><strong>Processed:</strong> ${new Date(renewal.processedAt).toLocaleString()}</small>
                    ${renewal.notes ? `<br><small><strong>Notes:</strong> ${renewal.notes}</small>` : ''}
                </div>
            `).join('');
        }

        function exportRenewalHistory() {
            if (renewalHistory.length === 0) {
                alert('âŒ No renewal history to export');
                return;
            }
            
            const headers = ['Key Code', 'User Name', 'Old Expiry', 'New Expiry', 'Reason', 'Duration', 'Notes', 'Processed At', 'Processed By'];
            const csvContent = [
                headers.join(','),
                ...renewalHistory.map(renewal => [
                    renewal.keyCode,
                    renewal.userName,
                    renewal.oldExpiry,
                    renewal.newExpiry,
                    renewal.reason,
                    renewal.duration,
                    renewal.notes || '',
                    renewal.processedAt,
                    renewal.processedBy
                ].join(','))
            ].join('\n');
            
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `renewal-history-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            URL.revokeObjectURL(url);
            
            alert(`âœ… Exported ${renewalHistory.length} renewal records!`);
        }

        // Show/hide custom date field
        document.addEventListener('DOMContentLoaded', function() {
            if (document.getElementById('renewalDuration')) {
                document.getElementById('renewalDuration').addEventListener('change', function() {
                    const customField = document.getElementById('customDateField');
                    if (this.value === 'custom') {
                        customField.style.display = 'block';
                    } else {
                        customField.style.display = 'none';
                    }
                });
            }
        });

        // Load renewal history on init
        const originalInitializeAdmin = initializeAdmin;
        initializeAdmin = function() {
            originalInitializeAdmin();
            loadRenewalHistory();
        };
    </script>
</body>
</html>
