<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LMS AI - Admin Panel</title>
    <!-- EmailJS for notifications -->
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 900px;
            margin: 30px auto;
            padding: 20px;
            background: linear-gradient(135deg, #2c3e50, #3498db);
            min-height: 100vh;
        }
        .login-container {
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            text-align: center;
            max-width: 400px;
            margin: 100px auto;
        }
        .admin-container {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            display: none;
        }
        .login-container h1 {
            color: #2c3e50;
            margin-bottom: 30px;
        }
        .login-container input {
            width: 100%;
            padding: 15px;
            border: 2px solid #bdc3c7;
            border-radius: 8px;
            font-size: 16px;
            margin-bottom: 20px;
            text-align: center;
            box-sizing: border-box;
        }
        .login-container input:focus {
            border-color: #3498db;
            outline: none;
        }
        .login-container button {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            width: 100%;
        }
        .login-container button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
        }
        .error-message {
            color: #e74c3c;
            margin-top: 15px;
            font-weight: bold;
        }
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
        }
        .admin-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 2px solid #ecf0f1;
            border-radius: 10px;
            background: #f8f9fa;
        }
        .admin-section h3 {
            margin-top: 0;
            color: #34495e;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #2c3e50;
        }
        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #bdc3c7;
            border-radius: 8px;
            font-size: 14px;
            box-sizing: border-box;
            transition: border-color 0.3s;
        }
        input:focus, select:focus, textarea:focus {
            border-color: #3498db;
            outline: none;
            box-shadow: 0 0 5px rgba(52, 152, 219, 0.3);
        }
        button {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            margin-right: 10px;
            margin-bottom: 10px;
            transition: all 0.3s;
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
        }
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }
        .btn-success {
            background: linear-gradient(135deg, #27ae60, #229954) !important;
        }
        .btn-danger {
            background: linear-gradient(135deg, #e74c3c, #c0392b) !important;
        }
        .btn-warning {
            background: linear-gradient(135deg, #f39c12, #e67e22) !important;
        }
        .btn-secondary {
            background: linear-gradient(135deg, #95a5a6, #7f8c8d) !important;
        }
        .btn-copy {
            background: linear-gradient(135deg, #9b59b6, #8e44ad) !important;
            padding: 5px 10px !important;
            font-size: 12px !important;
            margin: 2px !important;
        }
        .generated-key {
            background: linear-gradient(135deg, #d5f4e6, #c8e6c9);
            padding: 20px;
            border-radius: 10px;
            margin-top: 15px;
            border-left: 5px solid #27ae60;
            box-shadow: 0 2px 10px rgba(39, 174, 96, 0.2);
        }
        .key-list {
            background: #ffffff;
            padding: 15px;
            border-radius: 10px;
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #ecf0f1;
        }
        .key-item {
            background: linear-gradient(135deg, #ffffff, #f8f9fa);
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            border-left: 4px solid #3498db;
            position: relative;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            transition: all 0.3s;
        }
        .key-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.15);
        }
        .key-item.expired {
            border-left-color: #e74c3c;
            opacity: 0.8;
        }
        .key-item.inactive {
            border-left-color: #f39c12;
            opacity: 0.9;
        }
        .delete-btn, .toggle-btn, .copy-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            padding: 5px 10px !important;
            font-size: 12px !important;
            margin: 0 !important;
        }
        .toggle-btn {
            right: 100px;
        }
        .copy-btn {
            right: 200px;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
            padding: 25px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(231, 76, 60, 0.3);
            transition: transform 0.3s;
        }
        .stat-card:hover {
            transform: translateY(-5px);
        }
        .stat-card.blue {
            background: linear-gradient(135deg, #3498db, #2980b9);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
        }
        .stat-card.green {
            background: linear-gradient(135deg, #27ae60, #229954);
            box-shadow: 0 5px 15px rgba(39, 174, 96, 0.3);
        }
        .stat-card.orange {
            background: linear-gradient(135deg, #f39c12, #e67e22);
            box-shadow: 0 5px 15px rgba(243, 156, 18, 0.3);
        }
        .stat-number {
            font-size: 36px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .stat-label {
            font-size: 14px;
            opacity: 0.9;
        }
        .hidden {
            display: none;
        }
        .success-message {
            background: linear-gradient(135deg, #d5f4e6, #c8e6c9);
            color: #27ae60;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 5px solid #27ae60;
            font-weight: bold;
        }
        .database-status {
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 5px solid #3498db;
            background: linear-gradient(135deg, #e3f2fd, #bbdefb);
        }
        .loading-spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- Hidden Netlify Form for Notifications -->
    <form name="contact" netlify hidden>
        <input type="text" name="name" />
        <input type="email" name="email" />
        <input type="text" name="subject" />
        <input type="text" name="message" />
        <input type="text" name="timestamp" />
    </form>

    <!-- Login Screen -->
    <div id="loginContainer" class="login-container">
        <h1>üîê Admin Login</h1>
        <p>Enter password to access admin panel:</p>
        <input type="password" id="loginPassword" placeholder="Enter admin password">
        <button onclick="attemptLogin()">üöÄ Login</button>
        <div id="errorMessage" class="error-message hidden"></div>
    </div>

    <!-- Admin Panel (Hidden) -->
    <div id="adminContainer" class="admin-container">
        <h1>üîë LMS AI Assistant - Admin Panel</h1>
        
        <!-- Header Controls -->
        <div style="text-align: right; margin-bottom: 20px; padding: 15px; background: #ecf0f1; border-radius: 8px;">
            <span style="color: #7f8c8d; margin-right: 20px;">üë§ Administrator</span>
            <button onclick="testDatabaseConnection()" class="btn-secondary">üîç Test DB</button>
            <button onclick="logout()" class="btn-danger">üö™ Logout</button>
        </div>
        
        <!-- Database Connection Status -->
        <div class="database-status" id="dbStatus">
            <strong>üóÑÔ∏è Database Status:</strong> 
            <span id="dbStatusText">Checking connection...</span>
            <span class="loading-spinner" id="dbSpinner"></span>
        </div>
        
        <!-- Statistics Dashboard -->
        <div class="admin-section">
            <h3>üìä System Statistics</h3>
            <div class="stats">
                <div class="stat-card blue">
                    <div class="stat-number" id="totalKeys">0</div>
                    <div class="stat-label">Total Keys</div>
                </div>
                <div class="stat-card green">
                    <div class="stat-number" id="activeKeys">0</div>
                    <div class="stat-label">Active Keys</div>
                </div>
                <div class="stat-card red">
                    <div class="stat-number" id="expiredKeys">0</div>
                    <div class="stat-label">Expired Keys</div>
                </div>
                <div class="stat-card orange">
                    <div class="stat-number" id="totalDownloads">0</div>
                    <div class="stat-label">Total Downloads</div>
                </div>
            </div>
        </div>
<!-- Key Generator -->
        <div class="admin-section">
            <h3>üîë Generate New Key</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <div>
                    <div class="form-group">
                        <label for="userName">üë§ User Name:</label>
                        <input type="text" id="userName" placeholder="Enter full name (e.g., John Smith)">
                    </div>
                    <div class="form-group">
                        <label for="keyDuration">‚è∞ License Duration:</label>
                        <select id="keyDuration">
                            <option value="1">1 Month</option>
                            <option value="3">3 Months</option>
                            <option value="6">6 Months</option>
                            <option value="12" selected>1 Year</option>
                            <option value="24">2 Years</option>
                            <option value="0">Permanent</option>
                        </select>
                    </div>
                </div>
                <div>
                    <div class="form-group">
                        <label for="keyType">üè∑Ô∏è Key Type:</label>
                        <select id="keyType">
                            <option value="STANDARD">Standard User</option>
                            <option value="PREMIUM">Premium User</option>
                            <option value="ADMIN">Admin User</option>
                            <option value="TEST">Test User</option>
                            <option value="STUDENT">Student User</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="userEmail">üìß Email (Optional):</label>
                        <input type="email" id="userEmail" placeholder="user@example.com">
                    </div>
                </div>
            </div>
            
            <div style="margin-top: 20px;">
                <button onclick="generateNewKey()" class="btn-success">üîë Generate Key</button>
                <button onclick="saveKeyToDatabase()" id="saveBtn" class="btn-success" disabled>üíæ Save to Database</button>
                <button onclick="clearKeyForm()" class="btn-secondary">üóëÔ∏è Clear Form</button>
            </div>
            
            <div id="generatedKeyDisplay" class="generated-key hidden">
                <h4>‚úÖ New Key Generated Successfully!</h4>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div>
                        <strong>üîë Key Code:</strong> <span id="newKeyCode" style="font-family: monospace; background: #fff; padding: 5px; border-radius: 3px;"></span><br>
                        <strong>üë§ User Name:</strong> <span id="newKeyName"></span><br>
                        <strong>‚è∞ Expires:</strong> <span id="newKeyExpiry"></span>
                    </div>
                    <div>
                        <strong>üè∑Ô∏è Type:</strong> <span id="newKeyType"></span><br>
                        <strong>üîê Encryption Key:</strong> <small id="newEncryptionKey" style="font-family: monospace; word-break: break-all;"></small>
                    </div>
                </div>
                <button onclick="copyKeyToClipboard()" class="btn-secondary" style="margin-top: 10px;">üìã Copy Key</button>
            </div>
            
            <div id="saveSuccess" class="success-message hidden">
                ‚úÖ Key saved successfully! It will work immediately on the main site.
            </div>
        </div>

        <!-- Admin Settings -->
        <div class="admin-section">
            <h3>‚öôÔ∏è System Settings</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
                <div>
                    <h4>üîê Security Settings</h4>
                    <div class="form-group">
                        <label for="newAdminPassword">New Admin Password:</label>
                        <input type="password" id="newAdminPassword" placeholder="Enter new password">
                    </div>
                    <button onclick="changeAdminPassword()" class="btn-warning">üîë Update Password</button>
                    
<h4 style="margin-top: 20px;">üìß Email Settings</h4>
                    <div class="form-group">
                        <label for="notificationEmail">Notification Email:</label>
                        <input type="email" id="notificationEmail" placeholder="admin@yoursite.com">
                    </div>
                    <div class="form-group">
                        <label for="emailService">Email Service:</label>
                        <select id="emailService" onchange="toggleEmailFields()">
                            <option value="disabled">Disabled</option>
                            <option value="netlify">Netlify Forms</option>
                            <option value="emailjs">EmailJS (Free)</option>
                        </select>
                    </div>
                    <div id="emailjsFields" class="hidden">
                        <div class="form-group">
                            <label for="emailjsPublicKey">EmailJS Public Key:</label>
                            <input type="text" id="emailjsPublicKey" placeholder="Your EmailJS public key">
                            <small style="color: #666; font-size: 12px;">Found in EmailJS Dashboard ‚Üí Account ‚Üí General</small>
                        </div>
                        <div class="form-group">
                            <label for="emailjsServiceId">EmailJS Service ID:</label>
                            <input type="text" id="emailjsServiceId" placeholder="service_xxxxxxx">
                            <small style="color: #666; font-size: 12px;">Found in EmailJS Dashboard ‚Üí Email Services</small>
                        </div>
                        <div class="form-group">
                            <label for="emailjsTemplateId">EmailJS Template ID:</label>
                            <input type="text" id="emailjsTemplateId" placeholder="template_xxxxxxx">
                            <small style="color: #666; font-size: 12px;">Found in EmailJS Dashboard ‚Üí Email Templates</small>
                        </div>
                        <p style="font-size: 12px; color: #666; background: #f8f9fa; padding: 10px; border-radius: 5px; border-left: 3px solid #3498db;">
                            üìù <strong>Setup Guide:</strong> <a href="https://emailjs.com" target="_blank">Create free EmailJS account</a> ‚Üí 
                            Connect Gmail ‚Üí Create template ‚Üí Copy IDs above
                        </p>
                    </div>
                    <div style="margin-top: 15px;">
                        <button onclick="saveEmailSettings()" class="btn-success">üíæ Save Email Settings</button>
                        <button onclick="sendTestEmail()" class="btn-secondary">üìß Test Email</button>
                    </div>
                
                <div>
                    <h4>üí≥ Payment Settings</h4>
                    <div class="form-group">
                        <label for="paypalClientId">PayPal Client ID:</label>
                        <input type="text" id="paypalClientId" placeholder="Your PayPal client ID">
                    </div>
                    <div class="form-group">
                        <label for="paypalEnvironment">PayPal Environment:</label>
                        <select id="paypalEnvironment">
                            <option value="sandbox">Sandbox (Testing)</option>
                            <option value="production">Production (Live)</option>
                        </select>
                    </div>
                    <button onclick="savePayPalSettings()" class="btn-success">üíæ Save PayPal Settings</button>
                    
                    <h4 style="margin-top: 20px;">üí∞ Pricing</h4>
                    <div class="form-group">
                        <label for="keyPrice">Price per Key (USD):</label>
                        <input type="number" id="keyPrice" placeholder="29.99" step="0.01">
                    </div>
                    <button onclick="savePricingSettings()" class="btn-success">üíæ Save Pricing</button>
                </div>
            </div>
        </div>

        <!-- Bulk Key Generation -->
        <div class="admin-section">
            <h3>üì¶ Bulk Key Generation</h3>
            <p>Generate multiple keys at once for bulk distribution.</p>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px;">
                <div>
                    <div class="form-group">
                        <label for="bulkCount">Number of Keys:</label>
                        <input type="number" id="bulkCount" min="1" max="1000" value="10" placeholder="10">
                    </div>
                    <div class="form-group">
                        <label for="bulkPrefix">Name Prefix:</label>
                        <input type="text" id="bulkPrefix" value="User" placeholder="User, Student, Trial">
                    </div>
                </div>
                <div>
                    <div class="form-group">
                        <label for="bulkDuration">Duration (All Keys):</label>
                        <select id="bulkDuration">
                            <option value="1">1 Month</option>
                            <option value="3">3 Months</option>
                            <option value="6">6 Months</option>
                            <option value="12" selected>1 Year</option>
                            <option value="24">2 Years</option>
                            <option value="0">Permanent</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="bulkType">Key Type (All Keys):</label>
                        <select id="bulkType">
                            <option value="STANDARD">Standard</option>
                            <option value="PREMIUM">Premium</option>
                            <option value="STUDENT">Student</option>
                            <option value="TRIAL">Trial</option>
                            <option value="BULK">Bulk</option>
                        </select>
                    </div>
                </div>
                <div>
                    <div class="form-group">
                        <label for="bulkStartNumber">Start Number:</label>
                        <input type="number" id="bulkStartNumber" value="1" min="1" placeholder="1">
                    </div>
                    <div class="form-group">
                        <label for="bulkPadding">Number Padding:</label>
                        <select id="bulkPadding">
                            <option value="1">1 (User1, User2)</option>
                            <option value="2">2 (User01, User02)</option>
                            <option value="3" selected>3 (User001, User002)</option>
                            <option value="4">4 (User0001, User0002)</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <div style="margin-top: 20px;">
                <button onclick="generateBulkKeys()" class="btn-success">üì¶ Generate Bulk Keys</button>
                <button onclick="exportBulkKeys()" class="btn-warning" id="exportBulkBtn" disabled>üì§ Export as CSV</button>
                <button onclick="clearBulkKeys()" class="btn-danger">üóëÔ∏è Clear Bulk</button>
            </div>
            
            <div id="bulkKeysList" class="key-list hidden" style="max-height: 300px;">
                <!-- Bulk keys will appear here -->
            </div>
        </div>
<!-- Key Management -->
        <div class="admin-section">
            <h3>üìã Key Database Management</h3>
            <div style="margin-bottom: 15px;">
                <button onclick="refreshKeyList()" class="btn-success">üîÑ Refresh List</button>
                <button onclick="loadFromDatabase()" class="btn-success">‚òÅÔ∏è Load from Database</button>
                <button onclick="exportDatabase()" class="btn-warning">üì§ Export Database</button>
                <button onclick="showImportSection()" class="btn-secondary">üì• Backup/Restore</button>
                <span style="margin-left: 20px; color: #7f8c8d; font-size: 14px;" id="keyCount">0 keys loaded</span>
            </div>
            
            <div id="keyList" class="key-list">
                <div style="text-align: center; color: #7f8c8d; padding: 40px;">
                    <h4>üîç Loading keys...</h4>
                    <p>Please wait while we fetch the key database.</p>
                </div>
            </div>
        </div>

        <!-- Import/Export Section -->
        <div id="importSection" class="admin-section hidden">
            <h3>üì• Database Backup & Restore</h3>
            <p><strong>üìã Instructions:</strong></p>
            <ul>
                <li><strong>Backup:</strong> Copy the JSON content below and save it safely</li>
                <li><strong>Restore:</strong> Paste JSON content and click restore (overwrites current database)</li>
                <li><strong>Database File:</strong> You can also download as a file and upload to your server</li>
            </ul>
            
            <div class="form-group">
                <label for="exportData">üóÑÔ∏è Database JSON Content:</label>
                <textarea id="exportData" placeholder="Database JSON content will appear here..." style="height: 300px;"></textarea>
            </div>
            
            <div style="margin-top: 15px;">
                <button onclick="copyToClipboard()" class="btn-success">üìã Copy to Clipboard</button>
                <button onclick="downloadDatabase()" class="btn-success">üíæ Download File</button>
                <button onclick="restoreFromJson()" class="btn-warning">üì• Restore from JSON</button>
                <button onclick="hideImportSection()" class="btn-secondary">‚ùå Close</button>
            </div>
        </div>

        <!-- System Logs -->
        <div class="admin-section">
            <h3>üìú System Activity Log</h3>
            <div style="margin-bottom: 15px;">
                <button onclick="refreshActivityLog()" class="btn-success">üîÑ Refresh</button>
                <button onclick="clearActivityLog()" class="btn-danger">üóëÔ∏è Clear Log</button>
                <select id="logFilter" onchange="filterActivityLog()" style="margin-left: 10px; width: auto;">
                    <option value="all">All Activities</option>
                    <option value="validation">Key Validations</option>
                    <option value="creation">Key Creation</option>
                    <option value="download">Downloads</option>
                    <option value="error">Errors</option>
                    <option value="admin">Admin Actions</option>
                </select>
            </div>
            
            <div id="activityLog" class="key-list" style="max-height: 250px;">
                <div style="text-align: center; color: #7f8c8d; padding: 20px;">
                    <p>üìä Activity log will appear here...</p>
                </div>
            </div>
        </div>

        <!-- Email Test & Analytics -->
        <div class="admin-section">
            <h3>üìä Analytics & Testing</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
                <div>
<div>
                    <h4>üìß Email Testing</h4>
                    <div class="form-group">
                        <label for="testEmailAddress">Test Email Address:</label>
                        <input type="email" id="testEmailAddress" placeholder="test@example.com">
                    </div>
                    <div class="form-group">
                        <label for="testEmailSubject">Test Subject:</label>
                        <input type="text" id="testEmailSubject" value="LMS AI Admin Test" placeholder="Test subject">
                    </div>
                    <div class="form-group">
                        <label for="testEmailMessage">Test Message:</label>
                        <textarea id="testEmailMessage" placeholder="Test message content" style="height: 100px;">‚úÖ EmailJS test successful!

This is a test notification from your LMS AI Assistant admin panel.

If you received this email, your notification system is working correctly!

üéâ Your email notifications are now active and will send alerts for:
- New key generations
- Key validations
- Admin logins
- Bulk key operations

Happy licensing! üöÄ</textarea>
                    </div>
                    <button onclick="sendTestEmail()" class="btn-secondary">üìß Send Test Email</button>
                    
                    <div style="margin-top: 15px; padding: 10px; background: #e3f2fd; border-radius: 5px; border-left: 3px solid #2196F3;">
                        <small>
                            <strong>üí° Test Tips:</strong><br>
                            ‚Ä¢ Make sure to save email settings first<br>
                            ‚Ä¢ Check spam folder if email doesn't arrive<br>
                            ‚Ä¢ Gmail may take 1-2 minutes to deliver
                        </small>
                    </div>
                </div>
                <div>
                    <h4>üìà Quick Stats</h4>
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid #3498db;">
                        <p><strong>üìÖ Today's Activity:</strong></p>
                        <ul style="margin: 10px 0; padding-left: 20px;">
                            <li>Keys Generated: <span id="todayKeysGenerated">0</span></li>
                            <li>Keys Validated: <span id="todayKeysValidated">0</span></li>
                            <li>Scripts Downloaded: <span id="todayDownloads">0</span></li>
                            <li>Admin Logins: <span id="todayLogins">0</span></li>
                        </ul>
                        <button onclick="calculateTodayStats()" class="btn-secondary" style="font-size: 12px; padding: 8px 15px;">üîÑ Calculate</button>
                    </div>
                    
                    <h4 style="margin-top: 20px;">üîß System Info</h4>
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid #27ae60;">
                        <p><strong>üìù Version:</strong> 2.0.0</p>
                        <p><strong>üóÑÔ∏è Storage:</strong> localStorage + Netlify</p>
                        <p><strong>üåê Environment:</strong> <span id="environmentInfo">Production</span></p>
                        <p><strong>üìä Database Size:</strong> <span id="databaseSize">Calculating...</span></p>
                        <button onclick="calculateSystemInfo()" class="btn-secondary" style="font-size: 12px; padding: 8px 15px;">üîÑ Refresh Info</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
<script>
        // ===== CONFIGURATION =====
        const API_BASE = '/.netlify/functions';
        
        // ===== GLOBAL VARIABLES =====
        let keysDatabase = {};
        let currentGeneratedKey = null;
        let activityLog = [];
        let isDatabaseConnected = false;
        let bulkGeneratedKeys = [];

        // ===== SYSTEM SETTINGS =====
        let systemSettings = {
            adminPassword: 'admin2025',
            notificationEmail: '',
            emailService: 'disabled',
            paypalClientId: '',
            paypalEnvironment: 'sandbox',
            keyPrice: 29.99,
            emailjsPublicKey: '',
            emailjsServiceId: '',
            emailjsTemplateId: ''
        };

        function loadSystemSettings() {
            const stored = localStorage.getItem('lms_ai_system_settings');
            if (stored) {
                try {
                    systemSettings = { ...systemSettings, ...JSON.parse(stored) };
                } catch (e) {
                    console.warn('Could not load system settings');
                }
            }
            
            // Update UI if elements exist
            setTimeout(() => {
                if (document.getElementById('notificationEmail')) {
                    document.getElementById('notificationEmail').value = systemSettings.notificationEmail;
                    document.getElementById('emailService').value = systemSettings.emailService;
                    document.getElementById('paypalClientId').value = systemSettings.paypalClientId;
                    document.getElementById('paypalEnvironment').value = systemSettings.paypalEnvironment;
                    document.getElementById('keyPrice').value = systemSettings.keyPrice;
                    document.getElementById('emailjsPublicKey').value = systemSettings.emailjsPublicKey;
                    document.getElementById('emailjsServiceId').value = systemSettings.emailjsServiceId;
                    document.getElementById('emailjsTemplateId').value = systemSettings.emailjsTemplateId;
                    
                    toggleEmailFields();
                }
            }, 100);
        }

        function saveSystemSettings() {
            localStorage.setItem('lms_ai_system_settings', JSON.stringify(systemSettings));
        }

        // ===== LOGIN SYSTEM =====
        function attemptLogin() {
            const password = document.getElementById('loginPassword').value;
            const errorDiv = document.getElementById('errorMessage');
            
            // Load current admin password from settings
            const stored = localStorage.getItem('lms_ai_system_settings');
            let currentPassword = 'admin2025'; // Default
            
            if (stored) {
                try {
                    const settings = JSON.parse(stored);
                    currentPassword = settings.adminPassword || 'admin2025';
                } catch (e) {
                    console.warn('Could not load settings, using default password');
                }
            }
            
            console.log('Current admin password:', currentPassword); // For debugging
            
            if (password === currentPassword) {
                document.getElementById('loginContainer').style.display = 'none';
                document.getElementById('adminContainer').style.display = 'block';
                initializeAdmin();
                logActivity('admin_login', 'Administrator logged in');
            } else {
                errorDiv.textContent = '‚ùå Invalid password! Access denied.';
                errorDiv.classList.remove('hidden');
                document.getElementById('loginPassword').value = '';
                document.getElementById('loginPassword').style.borderColor = '#e74c3c';
                
                setTimeout(() => {
                    errorDiv.classList.add('hidden');
                    document.getElementById('loginPassword').style.borderColor = '#bdc3c7';
                }, 3000);
                
                logActivity('admin_login_failed', 'Failed login attempt');
            }
        }
        
        function logout() {
            if (confirm('üö™ Are you sure you want to logout?')) {
                document.getElementById('loginContainer').style.display = 'block';
                document.getElementById('adminContainer').style.display = 'none';
                document.getElementById('loginPassword').value = '';
                logActivity('admin_logout', 'Administrator logged out');
            }
        }

        function changeAdminPassword() {
            const newPassword = document.getElementById('newAdminPassword').value.trim();
            
            if (!newPassword) {
                alert('‚ùå Please enter a new password');
                return;
            }
            
            if (newPassword.length < 6) {
                alert('‚ùå Password must be at least 6 characters');
                return;
            }
            
            if (confirm(`üîë Change admin password to: ${newPassword}?\n\nMake sure you remember this password!`)) {
                systemSettings.adminPassword = newPassword;
                saveSystemSettings();
                
                // Also update the main site password
                localStorage.setItem('lms_ai_admin_password', newPassword);
                
                alert('‚úÖ Admin password updated successfully!\n\nNew password: ' + newPassword + '\n\nThis works for both admin panel and main site secret access.');
                document.getElementById('newAdminPassword').value = '';
                
                logActivity('admin_password_changed', 'Admin password updated to: ' + newPassword);
            }
        }

        // ===== ACTIVITY LOGGING =====
        function logActivity(type, message) {
            const timestamp = new Date().toISOString();
            const logEntry = {
                timestamp: timestamp,
                type: type,
                message: message,
                id: Date.now()
            };
            
            activityLog.unshift(logEntry);
            
            if (activityLog.length > 100) {
                activityLog = activityLog.slice(0, 100);
            }
            
            localStorage.setItem('lms_ai_activity_log', JSON.stringify(activityLog));
            console.log(`[${timestamp}] ${type}: ${message}`);
        }

        // ===== EMAIL FUNCTIONS =====
        function toggleEmailFields() {
            const service = document.getElementById('emailService').value;
            const fields = document.getElementById('emailjsFields');
            
            if (fields) {
                if (service === 'emailjs') {
                    fields.classList.remove('hidden');
                } else {
                    fields.classList.add('hidden');
                }
            }
        }

        function saveEmailSettings() {
            systemSettings.notificationEmail = document.getElementById('notificationEmail').value.trim();
            systemSettings.emailService = document.getElementById('emailService').value;
            systemSettings.emailjsPublicKey = document.getElementById('emailjsPublicKey').value.trim();
            systemSettings.emailjsServiceId = document.getElementById('emailjsServiceId').value.trim();
            systemSettings.emailjsTemplateId = document.getElementById('emailjsTemplateId').value.trim();
            
            saveSystemSettings();
            
            if (systemSettings.emailService === 'emailjs' && systemSettings.emailjsPublicKey) {
                emailjs.init(systemSettings.emailjsPublicKey);
            }
            
            alert('‚úÖ Email settings saved successfully!');
            logActivity('email_settings_updated', `Email service: ${systemSettings.emailService}`);
        }

        async function sendEmailNotification(type, data) {
            if (systemSettings.emailService === 'disabled') {
                return;
            }
            
            try {
                if (systemSettings.emailService === 'netlify') {
                    await sendNetlifyFormEmail(type, data);
                } else if (systemSettings.emailService === 'emailjs') {
                    await sendEmailJSNotification(type, data);
                }
                
                console.log('Email notification sent:', type);
                logActivity('email_sent', `${type} notification sent`);
            } catch (error) {
                console.error('Email send failed:', error);
                logActivity('email_failed', `Failed to send ${type}: ${error.message}`);
            }
        }
// ===== ALIAS FOR COMPATIBILITY =====
        function testEmailNotification() {
            sendTestEmail();
        }
        async function sendNetlifyFormEmail(type, data) {
            const formData = new FormData();
            formData.append('form-name', 'contact');
            formData.append('name', 'LMS AI System');
            formData.append('email', systemSettings.notificationEmail);
            formData.append('subject', `LMS AI - ${type}`);
            formData.append('message', formatEmailMessage(type, data));
            formData.append('timestamp', new Date().toISOString());

            const response = await fetch('/', {
                method: 'POST',
                body: formData
            });

            if (!response.ok) {
                throw new Error('Netlify form submission failed');
            }
        }

        async function sendEmailJSNotification(type, data) {
            if (!systemSettings.emailjsPublicKey || !systemSettings.emailjsServiceId || !systemSettings.emailjsTemplateId) {
                throw new Error('EmailJS not configured');
            }

            const templateParams = {
                to_email: systemSettings.notificationEmail,
                subject: `LMS AI - ${type}`,
                message: formatEmailMessage(type, data),
                timestamp: new Date().toLocaleString()
            };

            await emailjs.send(
                systemSettings.emailjsServiceId,
                systemSettings.emailjsTemplateId,
                templateParams
            );
        }

        function formatEmailMessage(type, data) {
            switch (type) {
                case 'Key Validation':
                    return `Key ${data.keyCode} was validated by ${data.userName} at ${new Date().toLocaleString()}`;
                case 'Key Generated':
                    return `New key ${data.keyCode} generated for ${data.userName}`;
                case 'Bulk Keys Generated':
                    return `${data.count} bulk keys generated with prefix ${data.prefix}`;
                case 'Script Download':
                    return `User ${data.userName} downloaded script using key ${data.keyCode}`;
                case 'Test Email':
                    return data.message || 'This is a test email from LMS AI Admin Panel';
                default:
                    return `LMS AI Activity: ${type}`;
            }
        }

async function sendTestEmail() {
            const testEmail = document.getElementById('testEmailAddress').value.trim();
            const testSubject = document.getElementById('testEmailSubject').value.trim();
            const testMessage = document.getElementById('testEmailMessage').value.trim();
            
            // Validation
            if (!testEmail) {
                alert('‚ùå Please enter a test email address');
                return;
            }
            
            if (systemSettings.emailService === 'disabled') {
                alert('‚ùå Email service is disabled.\n\nPlease:\n1. Choose EmailJS or Netlify Forms\n2. Configure settings\n3. Save settings\n4. Try test again');
                return;
            }
            
            if (systemSettings.emailService === 'emailjs') {
                if (!systemSettings.emailjsPublicKey || !systemSettings.emailjsServiceId || !systemSettings.emailjsTemplateId) {
                    alert('‚ùå EmailJS configuration incomplete.\n\nPlease fill in:\n‚Ä¢ Public Key\n‚Ä¢ Service ID\n‚Ä¢ Template ID\n\nThen save settings and try again.');
                    return;
                }
            }
            
            // Show loading state
            const testBtn = event.target;
            const originalText = testBtn.textContent;
            testBtn.disabled = true;
            testBtn.textContent = 'üìß Sending...';
            
            try {
                console.log('Starting test email...');
                
                // Temporarily use test email
                const originalEmail = systemSettings.notificationEmail;
                systemSettings.notificationEmail = testEmail;
                
                await sendEmailNotification('Test Email', {
                    message: testMessage,
                    subject: testSubject,
                    testEmail: testEmail
                });
                
                // Restore original email
                systemSettings.notificationEmail = originalEmail;
                
                alert('‚úÖ Test email sent successfully!\n\nüìß Check your inbox: ' + testEmail + '\n\nüí° If you don\'t see it, check your spam folder.\n\nGmail may take 1-2 minutes to deliver.');
                logActivity('test_email_sent', `Test email sent to ${testEmail} via ${systemSettings.emailService}`);
                
            } catch (error) {
                console.error('Test email error:', error);
                
                let errorMessage = '‚ùå Failed to send test email:\n\n';
                
                if (error.message.includes('EmailJS')) {
                    errorMessage += 'üîß EmailJS Error:\n' + error.message + '\n\nüí° Check your EmailJS configuration:\n‚Ä¢ Public Key\n‚Ä¢ Service ID\n‚Ä¢ Template ID\n‚Ä¢ Gmail service connection';
                } else if (error.message.includes('Netlify')) {
                    errorMessage += 'üîß Netlify Forms Error:\n' + error.message + '\n\nüí° Make sure Netlify Forms are enabled on your site.';
                } else {
                    errorMessage += error.message;
                }
                
                alert(errorMessage);
                logActivity('test_email_failed', `Test email failed: ${error.message}`);
            } finally {
                // Restore button
                testBtn.disabled = false;
                testBtn.textContent = originalText;
            }
        }

        // ===== COMPATIBILITY ALIAS =====
        function testEmailNotification() {
            sendTestEmail();
        }
function savePayPalSettings() {
            systemSettings.paypalClientId = document.getElementById('paypalClientId').value.trim();
            systemSettings.paypalEnvironment = document.getElementById('paypalEnvironment').value;
            
            saveSystemSettings();
            alert('‚úÖ PayPal settings saved successfully!');
            
            logActivity('paypal_settings_updated', `Environment: ${systemSettings.paypalEnvironment}`);
        }

        function savePricingSettings() {
            const price = parseFloat(document.getElementById('keyPrice').value);
            if (isNaN(price) || price < 0) {
                alert('‚ùå Please enter a valid price');
                return;
            }
            
            systemSettings.keyPrice = price;
            saveSystemSettings();
            alert(`‚úÖ Pricing updated: $${price.toFixed(2)} per key`);
            
            logActivity('pricing_updated', `Key price set to $${price.toFixed(2)}`);
        }

        // ===== KEY GENERATION =====
        function generateNewKey() {
            const userName = document.getElementById('userName').value.trim();
            const duration = parseInt(document.getElementById('keyDuration').value);
            const keyType = document.getElementById('keyType').value;
            const userEmail = document.getElementById('userEmail').value.trim();

            if (!userName) {
                alert('‚ùå Please enter a user name');
                return;
            }

            const namePrefix = userName.toUpperCase().replace(/[^A-Z]/g, '').substring(0, 4).padEnd(4, 'X');
            const year = new Date().getFullYear();
            const random = Math.random().toString(36).substring(2, 8).toUpperCase();
            
            const keyCode = `${namePrefix}-${year}-${random}`;
            
            let expiryDate;
            if (duration === 0) {
                expiryDate = "2099-12-31";
            } else {
                const expiry = new Date();
                expiry.setMonth(expiry.getMonth() + duration);
                expiryDate = expiry.toISOString().split('T')[0];
            }

            const encryptionKey = `${userName.toLowerCase().replace(/\s+/g, '-')}-secret-key-${year}`;

            currentGeneratedKey = {
                keyCode: keyCode,
                userName: userName,
                expiryDate: expiryDate,
                encryptionKey: encryptionKey,
                keyType: keyType,
                userEmail: userEmail,
                createdAt: new Date().toISOString(),
                active: true,
                downloadCount: 0
            };

            document.getElementById('newKeyCode').textContent = keyCode;
            document.getElementById('newKeyName').textContent = userName;
            document.getElementById('newKeyExpiry').textContent = expiryDate;
            document.getElementById('newKeyType').textContent = keyType;
            document.getElementById('newEncryptionKey').textContent = encryptionKey.substring(0, 30) + '...';
            document.getElementById('generatedKeyDisplay').classList.remove('hidden');
            document.getElementById('saveSuccess').classList.add('hidden');
            
            document.getElementById('saveBtn').disabled = false;
            
            logActivity('key_generated', `Generated key ${keyCode} for ${userName}`);
            
            // Send email notification
            sendEmailNotification('Key Generated', {
                keyCode: keyCode,
                userName: userName,
                keyType: keyType
            });
        }

        async function saveKeyToDatabase() {
            if (!currentGeneratedKey) {
                alert('‚ùå Please generate a key first!');
                return;
            }

            const saveBtn = document.getElementById('saveBtn');
            const originalText = saveBtn.textContent;
            saveBtn.disabled = true;
            saveBtn.textContent = 'üíæ Saving...';

            try {
                const localKeys = JSON.parse(localStorage.getItem('lms_ai_local_keys') || '{}');
                localKeys[currentGeneratedKey.keyCode] = {
                    name: currentGeneratedKey.userName,
                    expiry: currentGeneratedKey.expiryDate,
                    active: currentGeneratedKey.active,
                    encryptionKey: currentGeneratedKey.encryptionKey,
                    type: currentGeneratedKey.keyType,
                    created: currentGeneratedKey.createdAt.split('T')[0],
                    download_count: 0
                };
                localStorage.setItem('lms_ai_local_keys', JSON.stringify(localKeys));
                
                keysDatabase[currentGeneratedKey.keyCode] = localKeys[currentGeneratedKey.keyCode];
                
                try {
                    const response = await fetch(`${API_BASE}/create-key`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            keyCode: currentGeneratedKey.keyCode,
                            userName: currentGeneratedKey.userName,
                            expiryDate: currentGeneratedKey.expiryDate,
                            encryptionKey: currentGeneratedKey.encryptionKey,
                            keyType: currentGeneratedKey.keyType,
                            adminPassword: systemSettings.adminPassword
                        })
                    });

                    if (response.ok) {
                        document.getElementById('saveSuccess').innerHTML = '‚úÖ Key saved to database and localStorage!';
                        logActivity('key_saved_both', `Key ${currentGeneratedKey.keyCode} saved to both database and localStorage`);
                    } else {
                        throw new Error('Database unavailable');
                    }
                } catch (dbError) {
                    document.getElementById('saveSuccess').innerHTML = '‚úÖ Key saved locally! (Will work immediately on main site)';
                    logActivity('key_saved_local_only', `Key ${currentGeneratedKey.keyCode} saved to localStorage only`);
                }
                
                document.getElementById('saveSuccess').classList.remove('hidden');
                
            } catch (error) {
                console.error('Save failed:', error);
                alert('‚ùå Failed to save key: ' + error.message);
                logActivity('key_save_failed', `Failed to save key: ${error.message}`);
            } finally {
                saveBtn.disabled = false;
                saveBtn.textContent = originalText;
                refreshKeyList();
                updateStatistics();
            }
        }

        function clearKeyForm() {
            document.getElementById('userName').value = '';
            document.getElementById('userEmail').value = '';
            document.getElementById('keyDuration').value = '12';
            document.getElementById('keyType').value = 'STANDARD';
            document.getElementById('generatedKeyDisplay').classList.add('hidden');
            document.getElementById('saveSuccess').classList.add('hidden');
            document.getElementById('saveBtn').disabled = true;
            currentGeneratedKey = null;
        }

        function copyKeyToClipboard() {
            if (currentGeneratedKey) {
                navigator.clipboard.writeText(currentGeneratedKey.keyCode).then(() => {
                    alert('üìã Key copied to clipboard!');
                }).catch(() => {
                    const textArea = document.createElement('textarea');
                    textArea.value = currentGeneratedKey.keyCode;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    alert('üìã Key copied to clipboard!');
                });
            }
        }

        // ===== KEY MANAGEMENT =====
        function refreshKeyList() {
            const keyListDiv = document.getElementById('keyList');
            const localKeys = JSON.parse(localStorage.getItem('lms_ai_local_keys') || '{}');
            const allKeys = { ...localKeys, ...keysDatabase };
            const keyCount = Object.keys(allKeys).length;
            
            document.getElementById('keyCount').textContent = `${keyCount} keys loaded`;

            if (keyCount === 0) {
                keyListDiv.innerHTML = `
                    <div style="text-align: center; color: #7f8c8d; padding: 40px;">
                        <h4>üì≠ No keys found</h4>
                        <p>Generate some keys to get started.</p>
                    </div>
                `;
                return;
            }

            const sortedKeys = Object.entries(allKeys).sort((a, b) => {
                const dateA = new Date(a[1].created || '2025-01-01');
                const dateB = new Date(b[1].created || '2025-01-01');
                return dateB - dateA;
            });

            keyListDiv.innerHTML = sortedKeys.map(([keyCode, keyData]) => {
                const isExpired = new Date() > new Date(keyData.expiry);
                const isActive = keyData.active;
                
                let statusClass = '';
                let statusIcon = '';
                let statusText = '';
                
                if (isExpired) {
                    statusClass = 'expired';
                    statusIcon = 'üî¥';
                    statusText = 'EXPIRED';
                } else if (!isActive) {
                    statusClass = 'inactive';
                    statusIcon = 'üü°';
                    statusText = 'INACTIVE';
                } else {
                    statusIcon = 'üü¢';
                    statusText = 'ACTIVE';
                }
                
                const lastUsed = keyData.last_used ? 
                    new Date(keyData.last_used).toLocaleDateString() : 'Never';
                
                return `
                    <div class="key-item ${statusClass}">
                        <div style="margin-right: 250px;">
                            <strong>üë§ ${keyData.name}</strong> 
                            <span style="background: #ecf0f1; padding: 2px 8px; border-radius: 3px; font-size: 11px; margin-left: 10px;">
                                ${keyData.type || 'STANDARD'}
                            </span><br>
                            <small><strong>üîë Key:</strong> <code>${keyCode}</code></small><br>
                            <small><strong>‚è∞ Expires:</strong> ${keyData.expiry} | <strong>üìÖ Created:</strong> ${keyData.created || 'Unknown'}</small><br>
                            <small><strong>üìä Status:</strong> ${statusIcon} ${statusText} | <strong>üì• Downloads:</strong> ${keyData.download_count || 0} | <strong>üïí Last Used:</strong> ${lastUsed}</small>
                        </div>
                        
                        <button onclick="copyKeyFromList('${keyCode}')" class="copy-btn btn-copy">
                            üìã Copy
                        </button>
                        <button onclick="toggleKeyStatus('${keyCode}')" class="toggle-btn btn-warning">
                            ${isActive ? 'üîí Deactivate' : 'üîì Activate'}
                        </button>
                        <button onclick="deleteKey('${keyCode}')" class="delete-btn btn-danger">
                            üóëÔ∏è Delete
                        </button>
                    </div>
                `;
            }).join('');
        }

        function copyKeyFromList(keyCode) {
            navigator.clipboard.writeText(keyCode).then(() => {
                alert(`üìã Key ${keyCode} copied to clipboard!`);
                logActivity('key_copied', `Key ${keyCode} copied to clipboard`);
            }).catch(() => {
                const textArea = document.createElement('textarea');
                textArea.value = keyCode;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                alert(`üìã Key ${keyCode} copied to clipboard!`);
                logActivity('key_copied', `Key ${keyCode} copied to clipboard`);
            });
        }

        function toggleKeyStatus(keyCode) {
            const localKeys = JSON.parse(localStorage.getItem('lms_ai_local_keys') || '{}');
            if (localKeys[keyCode]) {
                localKeys[keyCode].active = !localKeys[keyCode].active;
                localStorage.setItem('lms_ai_local_keys', JSON.stringify(localKeys));
                
                if (keysDatabase[keyCode]) {
                    keysDatabase[keyCode].active = localKeys[keyCode].active;
                }
                
                refreshKeyList();
                updateStatistics();
                
                const status = localKeys[keyCode].active ? 'activated' : 'deactivated';
                alert(`‚úÖ Key ${keyCode} has been ${status}`);
                logActivity('key_status_changed', `Key ${keyCode} ${status}`);
            }
        }

        function deleteKey(keyCode) {
            if (!confirm(`‚ö†Ô∏è Are you sure you want to delete key ${keyCode}?\n\nThis action cannot be undone.`)) {
                return;
            }

            const localKeys = JSON.parse(localStorage.getItem('lms_ai_local_keys') || '{}');
            delete localKeys[keyCode];
            localStorage.setItem('lms_ai_local_keys', JSON.stringify(localKeys));
            
            delete keysDatabase[keyCode];
            
            refreshKeyList();
            updateStatistics();
            alert(`‚úÖ Key ${keyCode} has been deleted permanently`);
            logActivity('key_deleted', `Key ${keyCode} deleted permanently`);
        }

        async function loadFromDatabase() {
            // This function could connect to real database in the future
            refreshKeyList();
            updateStatistics();
            logActivity('database_sync', 'Keys loaded from local storage');
        }

        function exportDatabase() {
            const localKeys = JSON.parse(localStorage.getItem('lms_ai_local_keys') || '{}');
            const allKeys = { ...keysDatabase, ...localKeys };
            
            const exportData = {
                keys: allKeys,
                exported_at: new Date().toISOString(),
                version: "2.0.0",
                total_keys: Object.keys(allKeys).length
            };
            
            const jsonString = JSON.stringify(exportData, null, 2);
            document.getElementById('exportData').value = jsonString;
            showImportSection();
            
            logActivity('database_exported', `Exported ${Object.keys(allKeys).length} keys`);
        }

        function showImportSection() {
            document.getElementById('importSection').classList.remove('hidden');
            if (!document.getElementById('exportData').value) {
                exportDatabase();
            }
        }

        function hideImportSection() {
            document.getElementById('importSection').classList.add('hidden');
        }

        function copyToClipboard() {
            const exportData = document.getElementById('exportData');
            exportData.select();
            navigator.clipboard.writeText(exportData.value).then(() => {
                alert('‚úÖ Database JSON copied to clipboard!\n\nYou can save this as a backup file.');
            }).catch(() => {
                document.execCommand('copy');
                alert('‚úÖ Database JSON copied to clipboard!');
            });
        }

        function downloadDatabase() {
            const content = document.getElementById('exportData').value;
            const blob = new Blob([content], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `lms-ai-database-backup-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            alert('‚úÖ Database backup downloaded!\n\nKeep this file safe for restore purposes.');
            logActivity('database_downloaded', 'Database backup file downloaded');
        }

        function restoreFromJson() {
            const jsonContent = document.getElementById('exportData').value.trim();
            
            if (!jsonContent) {
                alert('‚ùå Please paste JSON content first!');
                return;
            }
            
            if (!confirm('‚ö†Ô∏è This will overwrite your current database!\n\nAre you sure you want to restore from this backup?')) {
                return;
            }
            
            try {
                const data = JSON.parse(jsonContent);
                
                if (data.keys && typeof data.keys === 'object') {
                    keysDatabase = data.keys;
                    localStorage.setItem('lms_ai_local_keys', JSON.stringify(data.keys));
                    
                    refreshKeyList();
                    updateStatistics();
                    
                    alert(`‚úÖ Database restored successfully!\n\nRestored ${Object.keys(data.keys).length} keys.`);
                    logActivity('database_restored', `Restored ${Object.keys(data.keys).length} keys from backup`);
                    
                    hideImportSection();
                } else {
                    throw new Error('Invalid backup format');
                }
                
            } catch (error) {
                alert(`‚ùå Restore failed!\n\nError: ${error.message}\n\nPlease check the JSON format.`);
                logActivity('database_restore_failed', `Restore failed: ${error.message}`);
            }
        }

        // ===== BULK KEY GENERATION =====
        function generateBulkKeys() {
            const count = parseInt(document.getElementById('bulkCount').value);
            const prefix = document.getElementById('bulkPrefix').value.trim();
            const duration = parseInt(document.getElementById('bulkDuration').value);
            const keyType = document.getElementById('bulkType').value;
            const startNumber = parseInt(document.getElementById('bulkStartNumber').value);
            const padding = parseInt(document.getElementById('bulkPadding').value);
            
            if (!count || count < 1 || count > 1000) {
                alert('‚ùå Please enter a valid number of keys (1-1000)');
                return;
            }
            
            if (!prefix) {
                alert('‚ùå Please enter a name prefix');
                return;
            }
            
            if (confirm(`üì¶ Generate ${count} keys?\n\nPrefix: ${prefix}\nType: ${keyType}\nThis will take a moment...`)) {
                bulkGeneratedKeys = [];
                const bulkList = document.getElementById('bulkKeysList');
                bulkList.innerHTML = '<div style="text-align: center; padding: 20px;">‚è≥ Generating keys...</div>';
                bulkList.classList.remove('hidden');
                
                setTimeout(() => {
                    for (let i = 0; i < count; i++) {
                        const number = startNumber + i;
                        const paddedNumber = number.toString().padStart(padding, '0');
                        const userName = `${prefix}${paddedNumber}`;
                        
                        const namePrefix = userName.toUpperCase().replace(/[^A-Z]/g, '').substring(0, 4).padEnd(4, 'X');
                        const year = new Date().getFullYear();
                        const random = Math.random().toString(36).substring(2, 8).toUpperCase();
                        const keyCode = `${namePrefix}-${year}-${random}`;
                        
                        let expiryDate;
                        if (duration === 0) {
                            expiryDate = "2099-12-31";
                        } else {
                            const expiry = new Date();
                            expiry.setMonth(expiry.getMonth() + duration);
                            expiryDate = expiry.toISOString().split('T')[0];
                        }
                        
                        const encryptionKey = `${userName.toLowerCase().replace(/\s+/g, '-')}-secret-key-${year}`;
                        
                        const keyData = {
                            keyCode: keyCode,
                            userName: userName,
                            expiryDate: expiryDate,
                            encryptionKey: encryptionKey,
                            keyType: keyType,
                            createdAt: new Date().toISOString(),
                            active: true,
                            bulk: true
                        };
                        
                        bulkGeneratedKeys.push(keyData);
                        
                        keysDatabase[keyCode] = {
                            name: userName,
                            expiry: expiryDate,
                            active: true,
                            encryptionKey: encryptionKey,
                            type: keyType,
                            created: new Date().toISOString().split('T')[0],
                            download_count: 0,
                            bulk: true
                        };
                    }
                    
                    const localKeys = JSON.parse(localStorage.getItem('lms_ai_local_keys') || '{}');
                    bulkGeneratedKeys.forEach(key => {
                        localKeys[key.keyCode] = {
                            name: key.userName,
                            expiry: key.expiryDate,
                            active: key.active,
                            encryptionKey: key.encryptionKey,
                            type: key.keyType,
                            created: key.createdAt.split('T')[0],
                            download_count: 0,
                            bulk: true
                        };
                    });
                    localStorage.setItem('lms_ai_local_keys', JSON.stringify(localKeys));
                    
                    displayBulkKeys();
                    document.getElementById('exportBulkBtn').disabled = false;
                    
                    refreshKeyList();
                    updateStatistics();
                    
                    alert(`‚úÖ Generated ${count} bulk keys successfully!`);
                    logActivity('bulk_keys_generated', `Generated ${count} ${keyType} keys with prefix ${prefix}`);
                    
                    // Send email notification
                    sendEmailNotification('Bulk Keys Generated', {
                        count: count,
                        prefix: prefix,
                        keyType: keyType
                    });
                    
                }, 500);
            }
        }

        function displayBulkKeys() {
            const bulkList = document.getElementById('bulkKeysList');
            
            if (bulkGeneratedKeys.length === 0) {
                bulkList.classList.add('hidden');
                return;
            }
            
            bulkList.innerHTML = `
                <div style="text-align: center; margin-bottom: 15px;">
                    <strong>üì¶ ${bulkGeneratedKeys.length} Bulk Keys Generated</strong>
                </div>
                ${bulkGeneratedKeys.map((key, index) => `
                    <div class="key-item" style="font-size: 12px;">
                        <strong>${key.userName}</strong><br>
                        <small><strong>Key:</strong> <code>${key.keyCode}</code></small><br>
                        <small><strong>Expires:</strong> ${key.expiryDate} | <strong>Type:</strong> ${key.keyType}</small>
                        <button onclick="copyKeyFromList('${key.keyCode}')" class="btn-copy" style="position: absolute; top: 10px; right: 10px; padding: 3px 8px; font-size: 10px;">üìã</button>
                    </div>
                `).join('')}
            `;
            
            bulkList.classList.remove('hidden');
        }

        function exportBulkKeys() {
            if (bulkGeneratedKeys.length === 0) {
                alert('‚ùå No bulk keys to export. Generate some keys first.');
                return;
            }
            
            const headers = ['Username', 'Key Code', 'Expiry Date', 'Key Type', 'Encryption Key', 'Created Date'];
            const csvContent = [
                headers.join(','),
                ...bulkGeneratedKeys.map(key => [
                    key.userName,
                    key.keyCode,
                    key.expiryDate,
                    key.keyType,
                    key.encryptionKey,
                    key.createdAt.split('T')[0]
                ].join(','))
            ].join('\n');
            
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `bulk-keys-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            URL.revokeObjectURL(url);
            
            alert(`‚úÖ Exported ${bulkGeneratedKeys.length} keys to CSV file!`);
            logActivity('bulk_keys_exported', `Exported ${bulkGeneratedKeys.length} keys to CSV`);
        }

        function clearBulkKeys() {
            if (bulkGeneratedKeys.length === 0) {
                alert('‚ùå No bulk keys to clear.');
                return;
            }
            
            if (confirm(`üóëÔ∏è Clear ${bulkGeneratedKeys.length} bulk keys?\n\nThis will only clear the bulk view, not delete the keys from database.`)) {
                bulkGeneratedKeys = [];
                document.getElementById('bulkKeysList').classList.add('hidden');
                document.getElementById('exportBulkBtn').disabled = true;
                
                alert('‚úÖ Bulk keys view cleared!');
            }
        }

        // ===== STATISTICS =====
        function updateStatistics() {
            const localKeys = JSON.parse(localStorage.getItem('lms_ai_local_keys') || '{}');
            const allKeys = { ...keysDatabase, ...localKeys };
            const keys = Object.values(allKeys);
            const now = new Date();
            
            const totalKeys = keys.length;
            const activeKeys = keys.filter(k => k.active && new Date(k.expiry) > now).length;
            const expiredKeys = keys.filter(k => new Date(k.expiry) <= now).length;
            const totalDownloads = keys.reduce((sum, k) => sum + (k.download_count || 0), 0);
            
            document.getElementById('totalKeys').textContent = totalKeys;
            document.getElementById('activeKeys').textContent = activeKeys;
            document.getElementById('expiredKeys').textContent = expiredKeys;
            document.getElementById('totalDownloads').textContent = totalDownloads;
        }

        function calculateTodayStats() {
            const today = new Date().toISOString().split('T')[0];
            const todayActivities = activityLog.filter(log => 
                log.timestamp.split('T')[0] === today
            );
            
            const keysGenerated = todayActivities.filter(log => 
                log.type.includes('key_generated') || log.type.includes('bulk_keys_generated')
            ).length;
            
            const keysValidated = todayActivities.filter(log => 
                log.type.includes('validation')
            ).length;
            
            const downloads = todayActivities.filter(log => 
                log.type.includes('download')
            ).length;
            
            const logins = todayActivities.filter(log => 
                log.type.includes('admin_login') && !log.type.includes('failed')
            ).length;
            
            document.getElementById('todayKeysGenerated').textContent = keysGenerated;
            document.getElementById('todayKeysValidated').textContent = keysValidated;
            document.getElementById('todayDownloads').textContent = downloads;
            document.getElementById('todayLogins').textContent = logins;
        }

        function calculateSystemInfo() {
            const localKeys = JSON.parse(localStorage.getItem('lms_ai_local_keys') || '{}');
            const systemSettings = JSON.parse(localStorage.getItem('lms_ai_system_settings') || '{}');
            const activityLog = JSON.parse(localStorage.getItem('lms_ai_activity_log') || '[]');
            
            const totalSize = JSON.stringify(localKeys).length + 
                            JSON.stringify(systemSettings).length + 
                            JSON.stringify(activityLog).length;
            
            const sizeInKB = (totalSize / 1024).toFixed(2);
            
            document.getElementById('databaseSize').textContent = `${sizeInKB} KB`;
            document.getElementById('environmentInfo').textContent = 
                window.location.hostname === 'localhost' ? 'Development' : 'Production';
        }

        // ===== ACTIVITY LOG =====
        function refreshActivityLog() {
            const stored = localStorage.getItem('lms_ai_activity_log');
            if (stored) {
                activityLog = JSON.parse(stored);
            }
            filterActivityLog();
        }

        function filterActivityLog() {
            const filter = document.getElementById('logFilter').value;
            const logDiv = document.getElementById('activityLog');
            
            let filteredLog = activityLog;
            if (filter !== 'all') {
                filteredLog = activityLog.filter(entry => entry.type.includes(filter));
            }
            
            if (filteredLog.length === 0) {
                logDiv.innerHTML = '<div style="text-align: center; color: #7f8c8d; padding: 20px;"><p>üìä No activities found.</p></div>';
                return;
            }
            
            logDiv.innerHTML = filteredLog.slice(0, 20).map(entry => `
                <div class="key-item" style="font-size: 12px; border-left-color: ${getLogColor(entry.type)};">
                    <strong>${entry.type.toUpperCase().replace(/_/g, ' ')}</strong><br>
                    <small>${new Date(entry.timestamp).toLocaleString()}</small><br>
                    ${entry.message}
                </div>
            `).join('');
        }

        function getLogColor(type) {
            if (type.includes('error') || type.includes('failed')) return '#e74c3c';
            if (type.includes('success') || type.includes('generated') || type.includes('saved')) return '#27ae60';
            if (type.includes('login') || type.includes('admin')) return '#3498db';
            return '#95a5a6';
        }

        function clearActivityLog() {
            if (confirm('üóëÔ∏è Are you sure you want to clear the activity log?')) {
                activityLog = [];
                localStorage.removeItem('lms_ai_activity_log');
                refreshActivityLog();
                logActivity('log_cleared', 'Activity log cleared by administrator');
            }
        }

        async function testDatabaseConnection() {
            const statusText = document.getElementById('dbStatusText');
            const spinner = document.getElementById('dbSpinner');
            
            statusText.textContent = 'Testing connection...';
            spinner.style.display = 'inline-block';
            
            try {
                const response = await fetch(`${API_BASE}/test`);
                
                if (response.ok) {
                    const data = await response.json();
                    isDatabaseConnected = true;
                    statusText.textContent = `‚úÖ Functions connected - ${data.message}`;
                    statusText.style.color = '#27ae60';
                    logActivity('database_test', 'Database connection successful');
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                isDatabaseConnected = false;
                statusText.textContent = `‚ùå Functions unavailable - Using localStorage only`;
                statusText.style.color = '#e74c3c';
                logActivity('database_test_failed', `Database connection failed: ${error.message}`);
            } finally {
                spinner.style.display = 'none';
            }
        }

        // ===== INITIALIZATION =====
        function initializeAdmin() {
            loadSystemSettings();
            refreshActivityLog();
            refreshKeyList();
            updateStatistics();
            calculateTodayStats();
            calculateSystemInfo();
            testDatabaseConnection();
            
            console.log('Admin panel initialized successfully');
            logActivity('admin_initialized', 'Admin panel loaded and initialized');
        }

       // ===== EVENT LISTENERS =====
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('loginPassword').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    attemptLogin();
                }
            });
            
            // Auto-refresh statistics every 30 seconds
            setInterval(() => {
                updateStatistics();
                calculateTodayStats();
            }, 30000);
            
            // Initialize EmailJS if configured
            loadSystemSettings();
        });

// ===== EMAILJS CONFIGURATION =====
        let emailJSInitialized = false;

        function initializeEmailJS() {
            if (systemSettings.emailService === 'emailjs' && systemSettings.emailjsPublicKey) {
                try {
                    emailjs.init(systemSettings.emailjsPublicKey);
                    emailJSInitialized = true;
                    console.log('EmailJS initialized successfully');
                    logActivity('emailjs_initialized', 'EmailJS service initialized');
                } catch (error) {
                    console.error('EmailJS initialization failed:', error);
                    emailJSInitialized = false;
                    logActivity('emailjs_failed', `EmailJS initialization failed: ${error.message}`);
                }
            }
        }

        // ===== EMAIL NOTIFICATION FUNCTIONS =====
        async function sendEmailNotification(type, data) {
            if (systemSettings.emailService === 'disabled') {
                console.log('Email notifications disabled');
                return;
            }
            
            try {
                if (systemSettings.emailService === 'netlify') {
                    await sendNetlifyFormEmail(type, data);
                } else if (systemSettings.emailService === 'emailjs') {
                    await sendEmailJSNotification(type, data);
                }
                
                console.log('Email notification sent:', type);
                logActivity('email_sent', `${type} notification sent successfully`);
            } catch (error) {
                console.error('Email send failed:', error);
                logActivity('email_failed', `Failed to send ${type}: ${error.message}`);
                
                // Show user-friendly error
                if (type === 'Test Email') {
                    alert(`‚ùå Email test failed:\n${error.message}\n\nPlease check your EmailJS configuration.`);
                }
            }
        }

        async function sendNetlifyFormEmail(type, data) {
            const formData = new FormData();
            formData.append('form-name', 'contact');
            formData.append('name', 'LMS AI System');
            formData.append('email', systemSettings.notificationEmail);
            formData.append('subject', `LMS AI - ${type}`);
            formData.append('message', formatEmailMessage(type, data));
            formData.append('timestamp', new Date().toISOString());

            const response = await fetch('/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: new URLSearchParams(formData)
            });

            if (!response.ok) {
                throw new Error(`Netlify form submission failed: ${response.status}`);
            }
        }

        async function sendEmailJSNotification(type, data) {
            if (!emailJSInitialized) {
                initializeEmailJS();
            }
            
            if (!systemSettings.emailjsPublicKey || !systemSettings.emailjsServiceId || !systemSettings.emailjsTemplateId) {
                throw new Error('EmailJS configuration incomplete. Please check Service ID, Template ID, and Public Key.');
            }

            const templateParams = {
                to_email: systemSettings.notificationEmail,
                subject: `LMS AI - ${type}`,
                message: formatEmailMessage(type, data),
                timestamp: new Date().toLocaleString(),
                keyCode: data.keyCode || '',
                userName: data.userName || '',
                keyType: data.keyType || '',
                count: data.count || ''
            };

            console.log('Sending EmailJS with params:', templateParams);

            const result = await emailjs.send(
                systemSettings.emailjsServiceId,
                systemSettings.emailjsTemplateId,
                templateParams
            );

            console.log('EmailJS result:', result);
            return result;
        }

        function formatEmailMessage(type, data) {
            const timestamp = new Date().toLocaleString();
            
            switch (type) {
                case 'Key Validation':
                    return `üîë Key ${data.keyCode} was successfully validated by user "${data.userName}" at ${timestamp}.\n\nKey Type: ${data.keyType || 'STANDARD'}\nStatus: Valid and Active`;
                    
                case 'Key Generated':
                    return `‚úÖ New license key generated successfully!\n\nKey Code: ${data.keyCode}\nUser Name: ${data.userName}\nKey Type: ${data.keyType}\nCreated: ${timestamp}`;
                    
                case 'Bulk Keys Generated':
                    return `üì¶ Bulk key generation completed!\n\nCount: ${data.count} keys\nPrefix: ${data.prefix}\nKey Type: ${data.keyType}\nGenerated: ${timestamp}`;
                    
                case 'Script Download':
                    return `üì• User downloaded personalized script!\n\nUser: ${data.userName}\nKey: ${data.keyCode}\nDownload Time: ${timestamp}`;
                    
                case 'Key Status Changed':
                    return `üîÑ Key status updated!\n\nKey: ${data.keyCode}\nUser: ${data.userName}\nNew Status: ${data.status}\nChanged: ${timestamp}`;
                    
                case 'Key Deleted':
                    return `üóëÔ∏è Key permanently deleted!\n\nKey: ${data.keyCode}\nUser: ${data.userName}\nDeleted: ${timestamp}`;
                    
                case 'Admin Login':
                    return `üîê Administrator logged into admin panel at ${timestamp}.\n\nSession started successfully.`;
                    
                case 'Test Email':
                    return data.message || `‚úÖ EmailJS test successful!\n\nThis is a test notification from your LMS AI Assistant admin panel.\n\nSent: ${timestamp}\n\nIf you received this email, your notification system is working correctly!`;
                    
                default:
                    return `üì¨ LMS AI System Activity: ${type}\n\nTimestamp: ${timestamp}\n\nDetails: ${JSON.stringify(data, null, 2)}`;
            }
        }

        // ===== EMAIL SETTINGS FUNCTIONS =====
        function saveEmailSettings() {
            // Get values from form
            systemSettings.notificationEmail = document.getElementById('notificationEmail').value.trim();
            systemSettings.emailService = document.getElementById('emailService').value;
            systemSettings.emailjsPublicKey = document.getElementById('emailjsPublicKey').value.trim();
            systemSettings.emailjsServiceId = document.getElementById('emailjsServiceId').value.trim();
            systemSettings.emailjsTemplateId = document.getElementById('emailjsTemplateId').value.trim();
            
            // Validate settings
            if (systemSettings.emailService === 'emailjs') {
                if (!systemSettings.emailjsPublicKey) {
                    alert('‚ùå Please enter EmailJS Public Key');
                    return;
                }
                if (!systemSettings.emailjsServiceId) {
                    alert('‚ùå Please enter EmailJS Service ID');
                    return;
                }
                if (!systemSettings.emailjsTemplateId) {
                    alert('‚ùå Please enter EmailJS Template ID');
                    return;
                }
            }
            
            if (systemSettings.emailService !== 'disabled' && !systemSettings.notificationEmail) {
                alert('‚ùå Please enter notification email address');
                return;
            }
            
            // Save settings
            saveSystemSettings();
            
            // Initialize EmailJS if configured
            if (systemSettings.emailService === 'emailjs') {
                initializeEmailJS();
            }
            
            alert('‚úÖ Email settings saved successfully!');
            logActivity('email_settings_updated', `Email service: ${systemSettings.emailService}, Email: ${systemSettings.notificationEmail}`);
        }

        async function sendTestEmail() {
            const testEmail = document.getElementById('testEmailAddress').value.trim();
            const testSubject = document.getElementById('testEmailSubject').value.trim();
            const testMessage = document.getElementById('testEmailMessage').value.trim();
            
            if (!testEmail) {
                alert('‚ùå Please enter a test email address');
                return;
            }
            
            if (systemSettings.emailService === 'disabled') {
                alert('‚ùå Email service is disabled. Please configure email settings first.');
                return;
            }
            
            if (systemSettings.emailService === 'emailjs' && !emailJSInitialized) {
                alert('‚ùå EmailJS not initialized. Please check your configuration and save settings first.');
                return;
            }
            
            // Show loading state
            const testBtn = event.target;
            const originalText = testBtn.textContent;
            testBtn.disabled = true;
            testBtn.textContent = 'üìß Sending...';
            
            try {
                // Temporarily use test email
                const originalEmail = systemSettings.notificationEmail;
                systemSettings.notificationEmail = testEmail;
                
                await sendEmailNotification('Test Email', {
                    message: testMessage,
                    subject: testSubject,
                    testEmail: testEmail
                });
                
                // Restore original email
                systemSettings.notificationEmail = originalEmail;
                
                alert('‚úÖ Test email sent successfully!\n\nCheck your inbox (and spam folder).');
                logActivity('test_email_sent', `Test email sent to ${testEmail}`);
                
            } catch (error) {
                console.error('Test email error:', error);
                alert(`‚ùå Failed to send test email:\n\n${error.message}\n\nPlease check your configuration.`);
                logActivity('test_email_failed', `Test email failed: ${error.message}`);
            } finally {
                // Restore button
                testBtn.disabled = false;
                testBtn.textContent = originalText;
            }
        }

        // ===== AUTO-TRIGGER EMAIL NOTIFICATIONS =====
        
        // Modify existing functions to send notifications
        const originalGenerateNewKey = generateNewKey;
        generateNewKey = function() {
            originalGenerateNewKey();
            
            if (currentGeneratedKey) {
                // Send notification after key generation
                setTimeout(() => {
                    sendEmailNotification('Key Generated', {
                        keyCode: currentGeneratedKey.keyCode,
                        userName: currentGeneratedKey.userName,
                        keyType: currentGeneratedKey.keyType
                    });
                }, 1000);
            }
        };

        const originalGenerateBulkKeys = generateBulkKeys;
        generateBulkKeys = function() {
            const count = parseInt(document.getElementById('bulkCount').value);
            const prefix = document.getElementById('bulkPrefix').value.trim();
            const keyType = document.getElementById('bulkType').value;
            
            originalGenerateBulkKeys();
            
            // Send notification after bulk generation
            setTimeout(() => {
                if (bulkGeneratedKeys.length > 0) {
                    sendEmailNotification('Bulk Keys Generated', {
                        count: count,
                        prefix: prefix,
                        keyType: keyType
                    });
                }
            }, 2000);
        };

        const originalAttemptLogin = attemptLogin;
        attemptLogin = function() {
            const password = document.getElementById('loginPassword').value;
            const currentPassword = getCurrentAdminPassword();
            
            if (password === currentPassword) {
                // Send login notification
                sendEmailNotification('Admin Login', {
                    timestamp: new Date().toISOString(),
                    ip: 'Hidden for security'
                });
            }
            
            originalAttemptLogin();
        };

        function getCurrentAdminPassword() {
            const stored = localStorage.getItem('lms_ai_system_settings');
            let currentPassword = 'admin2025';
            
            if (stored) {
                try {
                    const settings = JSON.parse(stored);
                    currentPassword = settings.adminPassword || 'admin2025';
                } catch (e) {
                    console.warn('Could not load settings');
                }
            }
            
            return currentPassword;
        }

        // Auto-save settings when changed
        function autoSaveSettings() {
            saveSystemSettings();
            initializeEmailJS();
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            // Ctrl+G to generate new key
            if (e.ctrlKey && e.key === 'g') {
                e.preventDefault();
                if (document.getElementById('adminContainer').style.display !== 'none') {
                    document.getElementById('userName').focus();
                }
            }
            
            // Ctrl+S to save current key
            if (e.ctrlKey && e.key === 's') {
                e.preventDefault();
                if (currentGeneratedKey && !document.getElementById('saveBtn').disabled) {
                    saveKeyToDatabase();
                }
            }
            
            // Escape to clear forms
            if (e.key === 'Escape') {
                if (document.getElementById('generatedKeyDisplay') && !document.getElementById('generatedKeyDisplay').classList.contains('hidden')) {
                    clearKeyForm();
                }
                if (document.getElementById('importSection') && !document.getElementById('importSection').classList.contains('hidden')) {
                    hideImportSection();
                }
            }
        });

        // Auto-cleanup old activity logs (keep last 100)
        function cleanupActivityLogs() {
            if (activityLog.length > 100) {
                activityLog = activityLog.slice(0, 100);
                localStorage.setItem('lms_ai_activity_log', JSON.stringify(activityLog));
            }
        }

        // Run cleanup every hour
        setInterval(cleanupActivityLogs, 3600000);

        // Warn before page unload if there's unsaved data
        window.addEventListener('beforeunload', function(e) {
            if (currentGeneratedKey && document.getElementById('saveBtn') && !document.getElementById('saveBtn').disabled) {
                e.preventDefault();
                e.returnValue = 'You have an unsaved generated key. Are you sure you want to leave?';
            }
        });

        // Initialize on load
        console.log('LMS AI Admin Panel v2.0.0 loaded successfully!');
        console.log('Features: Key Management, Bulk Generation, Email Notifications, Analytics');
        console.log('Keyboard shortcuts: Ctrl+G (Generate), Ctrl+S (Save), Esc (Clear)');
    </script>
</body>
</html>
